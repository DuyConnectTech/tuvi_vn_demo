const DOMAIN = "https://tuvi.vn/api/v1"
    , WebsocketUrl = "wss://tuvi.vn/api/v1/ws"
    , APIs = {
        users: {
            update: `${DOMAIN}/users`,
            updateAvatar: `${DOMAIN}/users/avatar`,
            changePassword: `${DOMAIN}/users/change-password`,
            savedList: `${DOMAIN}/users/saved-list`
        },
        auth: {
            resendToken: `${DOMAIN}/auth/resent-token`,
            changePassword: `${DOMAIN}/auth/change-password`,
            forgotPassword: `${DOMAIN}/auth/forgot-password`,
            changeForgotPassword: `${DOMAIN}/auth/reset-forgotten-password`
        },
        categories: {
            get: `${DOMAIN}/categories`
        },
        laSo: {
            luuNien: `${DOMAIN}/la-so/sao-luu-nien`,
            get: `${DOMAIN}/la-so`,
            luanGiai: `${DOMAIN}/luan-giai2`
        },
        others: {
            lichVanNien: `${DOMAIN}/lich-van-nien`,
            canXuong: `${DOMAIN}/can-xuong`,
            systemReport: `${DOMAIN}/system-report`,
            masterContact: `${DOMAIN}/master/contact`
        },
        payments: {
            requestPayment: `${DOMAIN}/payments/request`,
            hubCard: `${DOMAIN}/payments/hub-card/request`,
            banking: `${DOMAIN}/banking`,
            request: `${DOMAIN}/master/payment`
        },
        ranking: {
            get: `${DOMAIN}/users/ranking`
        },
        markets: {
            top: `${DOMAIN}/markets/top`,
            topics: `${DOMAIN}/markets/topics`,
            masterTopics: `${DOMAIN}/markets/master/topics`,
            comment: `${DOMAIN}/markets/comments`,
            commentMaster: `${DOMAIN}/markets/comments/master`,
            private: `${DOMAIN}/markets/comments/private`,
            report: `${DOMAIN}/markets/comments/report`,
            like: `${DOMAIN}/markets/comments/like`,
            unLike: `${DOMAIN}/markets/comments/unlike`,
            unLock: `${DOMAIN}/markets/comments/unlocks`
        },
        notifications: {
            get: `${DOMAIN}/users/notifications`
        },
        moderators: {
            deleteComment: `${DOMAIN}/markets/comments/delete`,
            deleteTopic: `${DOMAIN}/markets/topics/delete`
        },
        master: {
            get: `${DOMAIN}/users/master`
        },
        media: {
            upload: `${DOMAIN}/medias/images/upload`
        },
        gift: {
            code: `${DOMAIN}/gift/code`
        },
        article: {
            get: `${DOMAIN}/article`
        },
        xinXam: {
            post: `${DOMAIN}/xin-xam/`
        }
    }
    , LIMIT = 6
    , Agents = {
        methods: {
            GET: "GET",
            POST: "POST",
            DELETE: "DELETE",
            PUT: "PUT"
        },
        headers: {
            "Content-Type": "application/json"
        },
        headersUpload: {},
        request: function (url, method, data, success, error) {
            const params = {
                url: url,
                type: method,
                timeout: 3e3,
                headers: this.headers,
                async: !0,
                cache: !1,
                dataType: "json",
                contentType: "application/json; charset=UTF-8",
                success: function (result) {
                    success && success(result)
                },
                error: function (err) {
                    error && error(err)
                }
            };
            return data && (params.data = JSON.stringify(data)),
                $.ajax(params)
        },
        upload: function (url, method, formData, done, error) {
            var settings = {
                url: url,
                method: method,
                timeout: 0,
                headers: this.headersUpload,
                processData: !1,
                contentType: "application/json; charset=UTF-8",
                mimeType: "multipart/form-data",
                contentType: !1,
                data: formData,
                success: function (result) {
                    if ($("#spinnerReportSystem").hide(),
                        done) {
                        var json = JSON.parse(result);
                        done(json)
                    }
                },
                error: function (err) {
                    error && error(err)
                }
            };
            $.ajax(settings)
        },
        get: function (url, success, error) {
            this.request(url, this.methods.GET, void 0, success, error)
        },
        post: function (url, data, success, error) {
            this.request(url, this.methods.POST, data, success, error)
        },
        put: function (url, data, success, error) {
            this.request(url, this.methods.PUT, data, success, error)
        },
        delete: function (url, data, success, error) {
            this.request(url, this.methods.DELETE, data, success, error)
        }
    }
    , EmailRegex = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
    , PasswordRegex = /^\S{6,30}$/
    , NameRegex = /^[a-zA-Z]+(([',. -][a-zA-Z ])?[a-zA-Z]*)*$/
    , UsernameRegex = /^[a-zA-Z_0-9]{3,60}$/
    , PhoneRegex = /(84|0[3|5|7|8|9])+([0-9]{8})\b/
    , AddressRegex = /^.{3,500}$/
    , IdCardRegex = /^([0-9]{9,13})$/
    , GOOGLE_CLIENT_ID = "1099497528626-k99ptin422coajg1hdcnub13nh4keh3k.apps.googleusercontent.com"
    , FACEBOOK_APP_ID = "1129945885488156"
    , commentDefaultTemplate = '<div class="d-flex m-b-10 ${item.is_sub}" id="comment-${item.id}" data-sub-id="${item.id_comment}"> <a href="/${item.user.username}"><img class="cmt-avt" src="${item.user.avatar}" alt=""></a> <div> <div class="d-flex align-items-center"> <div class="cmt-bubble"> <div class="change-flex-direction-500"> <div class="d-flex align-items-center"> <a href="/${item.user.username}"><div class="txt-content-bold m-r-5 line-clamp-1">${item.user.name}</div></a> <img src="/public/images/professor-verify.png" class="icon-professor-verify m-r-10 ${item.user.is_teacher}"/> </div> <div class="d-flex align-items-center"> <div class="user-medal-rank user-medal-rank-${item.user.rank.id} zoom-half mr-2"></div> <div class="txt-sub-content line-clamp-1 user-title-rank-${item.user.rank.id}"> ${item.user.rank.title} </div> </div> </div> <div class="txt-content m-t-5 text-break white-space-pl content-comment-topic" id="content-comment-topic" data-id="${item.id}" data-sub-id="${item.id_comment}"> {{html item.content_new}} </div> </div> </div> <div class="d-flex align-items-center mt-1"> <button class="btn txt-sub-content text-secondary hover-dark cmt-act-btn ${item.liked} btn-like-comment" data-id="${item.id}" data-sub-id="${item.id_comment}"> Thích </button> <div class="like-count txt-sub-content ${item.null_like}">${item.like_count}</div> <button class="btn txt-sub-content text-secondary hover-dark cmt-act-btn btn-rep-comment" id="btn-rep-comment" data-id="${item.id}" data-sub="${item.isSub}" data-sub-id="${item.id_comment}">Trả lời </button> <div class="txt-sub-content text-secondary p-l-10">${item.time}</div> <button class="btn cmt-option-btn hover-dark btn-more-action-comment rotation-90 m-l-15" type="button" data-toggle="dropdown"> <img class="cmt-option-icon" src="/public/images/cmt-option.png"> </button> <ul class="dropdown-menu view-list-action-comment text-center p-0 cursor-pointer" role="menu" aria-labelledby="menu1"> <li role="presentation" class="text-action-comment edit-comment txt-content ${item.owner_cmt}" data-toggle="modal" data-target="#editCommentModal" data-content="${item.content}" data-type="${item.type}" data-id="${item.id}" data-sub-id="${item.id_comment}">Sửa </li> <li role="presentation" data-id="${item.id}" data-sub-id="${item.id_comment}" data-toggle="modal" data-target="#checkDeleteCommentModal" class="text-action-comment delete-comment txt-content ${item.owner_delete}" data-type="${item.type}">Xóa </li> <li role="presentation" data-id="${item.id}" data-sub-id="${item.id_comment}" class="text-action-comment report-comment txt-content ${item.owner_report}" data-toggle="modal" data-target="#reportCommentModal">Báo cáo </li> <li role="presentation" data-id="${item.id}" data-sub-id="${item.id_comment}" class="text-action-comment txt-content ${item.is_mod} mode-hide-comment-topic" data-name="modHideComment" data-toggle="modal" data-target="#modalHideForMod">Ẩn bình luận</li> </ul> </div> </div> </div>'
    , MAX_LENGTH_TITLE_TOPIC = 500
    , LoadFunctions = {
        "/": initHomeScreen,
        "/thong-ke-can-xuong-doan-so": initThongKeCanXuongScreen,
        "/dong-gop-y-kien": initSystemReportScreen,
        "/login": initLoginScreen,
        "/register": initRegisterScreen,
        "/profile": initProfileScreen,
        "/forgot-password": initForgotPassword,
        "/cho-la-so": initChoLasoScreen,
        "/payment": initPayment,
        "/thu-vien-tu-vi": initThuVienTuViScreen,
        "/payment/callBack": initPaymentCallback,
        "/ho-tro-va-hoi-dap": initQAScreen,
        "/cho-la-so/top-la-so": initTopTopicScreen,
        "/chinh-sach-danh-cho-thay": initTeacherPolicyScreen,
        "/yeu-cau-thanh-toan": initPaymentRequestScreen,
        "/dang-la-so": initDangLaSoScreen
    };
function playAudio() {
    var x;
    document.getElementById("noti-bell").play()
}
function pauseAudio() {
    var x;
    document.getElementById("noti-bell").pause()
}
function loadTopTopicsDefault() {
    const containerEle = $("#containerTopTopic")
        , uri = "?pageSize=10&pageNumber=1";
    Agents.get(`${APIs.markets.topics}${uri}`, (function (res) {
        if (200 == res.code) {
            const data = res.data.data;
            data && data.forEach((item, index) => {
                item.budgetFormatted = formatPrice(item.budget_display);
                let canChi = item.laso.can_chi_tuoi;
                item.background = getAnimalClass(canChi.split(" ")[1]);
                let cucTuoi = item.laso.cuc_cua_tuoi;
                item.colorBackground = getColorNguHanhClass(cucTuoi.split(" ")[0]),
                    item.user.avatar || (item.user.avatar = "/public/images/avatars/avt-default.jpg"),
                    item.active = 0 == index ? "active" : "";
                const cardTopic = $("#cardTopTopic").tmpl(item);
                cardTopic.appendTo(containerEle)
            }
            ),
                $("#top-carousel").on("slide.bs.carousel", (function (e) {
                    var $e, idx = $(e.relatedTarget).index(), itemsPerSlide = 5, totalItems = $("#top-carousel .carousel-item").length;
                    if (idx >= totalItems - 4)
                        for (var it = 5 - (totalItems - idx), i = 0; i < it; i++)
                            "left" == e.direction ? $("#top-carousel .carousel-item").eq(i).appendTo(".carousel-inner") : $("#top-carousel .carousel-item").eq(0).appendTo(".carousel-inner")
                }
                ))
        } else {
            const container = $("#containerTop");
            container.addClass("d-none")
        }
    }
    )),
        $("#btnUpLaso").on("click", (function (event) {
            isLogged() ? window.location.replace("/dang-la-so") : openModalLogin(event, "/dang-la-so")
        }
        )),
        $("#btnPushTop").on("click", (function (event) {
            isLogged() ? window.location.replace("/profile?tab=3") : openModalLogin(event, "/profile?tab=3")
        }
        ))
}
function loadNotification(container, page) {
    $("#" + container).append('<div class="spinner-border" style="margin-left: 50%" role="status"><span class="sr-only">Loading...</span></div>'),
        Agents.get(APIs.notifications.get + "?limit=10&page=" + page, (function (res) {
            console.log(res);
            const data = res.data;
            if (data) {
                const notifications = data.data
                    , page = data.page
                    , hasNext = data.page_info.has_next_page;
                notifications ? (notifications.forEach((function (i) {
                    i.time = sinceTime(i.created);
                    const action = i.action;
                    action.actor && "" == action.actor.avatar && (action.actor.avatar = "/public/images/ic_default_avt.jpg"),
                        action.actionStr = convertActionToStr(action.action),
                        action.targetStr = getTargetName(action.target_module, action.target_object),
                        action.preTarget = getPreTarget(action.target_module),
                        i.href = getHref(action.target_module, action.target_object)
                }
                )),
                    $("#" + container).find(".spinner-border").remove(),
                    $("#uNotiTemplate").tmpl(notifications).appendTo("#" + container),
                    $("#" + container).attr("data-page", page),
                    $("#" + container).attr("data-has-next", hasNext)) : ($("#" + container).find(".spinner-border").remove(),
                        $("#" + container).append('<div class="text-center txt-content-mid m-t-10">Chưa có thông báo</div>'))
            }
        }
        ), (function (err) {
            $("#" + container).find(".spinner-border").remove()
        }
        ))
}
function convertActionToStr(type) {
    return "COMMENT" == type ? "đã trả lời" : "LIKE" == type ? "đã thích" : "UNLOCK" == type ? "đã mở khoá" : "TAG_MASTER" == type ? "đã mời thầy xem" : void 0
}
function getTargetName(type, target) {
    return "market_topic" == type ? target.title || "" : "market_topic_comment" == type ? target && target.topic ? target.topic.title : "" : void 0
}
function getPreTarget(type) {
    return "market_topic" == type ? "bài viết lá số" : "market_topic_comment" == type ? "bình luận trong lá số" : void 0
}
function getHref(type, target) {
    let parentId = ""
        , id = "";
    return target && (parentId = target.id || "",
        id = target.topic ? target.topic.slug || "" : target.slug || ""),
        "market_topic" == type ? "/" + id : "market_topic_comment" == type ? "/" + id + "?comment=" + parentId : void 0
}
function isMobile() {
    const isMobile = {
        Android: function () {
            return navigator.userAgent.match(/Android/i)
        },
        BlackBerry: function () {
            return navigator.userAgent.match(/BlackBerry/i)
        },
        iOS: function () {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i)
        },
        Opera: function () {
            return navigator.userAgent.match(/Opera Mini/i)
        },
        Windows: function () {
            return navigator.userAgent.match(/IEMobile/i)
        },
        any: function () {
            return isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Opera() || isMobile.Windows()
        }
    };
    return isMobileDevice = isMobile.any()
}
$("#open-sidebar-menu").on("click", (function () {
    $("#sidebar-menu").addClass("show-sidebar"),
        $("#sidebar-overlay").removeClass("d-none");
    const body = document.body;
    body.style.overflow = "hidden"
}
)),
    $("#close-sidebar-menu").on("click", (function () {
        $("#sidebar-menu").removeClass("show-sidebar"),
            $("#sidebar-overlay").addClass("d-none");
        const body = document.body;
        body.style.overflow = "auto"
    }
    )),
    $("#sidebar-overlay").on("click", (function () {
        $("#sidebar-menu").removeClass("show-sidebar"),
            $("#sidebar-overlay").addClass("d-none");
        const body = document.body;
        body.style.overflow = "auto"
    }
    )),
    $(".sidebar-dropdown").length > 0 && $(".sidebar-dropdown").click((function () {
        $(this).toggleClass("open-sidebar-dropdown"),
            $(this).next("ul").slideToggle(200)
    }
    )),
    $(window).scroll((function () {
        $(this).scrollTop() > 800 ? $(".bottom-scroll-top").fadeIn(260) : $(".bottom-scroll-top").fadeOut(260)
    }
    )),
    $(".bottom-scroll-top").click((function () {
        return $("html, body").animate({
            scrollTop: 0
        }, 180),
            !1
    }
    )),
    $((function () {
        const path = window.location.pathname;
        if (getToken(),
            isLaSoScreen(path))
            initLasoScreen(path);
        else if (path.startsWith("/xem-ngay-tot-xau"))
            initBadGoodDayScreen();
        else if (isTopicScreen(path))
            initLasoScreen(path),
                initDetailTopic(path);
        else if (path.startsWith("/payment/callback"))
            initPaymentCallback();
        else if (path.startsWith("/category/"))
            initThuVienTuViScreen();
        else if (path.startsWith("/gieo-que-xam-"))
            initXinXam();
        else {
            const fnc = LoadFunctions[path];
            fnc ? fnc() : initProfileGuestScreen()
        }
        function googleSignInSuccess(googleUser) {
            var profile = googleUser.getBasicProfile();
            console.log("Email: " + profile.getEmail()),
                console.log("Name: " + profile.getName()),
                console.log("Image URL: " + profile.getImageUrl());
            const access_token = googleUser.getAuthResponse().access_token
                , inputPrev = $('input[name="previous"]')
                , uri = inputPrev && "" !== inputPrev.val() ? inputPrev.val() : "/"
                , previous = encodeURIComponent(uri);
            access_token ? window.location.href = "/social-login?type=GOOGLE&previous=" + previous + "&token=" + access_token : openModalHaveError("Có lỗi xảy ra!", "Vui lòng thử lại")
        }
        $(".fb-save").attr("data-uri", window.location.href),
            $(".fb-share-button").attr("data-href", window.location.href),
            $("#btn-read-more").on("click", (function (e) {
                "none" === $("#dots").css("display") ? ($("#dots").css("display", "inline"),
                    $("#btn-read-more").text("xem thêm"),
                    $("#moreTxt").css("display", "none")) : ($("#dots").css("display", "none"),
                        $("#btn-read-more").text("Thu gọn"),
                        $("#moreTxt").css("display", "inline"))
            }
            )),
            $("#close-modal-la-so").click((function () {
                console.log("zo 2"),
                    $("#modal-la-so").css("display", "none"),
                    $("body").css("overflow", "");
                const containerLaSo = $("#table-la-so")
                    , containerTongQuan = $("#binh-giai-tong-quan")
                    , container12Cung = $("#binh-giai-12-cung")
                    , containerDaiVan = $("#binh-giai-dai-van")
                    , containerTieuVan = $("#binh-giai-tieu-van");
                $("#wide-left-content").append(containerTongQuan, container12Cung, containerDaiVan, containerTieuVan),
                    containerLaSo.removeAttr("style"),
                    $("#content-la-so").append(containerLaSo)
            }
            )),
            $("#yearOfDOB2").select2(),
            $("#tao-la-so-nam-xem").select2(),
            $("#viewYear").select2(),
            $("#viewYear3").select2(),
            $("button[name=toLogin]").on("click", (function () {
                const uri = window.location
                    , previous = encodeURIComponent(uri);
                window.location.href = "/login?previous=" + previous
            }
            )),
            $("button[name=toRegister]").on("click", (function () {
                window.location.href = "/register"
            }
            )),
            $("#btn-logout-sidebar").on("click", (function () {
                window.location.href = "/logout"
            }
            )),
            $("#btnSignInGoogle").on("click", (function (event) {
                auth2.signIn().then(googleSignInSuccess, (function (error) {
                    console.log("LOGIN GOOGLE ERROR: " + error),
                        openModalHaveError("Có lỗi xảy ra!", "Vui lòng thử lại")
                }
                ))
            }
            )),
            $("#btnSignInFB").on("click", (function () {
                FB.login((function (response) {
                    if (response.authResponse) {
                        console.log("Welcome!  Fetching your information.... ");
                        const access_token = response.authResponse.accessToken || null
                            , inputPrev = $('input[name="previous"]')
                            , uri = inputPrev && "" !== inputPrev.val() ? inputPrev.val() : "/"
                            , previous = encodeURIComponent(uri);
                        access_token ? window.location.href = "/social-login?type=FACEBOOK&previous=" + previous + "&token=" + access_token : openModalHaveError("Có lỗi xảy ra!", "Vui lòng thử lại")
                    } else
                        openModalHaveError("Có lỗi xảy ra!", "Vui lòng thử lại"),
                            console.log("User cancelled login or did not fully authorize.")
                }
                ), {
                    scope: "email,user_likes"
                })
            }
            )),
            $("#btn-show-noti-box").on("click", (function () {
                $("#noti-box").removeClass("hide-noti-box"),
                    $("#noti-box").addClass("show-noti-box");
                const container = $("#noti-web-count");
                container.empty(),
                    $(container.parent()).addClass("d-none"),
                    $(container.parent()).removeClass("d-flex")
            }
            )),
            $("#btn-hide-noti-box").on("click", (function () {
                $("#noti-box").removeClass("show-noti-box"),
                    $("#noti-box").addClass("hide-noti-box")
            }
            )),
            $("#btn-show-noti-box-mobile").on("click", (function () {
                $("#noti-box-mobile").removeClass("d-none"),
                    $("#noti-box-mobile").addClass("d-block"),
                    $("#btn-hide-noti-box-mobile").removeClass("d-none"),
                    $("#btn-hide-noti-box-mobile").addClass("d-block");
                const body = document.body;
                body.style.overflow = "hidden",
                    $("#noti-mobile-count").addClass("d-none"),
                    $("#noti-mobile-count").empty()
            }
            )),
            $("#btn-hide-noti-box-mobile").on("click", (function () {
                $("#noti-box-mobile").removeClass("d-block"),
                    $("#noti-box-mobile").addClass("d-none"),
                    $("#btn-hide-noti-box-mobile").removeClass("d-block"),
                    $("#btn-hide-noti-box-mobile").addClass("d-none");
                const body = document.body;
                body.style.overflow = "auto"
            }
            )),
            isLogged() && (isMobile() ? (loadNotification("user-noti-box-mobile", 1),
                $("#user-noti-box-mobile").on("scroll", (function () {
                    if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                        const page = $(this).attr("data-page")
                            , hasNext = $(this).attr("data-has-next");
                        if ("true" == hasNext) {
                            const newPage = parseInt(page) + 1;
                            loadNotification("user-noti-box-mobile", newPage)
                        }
                    }
                }
                ))) : (loadNotification("noti-box-web", 1),
                    $("#noti-box-web").on("scroll", (function () {
                        if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                            const page = $(this).attr("data-page")
                                , hasNext = $(this).attr("data-has-next");
                            if ("true" == hasNext) {
                                const newPage = parseInt(page) + 1;
                                loadNotification("noti-box-web", newPage)
                            }
                        }
                    }
                    )))),
            loadTopTopicsDefault(),
            $("#post-font-ajust").click((function () {
                $(".post-content").toggleClass("post-content-big")
            }
            )),
            $("#mainContactBtn").on("click", (function (e) {
                e.stopPropagation(),
                    $("#childButtons").toggleClass("active")
            }
            )),
            $(document).on("click", (function (event) {
                $(event.target).closest("#mainContactBtn").length || $(event.target).closest("#childButtons").length || $("#childButtons").removeClass("active")
            }
            )),
            $(".child-buttons .contact-btn").on("click", (function () {
                console.log("Contact button clicked:", $(this).data("tooltip"))
            }
            ))
    }
    )),
    $(window).on("load", (function () {
        var d, s, id, js, fjs;
        initWebsocket(),
            window.fbAsyncInit = function () {
                FB.init({
                    appId: FACEBOOK_APP_ID,
                    status: !0,
                    xfbml: !0,
                    version: "v9.0"
                })
            }
            ,
            d = document,
            s = "script",
            id = "facebook-jssdk",
            fjs = d.getElementsByTagName(s)[0],
            d.getElementById(id) || ((js = d.createElement(s)).id = id,
                js.src = "https://connect.facebook.net/en_US/sdk.js",
                fjs.parentNode.insertBefore(js, fjs)),
            $("div[data-name=btn-nap-xu]").click((function () {
                const uri = window.location.href
                    , previous = encodeURIComponent(uri);
                window.location.href = "/payment?previous=" + previous
            }
            ))
    }
    ));
const ResizeFunc = {
    "": resizeInHome,
    "/": resizeInHome,
    "/cho-la-so": resizeChoLaso
};
function initWebsocket() {
    const TypeNotifyView = 1
        , TypeNotify = 2
        , TypeModDelTopic = 3
        , TypeModDelComment = 4
        , TypeUserProfile = 5;
    if (window.WebSocket) {
        const conn = new WebSocket(WebsocketUrl);
        conn.onopen = function () { }
            ,
            conn.onclose = function (evt) {
                console.log("on close")
            }
            ,
            conn.onmessage = function (evt) {
                const response = evt.data;
                if (response) {
                    const json = JSON.parse(response)
                        , content = json.content;
                    if (content) {
                        var obj = JSON.parse(content);
                        console.log(obj);
                        const type = obj.type || 0;
                        switch (type) {
                            case 1:
                                handlerNotiUseFunction(obj.data);
                                break;
                            case 2:
                                handlerNoti(obj.data);
                                break;
                            case 3:
                                handlerNotiModDelTopic(obj.data);
                                break;
                            case 4:
                                handlerNotiModDelCmt(obj.data);
                                break;
                            case 5:
                                handlerUploadBalance(obj.data)
                        }
                    }
                }
            }
    } else
        console.log("browser not support wesocket")
}
var ringTimeOut;
function handlerNoti(data) {
    if (isMobile()) {
        notiItemHandler("user-noti-box-mobile", data);
        const countC = $("#noti-mobile-count")
            , value = countC.html().toString().trim() || "";
        var count = 1;
        console.log(value),
            value && (count = parseInt(value),
                count++),
            countC.html(count),
            countC.removeClass("d-none")
    } else {
        ringTimeOut || ($("img.user-noti-bell").css("animation", "ringbell 1200ms infinite"),
            playAudio(),
            ringTimeOut = setTimeout((function () {
                $("img.user-noti-bell").css("animation", ""),
                    window.clearTimeout(ringTimeOut),
                    ringTimeOut = null,
                    console.log("close")
            }
            ), 3e3)),
            notiItemHandler("noti-box-web", data);
        const countC = $("#noti-web-count")
            , value = countC.html().toString().trim() || "";
        var count = 1;
        console.log(value),
            value && (count = parseInt(value),
                count++),
            countC.text(count),
            $(countC.parent()).removeClass("d-none"),
            $(countC.parent()).addClass("d-flex")
    }
}
function handlerUploadBalance(data) {
    let balance = data.user ? data.user.balance : 0;
    balance && (balance = formatPrice(balance),
        $("p[data-id=userBalance]").text(balance))
}
function handlerNotiModDelTopic(id) {
    if (id) {
        let topicCurrent;
        $(`div[data-id-current-topic=${id}]`) && (window.location.href = "/cho-la-so")
    }
}
function handlerNotiModDelCmt(id) {
    if (id && !checkMod()) {
        let comment = $(`#comment-${id}`);
        comment && comment.remove()
    }
}
function handlerNotiUseFunction(data) {
    if (!isMobile()) {
        const notiContainer = $("#notiContainer")
            , id = GenId()
            , obj = {
                id: id,
                data: data
            }
            , script = `\n                        <script>\n                             $('#p-${id} button.push-notification-close-area').on('click',function (){\n                                   var parent = $(this).parent()\n                                    $(parent).fadeOut(300, function () {\n                                        $(this).remove();\n                                    });\n                             })\n                              setInterval(function () {\n                                  let self = this;\n                                        $('#p-${id}').fadeOut(300, function () {\n                                            $(this).remove();\n                                            clearInterval(self)\n                                        });\n                               }, 10000)\n                         <\/script>\n                        `;
        var tmpl = $("#notification").tmpl(obj);
        notiContainer.append(tmpl),
            notiContainer.append(script)
    }
}
function notiItemHandler(container, i) {
    i.time = sinceTime(i.created);
    const action = i.action;
    console.log("--", action),
        action.actor && "" == action.actor.avatar && (action.actor.avatar = "/public/images/ic_default_avt.jpg"),
        action.actionStr = convertActionToStr(action.action),
        action.targetStr = getTargetName(action.target_module, action.target_object),
        action.preTarget = getPreTarget(action.target_module),
        i.href = getHref(action.target_module, action.target_object);
    var tmpl = $("#uNotiTemplate").tmpl(i);
    $("#" + container).prepend(tmpl)
}
function validateEmail(email) {
    return !!email && EmailRegex.test(email)
}
function validatePassword(pass) {
    if (pass)
        return PasswordRegex.test(pass)
}
function validateUsername(pass) {
    if (pass)
        return UsernameRegex.test(pass)
}
function validateName(name) {
    if (name)
        return name.length >= 3 && name.length <= 50 && NameRegex.test(removeAscent(name))
}
function removeAscent(str) {
    return null == str ? str : str = (str = (str = (str = (str = (str = (str = (str = str.toLowerCase()).replace(/à|á|ạ|ả|ã|â|ầ|ấ|ậ|ẩ|ẫ|ă|ằ|ắ|ặ|ẳ|ẵ/g, "a")).replace(/è|é|ẹ|ẻ|ẽ|ê|ề|ế|ệ|ể|ễ/g, "e")).replace(/ì|í|ị|ỉ|ĩ/g, "i")).replace(/ò|ó|ọ|ỏ|õ|ô|ồ|ố|ộ|ổ|ỗ|ơ|ờ|ớ|ợ|ở|ỡ/g, "o")).replace(/ù|ú|ụ|ủ|ũ|ư|ừ|ứ|ự|ử|ữ/g, "u")).replace(/ỳ|ý|ỵ|ỷ|ỹ/g, "y")).replace(/đ/g, "d")
}
function validatePhone(pass) {
    if (pass)
        return PhoneRegex.test(pass)
}
function validateAddress(pass) {
    if (pass)
        return AddressRegex.test(pass)
}
function validateIdCard(pass) {
    if (pass)
        return IdCardRegex.test(pass)
}
$(window).resize((function () {
    const path = window.location.pathname
        , width = $(window).width();
    if (width > 768 && ($("#sidebar").removeClass("active"),
        $(".overlay").removeClass("active"),
        $("body").removeClass("overflow-hidden"),
        $(".header-content-mobile").css("display", "")),
        isLaSoScreen(path) || isTopicScreen(path))
        resizeLaSo();
    else {
        const fnc = ResizeFunc[path];
        fnc && fnc()
    }
}
)).resize(),
    $(window).scroll((function () {
        var scrollBtn = document.getElementById("scrollTop");
        scrollBtn && (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20 ? scrollBtn.style.display = "block" : scrollBtn.style.display = "none")
    }
    ));
const Validate = {
    email: validateEmail,
    password: validatePassword,
    name: validateName,
    phone: validatePhone,
    address: validateAddress,
    idCard: validateIdCard,
    username: validateUsername
};
function isTopicScreen(path) {
    const topicRegex = /-t\d*$/;
    if (-1 != path.indexOf("?")) {
        var paths = path.split("?");
        paths.length > 1 && (path = paths[0])
    }
    return topicRegex.test(path)
}
function isLaSoScreen(path) {
    const laSoRegex = /-\d*$/;
    if (-1 != path.indexOf("?")) {
        var paths = path.split("?");
        paths.length > 1 && (path = paths[0])
    }
    return laSoRegex.test(path) && path.startsWith("/la-so")
}
function isLogged() {
    var isLogged;
    return "true" == $("body").attr("data-logged")
}
function getToken() {
    var token = $("body").attr("data-token");
    return token ? (Agents.headers = {
        "X-TU-VI": token
    },
        token) : ""
}
function openModalLogin(event, previous) {
    if (event && event.hasOwnProperty("target")) {
        const element = $(event.target);
        element && element.length ? (element.attr("data-target", "#modalRequiredLogin"),
            element.attr("data-toggle", "modal"),
            $("#modalRequiredLogin").find("#cfLogin").on("click", (function () {
                const uri = window.location.href;
                previous || (previous = encodeURIComponent(uri)),
                    window.location.href = "/login?previous=" + previous
            }
            ))) : console.log("Event.target was undefined")
    } else
        console.log("Missing event click")
}
function openModalHideMod(idTarget, targetType) {
    console.log("Mod wanna hide this: ", idTarget, targetType);
    let id = parseInt(idTarget) || 0;
    if (id) {
        const param = {
            id: id
        };
        console.log("target type", targetType),
            targetType ? Agents.post(APIs.moderators.deleteComment, param, (function (res) {
                if (console.log(res),
                    "200" == res.code) {
                    var comment = $(`.content-comment-topic[${targetType}=${id}]`)
                        , contentComment = $(comment[0]);
                    contentComment.empty(),
                        contentComment.text("Nội dung đã bị ẩn bởi quản lý Tuvi.vn"),
                        console.log("On Success")
                }
            }
            ), (function (err) {
                console.log(err)
            }
            )) : Agents.post(APIs.moderators.deleteTopic, param, (function (res) {
                console.log(res),
                    "200" == res.code && (window.location.href = "/cho-la-so")
            }
            ), (function (err) {
                console.log(err)
            }
            ))
    }
}
function openModalHaveError(title, content) {
    $("#titleErrMes").text(title),
        $("#contentErrMes").text(content),
        $("#modalError").modal("show")
}
function GenId() {
    return "_" + Math.random().toString(36).substr(2, 9)
}
function goToByScroll(id) {
    id = id.replace("link", "");
    const a = $("#" + id);
    if (console.log("a: ", a),
        a && a.length > 0) {
        var b = a.offset().top;
        $("html,body").animate({
            scrollTop: b - 45
        }, "slow")
    }
}
function sinceTime(date) {
    var seconds = Math.floor((new Date - new Date(date)) / 1e3);
    if (seconds > 0) {
        var interval = seconds / 31536e3;
        return interval > 1 ? Math.floor(interval) + " năm trước" : (interval = seconds / 2592e3) > 1 ? Math.floor(interval) + " tháng trước" : (interval = seconds / 86400) > 1 ? Math.floor(interval) + " ngày trước" : (interval = seconds / 3600) > 1 ? Math.floor(interval) + " giờ trước" : (interval = seconds / 60) > 1 ? Math.floor(interval) + " phút trước" : Math.floor(seconds) + " giây trước"
    }
    return "Vừa xong"
}
function getIconTagTopic(tagId) {
    if (!tagId)
        return "";
    switch (tagId) {
        case 1:
            return '<div class="tag-cate-icon tag-cate-career zoom-half"></div>';
        case 2:
            return '<div class="tag-cate-icon tag-cate-friends zoom-half"></div>';
        case 3:
            return '<div class="tag-cate-icon tag-cate-couple zoom-half"></div>';
        case 4:
            return '<div class="tag-cate-icon tag-cate-child zoom-half"></div>';
        case 5:
            return '<div class="tag-cate-icon tag-cate-love zoom-half"></div>';
        case 6:
            return '<div class="tag-cate-icon tag-cate-economy zoom-half"></div>';
        case 7:
            return '<div class="tag-cate-icon tag-cate-health zoom-half"></div>';
        case 8:
            return '<div class="tag-cate-icon tag-cate-emigrate zoom-half"></div>';
        case 9:
            return '<div class="tag-cate-icon tag-cate-colleague zoom-half"></div>';
        case 10:
            return '<div class="tag-cate-icon tag-cate-ancestor zoom-half"></div>';
        case 11:
            return '<div class="tag-cate-icon tag-cate-parents zoom-half"></div>';
        case 12:
            return '<div class="tag-cate-icon tag-cate-house zoom-half"></div>';
        case 13:
            return '<span class="txt-sub-content">Đại vận</span>';
        case 14:
            return '<span class="txt-sub-content">Tiểu vận</span>';
        default:
            return '<div class="tag-cate-icon tag-cate-career zoom-half"></div>'
    }
}
function getAnimalClass(name) {
    if (name)
        switch (name = name.toLowerCase()) {
            case "tí":
            case "tý":
                return "chuot";
            case "sửu":
                return "suu";
            case "dần":
                return "dan";
            case "mão":
                return "mao";
            case "thìn":
                return "thin";
            case "tị":
            case "tỵ":
                return "ty";
            case "ngọ":
                return "ngo";
            case "mùi":
                return "mui";
            case "thân":
                return "than";
            case "dậu":
                return "dau";
            case "tuất":
                return "tuat";
            case "hợi":
                return "hoi";
            default:
                return "chuot"
        }
}
function getColorNguHanhClass(name) {
    if (name)
        switch (name = name.toLowerCase()) {
            case "kim":
                return "kim";
            case "mộc":
                return "moc";
            case "thủy":
                return "thuy";
            case "hỏa":
                return "hoa";
            case "thổ":
                return "tho";
            default:
                return "kim"
        }
}
function topFunction() {
    $("html,body").animate({
        scrollTop: 0
    }, "slow")
}
function formatPrice(price) {
    var newPrice = 0;
    return price && (newPrice = price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".")),
        newPrice
}
function formatPriceNew(price) {
    var newPrice = "";
    const len = (price = price.toString().replaceAll(".", "")).length;
    if (len > 3) {
        let count = 0;
        for (let i = len - 1; i >= 0; i--)
            count += 1,
                newPrice = price.substr(i, 1) + newPrice,
                count % 3 == 0 && count < len && (newPrice = "." + newPrice)
    } else
        newPrice = price;
    return newPrice
}
function getBackgroundLaSoPreview(con, menh) {
    var background = "la-so-preview-chuot la-so-preview-kim";
    switch (con.toString().toLowerCase()) {
        case "tý":
            background = "la-so-preview-chuot";
            break;
        case "sửu":
            background = "la-so-preview-suu";
            break;
        case "dần":
            background = "la-so-preview-dan";
            break;
        case "mão":
            background = "la-so-preview-mao";
            break;
        case "thìn":
            background = "la-so-preview-thin";
            break;
        case "tỵ":
            background = "la-so-preview-ty";
            break;
        case "ngọ":
            background = "la-so-preview-ngo";
            break;
        case "mùi":
            background = "la-so-preview-mui";
            break;
        case "thân":
            background = "la-so-preview-than";
            break;
        case "dậu":
            background = "la-so-preview-dau";
            break;
        case "tuất":
            background = "la-so-preview-tuat";
            break;
        case "hợi":
            background = "la-so-preview-hoi"
    }
    switch (menh.toString().toLowerCase()) {
        case "kim":
            background += " la-so-preview-kim";
            break;
        case "thủy":
            background += " la-so-preview-thuy";
            break;
        case "hỏa":
            background += " la-so-preview-hoa";
            break;
        case "thổ":
            background += " la-so-preview-tho";
            break;
        case "mộc":
            background += " la-so-preview-moc"
    }
    return background
}
function parseJwt(token) {
    if (token) {
        var base64Url, base64 = token.split(".")[1].replace(/-/g, "+").replace(/_/g, "/"), jsonPayload = decodeURIComponent(atob(base64).split("").map((function (c) {
            return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2)
        }
        )).join(""));
        return JSON.parse(jsonPayload)
    }
}
function checkRole() {
    var roles;
    return "true" == $("body").attr("data-master")
}
function checkMod() {
    var roles;
    return "true" == $("body").attr("data-mod")
}
function checkModComment(roles) {
    return console.log("roles", roles),
        1 == roles
}
function getPosition(string, subString, index) {
    return string.split(subString, index).join(subString).length
}
function blinkMe(item) {
    console.log(typeof item),
        item && "object" == typeof item && ($(item).addClass("blink_me"),
            setTimeout((function () {
                $(item).removeClass("blink_me")
            }
            ), 1100))
}
function topicItemHandler(item) {
    const user = item.user;
    user || (item.user = {
        avatar: "",
        name: "",
        rank_id: 0,
        rank_name: ""
    }),
        user.rank || (user.rank = {
            title: ""
        }),
        item.budget = formatPrice(item.budget_display);
    const conGiap = item.laso.can_chi_tuoi
        , menh = item.laso.loai_hanh_cua_ban_menh
        , menhs = menh.split(" ");
    item.background = getBackgroundLaSoPreview(conGiap.split(" ")[1], menhs[menhs.length - 1]),
        item.icon_save = "/public/images/ic-save.png",
        item.is_saved && (item.icon_save = "/public/images/ic-saved.png");
    const isPro = item.user.is_thay;
    return isPro && (item.user.is_thay = "/public/images/professor-verify-avt.png"),
        item.timeSince = sinceTime(item.updated || Date.now()),
        item
}
const fileTypes = ["image/jpeg", "image/jpg", "image/png"];
function validFileType(file) {
    return fileTypes.includes(file.type)
}
function validFileSize(file) {
    return file.size < 2e6
}
function initQAScreen() {
    let openCollapse;
    switch (localStorage.getItem("openCollapse")) {
        case "criteriaUser":
            setTimeout((function () {
                $("#collapseCriteriaUser").addClass("show"),
                    $("html,body").animate({
                        scrollTop: 555
                    }, "slow")
            }
            ), 300),
                localStorage.setItem("openCollapse", "");
            break;
        case "criteriaPro":
            setTimeout((function () {
                $("#collapseCriteriaPro").addClass("show"),
                    $("html,body").animate({
                        scrollTop: 610
                    }, "slow")
            }
            ), 300),
                localStorage.setItem("openCollapse", "");
            break;
        case "ruleSocial":
            setTimeout((function () {
                $("#collapseRuleSocial").addClass("show"),
                    $("html,body").animate({
                        scrollTop: 790
                    }, "slow")
            }
            ), 300),
                localStorage.setItem("openCollapse", "");
            break;
        case "confirmAccPro":
            setTimeout((function () {
                $("#collapseConfirmAccPro").addClass("show"),
                    $("html,body").animate({
                        scrollTop: 705
                    }, "slow")
            }
            ), 300),
                localStorage.setItem("openCollapse", "");
            break;
        case "paymentSupport":
            setTimeout((function () {
                $("#collapsePaymentSupport").addClass("show"),
                    $("html,body").animate({
                        scrollTop: 730
                    }, "slow")
            }
            ), 300),
                localStorage.setItem("openCollapse", "");
            break;
        case "ruleLaSoMarket":
            setTimeout((function () {
                $("#collapseRuleLaSoMarket").addClass("show"),
                    $("html,body").animate({
                        scrollTop: 850
                    }, "slow")
            }
            ), 300),
                localStorage.setItem("openCollapse", "")
    }
}
function initHomeScreen() {
    loadNextAndPreDay(),
        loadPaginationTopTopics(),
        $(".lazy").lazy(),
        $("#btnTimLichNhanh").click((function () {
            var parent = $("#form-tim-lich-nhanh")
                , day = parent.find('select[name="day"]').val()
                , month = parent.find('select[name="month"]').val()
                , year = parent.find('select[name="year"]').val()
                , isLunar = 0
                , checked = parent.find("input[name='calendar']:checked").map((function () {
                    isLunar = $(this).val()
                }
                ));
            window.location.href = `/xem-ngay-${day}-${month}-${year}?lunar=${isLunar}`
        }
        ));
    const RANK_BY_DAY = {
        id: 1,
        noResult: "Chưa có xếp hạng trong hôm nay"
    }
        , RANK_BY_WEEK = {
            id: 2,
            noResult: "Chưa có xếp hạng trong tuần này"
        }
        , RANK_BY_MONTH = {
            id: 3,
            noResult: "Chưa có xếp hạng trong tháng này"
        }
        , ROLE_master = {
            id: 1,
            title: "Thầy",
            pointTitle: "Điểm uy tín"
        }
        , ROLE_user = {
            id: 2,
            title: "Tín chủ",
            pointTitle: "Điểm hoạt động"
        }
        , URL_RANKING = `${DOMAIN}/users/ranking?limit=10&page=1`;
    var loadedDayPro = !1;
    $("#rankingDayProTab").click((function () {
        loadedDayPro || loadRanking(URL_RANKING, RANK_BY_DAY, ROLE_master, $("#rankingDayPro"), (function () {
            loadedDayPro = !0
        }
        ))
    }
    ));
    var loadedWeekPro = !1;
    $("#rankingWeekProTab").click((function () {
        loadedWeekPro || loadRanking(URL_RANKING, RANK_BY_WEEK, ROLE_master, $("#rankingWeekPro"), (function () {
            loadedWeekPro = !0
        }
        ))
    }
    ));
    var loadedWeekUser = !1;
    $("#rankingWeekUserTab").click((function () {
        loadedWeekUser || loadRanking(URL_RANKING, RANK_BY_WEEK, ROLE_user, $("#rankingWeekUser"), (function () {
            loadedWeekUser = !0
        }
        ))
    }
    ));
    var loadedDayUser = !1;
    function loadRanking(url, rankBy, role, container, callback) {
        role || (role = ROLE_user),
            rankBy || (rankBy = RANK_BY_MONTH),
            container || (container = $("#rankingMonthPro")),
            Agents.get(url + `&rankBy=${rankBy.id}&role=${role.id}`, (function (res) {
                if ("200" == res.code) {
                    container.empty();
                    const data = res.data || null;
                    if (data) {
                        const rows = data.data || [];
                        if (rows.length > 0) {
                            let table = $('<table class="txt-sub-content ranking-professor-table"></table>');
                            table.append('<tr class="txt-sub-content-bold"><td>Hạng</td>' + `<td>${role.title}</td>` + "<td>Cấp độ</td>" + `<td>${role.pointTitle}</td>` + "</tr>"),
                                rows.forEach((function (row) {
                                    let order = row.rank || 1;
                                    const totalPoint = row.total_point || 0
                                        , user = row.user
                                        , rank = user.rank || null
                                        , rankId = rank && rank.hasOwnProperty("id") ? rank.id : 1
                                        , rankTitle = rank && rank.hasOwnProperty("title") ? rank.title : ""
                                        , username = user.username || ""
                                        , fullName = user.name || "";
                                    order <= 3 && (order = `<div class="top-professor-rank top-professor-${order} m-auto"></div>`);
                                    const tr = `<tr class="txt-sub-content-mid">\n                                                <td>${order}</td>\n                                                <td><a href="/${username}"\n                                                            class="color-black text-decoration-none">${fullName}</a></td>\n                                                <td class="d-flex align-items-center justify-content-center">\n                                                    <div class="user-medal-rank user-medal-rank-${rankId} zoom-half mr-2"></div>\n                                                    <div class="user-title-rank-${rankId}">\n                                                        ${rankTitle}\n                                                    </div>\n                                                </td>\n                                                <td>${totalPoint}</td>\n                                            </tr>`;
                                    table.append(tr)
                                }
                                )),
                                container.append(table)
                        } else {
                            const message = rankBy.noResult || "";
                            container.append(`<p class="txt-sub-content text-secondary text-center m-t-20 m-b-20">${message}</p>`)
                        }
                    }
                    callback && "function" == typeof callback && callback()
                }
            }
            ), (function (err) {
                console.log(err)
            }
            ))
    }
    $("#rankingDayUserTab").click((function () {
        loadedDayUser || loadRanking(URL_RANKING, RANK_BY_DAY, ROLE_user, $("#rankingDayUser"), (function () {
            loadedDayUser = !0
        }
        ))
    }
    ))
}
function initSaveTopicGlobal() {
    $("button[name=saveLaSoHome]").click((function (event) {
        if (event.preventDefault(),
            isLogged())
            try {
                const element = $(this)
                    , icon = "BUTTON" == event.target.nodeName ? $(event.target.children) : $(event.target)
                    , topicId = element.attr("data-id")
                    , isSaved = element.attr("data-save")
                    , url = `${DOMAIN}/user/saved-list`
                    , param = {
                        module: "TOPIC",
                        item_object: topicId
                    };
                topicId ? "false" == isSaved ? Agents.post(url, param, (function (res) {
                    "200" == res.code && (element.attr("data-save", "true"),
                        icon.attr("src", "/public/images/ic-saved.png"))
                }
                ), (function (err) {
                    console.log(err)
                }
                )) : Agents.delete(url, param, (function (res) {
                    "200" == res.code && (element.attr("data-save", "false"),
                        icon.attr("src", "/public/images/ic-save.png"))
                }
                ), (function (err) {
                    console.log(err)
                }
                )) : console.log("Missing Topic ID")
            } catch (err) {
                console.log("error: ", err)
            }
        else
            openModalLogin(event)
    }
    ))
}
function loadPaginationTopTopics() {
    const container = $("#listPagination");
    let totalPage = parseInt($("#listTopTopics").attr("data-total-number")) || 0;
    const listEle = []
        , back = '<li class="paginationjs-prev" name="btnBack"><a class="cursor-pointer">«</a></li>'
        , next = '<li class="paginationjs-next" name="btnNext"><a class="cursor-pointer">»</a></li>';
    if (totalPage > 1) {
        totalPage > 5 && (totalPage = 5),
            listEle.push(back),
            listEle.push('<li class="paginationjs-page J-paginationjs-page active" name="pagNum" data-page="1">\n                        <a class="cursor-pointer">1</a>\n                     </li>');
        for (let i = 2; i <= totalPage; i++)
            listEle.push(`<li class="paginationjs-page J-paginationjs-page" name="pagNum" data-page="${i}">\n                        <a class="cursor-pointer">${i}</a>\n                     </li>`);
        listEle.push(next)
    } else
        $("#paginationTopic").addClass("d-none");
    container.html(listEle),
        initSaveTopicGlobal();
    const containerEle = $("#listTopTopics");
    $("#listPagination li[name=btnNext]").on("click", (function () {
        $("html, body").animate({
            scrollTop: $("#listTopTopics").offset().top
        }, 500);
        let index = $("#listPagination li.active").attr("data-page") || 0;
        if (index > 0 && index < 6) {
            $(`#listPagination li[data-page=${index}]`).removeClass("active"),
                5 == index ? index = 5 : index++;
            const uri = `?pageSize=5&pageNumber=${index}`;
            Agents.get(`${APIs.markets.topics}${uri}`, (function (res) {
                if (200 == res.code) {
                    const data = res.data.data;
                    containerEle.empty(),
                        data.forEach(item => {
                            const topicId = item.id || 0
                                , itemFormated = topicItemHandler(item)
                                , user = item.user
                                , isThay = user && user.is_thay;
                            item && item.media && item.media.path && $(`a#${topicId} .topic-picture-preview`).append(`<img class="topic-picture lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${item.media.path}" alt="topicPicture">`),
                                isThay && $(`a#${topicId} .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="professorIc">');
                            const cardTopic = $("#cardTopic").tmpl(itemFormated);
                            cardTopic.appendTo(containerEle);
                            var tagContainer = $(`a#${topicId} > div.list-tag`);
                            tagContainer && 1 == tagContainer.length && (tagContainer = tagContainer[0]);
                            const tags = itemFormated.tags || [];
                            if (tags.length > 0)
                                for (let i = 0; i < tags.length; i++) {
                                    const tagItem = tags[i]
                                        , idTag = tagItem.id || 0
                                        , iconTag = getIconTagTopic(idTag)
                                        , child = $(iconTag);
                                    var div = $("<div class='small-tag'></div>");
                                    div.html(child),
                                        $(tagContainer).find(".tag-container").append(div)
                                }
                            else
                                $(tagContainer).addClass("d-none"),
                                    $(tagContainer).empty();
                            var viewUserContainer = $(`a#${topicId} .list-view-user`)
                                , viewUsers = itemFormated.view_users || []
                                , totalViewUsers = itemFormated.total_view_user || 0;
                            if (totalViewUsers > 0) {
                                const maxUser = 5 == totalViewUsers ? 5 : totalViewUsers > 5 ? 4 : totalViewUsers;
                                for (let i = 0; i < maxUser; i++) {
                                    const user = viewUsers[i];
                                    var avatar = user ? user.avatar : "";
                                    avatar && "" != avatar || (avatar = "/public/images/avatars/avt-default.jpg");
                                    const name = user ? user.name : "";
                                    var img = $(`<img class="la-so-avt-activity lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${avatar}" title="${name}">`);
                                    $(viewUserContainer).append(img)
                                }
                                if (totalViewUsers > 5) {
                                    let moreUser = totalViewUsers - 4 > 99 ? 99 : totalViewUsers - 4;
                                    const more = $('<div class="la-so-preview-activity-more txt-sub-content"></div>').text(`+${moreUser}`);
                                    $(viewUserContainer).append(more)
                                }
                            }
                            initSaveTopicGlobal()
                        }
                        )
                }
            }
            )),
                $(`#listPagination li[data-page=${index}]`).addClass("active")
        } else
            $(`#listPagination li[data-page=${index}]`).addClass("active")
    }
    )),
        $("#listPagination li[name=btnBack]").on("click", (function () {
            $("html, body").animate({
                scrollTop: $("#listTopTopics").offset().top
            }, 500);
            let index = $("#listPagination li.active").attr("data-page") || 0;
            if (index > 0 && index < 6) {
                $(`#listPagination li[data-page=${index}]`).removeClass("active"),
                    1 == index ? index = 1 : index--,
                    console.log("indexx:: ", index);
                const uri = `?pageSize=5&pageNumber=${index}`;
                Agents.get(`${APIs.markets.topics}${uri}`, (function (res) {
                    if (200 == res.code) {
                        const data = res.data.data;
                        containerEle.empty(),
                            data.forEach(item => {
                                const topicId = item.id || 0
                                    , itemFormated = topicItemHandler(item)
                                    , user = item.user
                                    , isThay = user && user.is_thay;
                                item && item.media && item.media.path && $(`a#${topicId} .topic-picture-preview`).append(`<img class="topic-picture lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${item.media.path}" alt="topicPicture">`),
                                    isThay && $(`a#${topicId} .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="professorIc">');
                                const cardTopic = $("#cardTopic").tmpl(itemFormated);
                                cardTopic.appendTo(containerEle);
                                var tagContainer = $(`a#${topicId} > div.list-tag`);
                                tagContainer && 1 == tagContainer.length && (tagContainer = tagContainer[0]);
                                const tags = itemFormated.tags || [];
                                if (tags.length > 0)
                                    for (let i = 0; i < tags.length; i++) {
                                        const tagItem = tags[i]
                                            , idTag = tagItem.id || 0
                                            , iconTag = getIconTagTopic(idTag)
                                            , child = $(iconTag);
                                        var div = $("<div class='small-tag'></div>");
                                        div.html(child),
                                            $(tagContainer).find(".tag-container").append(div)
                                    }
                                else
                                    $(tagContainer).addClass("d-none"),
                                        $(tagContainer).empty();
                                var viewUserContainer = $(`a#${topicId} .list-view-user`)
                                    , viewUsers = itemFormated.view_users || []
                                    , totalViewUsers = itemFormated.total_view_user || 0;
                                if (totalViewUsers > 0) {
                                    const maxUser = 5 == totalViewUsers ? 5 : totalViewUsers > 5 ? 4 : totalViewUsers;
                                    for (let i = 0; i < maxUser; i++) {
                                        const user = viewUsers[i];
                                        var avatar = user ? user.avatar : "";
                                        avatar && "" != avatar || (avatar = "/public/images/avatars/avt-default.jpg");
                                        const name = user ? user.name : "";
                                        var img = $(`<img class="la-so-avt-activity lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${avatar}" title="${name}">`);
                                        $(viewUserContainer).append(img)
                                    }
                                    if (totalViewUsers > 5) {
                                        let moreUser = totalViewUsers - 4 > 99 ? 99 : totalViewUsers - 4;
                                        const more = $('<div class="la-so-preview-activity-more txt-sub-content"></div>').text(`+${moreUser}`);
                                        $(viewUserContainer).append(more)
                                    }
                                }
                                initSaveTopicGlobal()
                            }
                            )
                    }
                }
                )),
                    $(`#listPagination li[data-page=${index}]`).addClass("active")
            } else
                $(`#listPagination li[data-page=${index}]`).addClass("active")
        }
        )),
        $("#listPagination li.paginationjs-page").on("click", (function () {
            $("html, body").animate({
                scrollTop: $("#listTopTopics").offset().top
            }, 500);
            const index = this.getAttribute("data-page");
            $("#listPagination li.active").removeClass("active"),
                $(this).addClass("active");
            const uri = `?pageSize=5&pageNumber=${index}`;
            Agents.get(`${APIs.markets.topics}${uri}`, (function (res) {
                if (200 == res.code) {
                    const data = res.data.data;
                    containerEle.empty(),
                        data.forEach(item => {
                            const topicId = item.id || 0
                                , itemFormated = topicItemHandler(item)
                                , user = item.user
                                , isThay = user && user.is_thay;
                            item && item.media && item.media.path && $(`a#${topicId} .topic-picture-preview`).append(`<img class="topic-picture lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${item.media.path}" alt="topicPicture">`),
                                isThay && $(`a#${topicId} .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="professorIc">');
                            const cardTopic = $("#cardTopic").tmpl(itemFormated);
                            cardTopic.appendTo(containerEle);
                            var tagContainer = $(`a#${topicId} > div.list-tag`);
                            tagContainer && 1 == tagContainer.length && (tagContainer = tagContainer[0]);
                            const tags = itemFormated.tags || [];
                            if (tags.length > 0)
                                for (let i = 0; i < tags.length; i++) {
                                    const tagItem = tags[i]
                                        , idTag = tagItem.id || 0
                                        , iconTag = getIconTagTopic(idTag)
                                        , child = $(iconTag);
                                    var div = $("<div class='small-tag'></div>");
                                    div.html(child),
                                        $(tagContainer).find(".tag-container").append(div)
                                }
                            else
                                $(tagContainer).addClass("d-none"),
                                    $(tagContainer).empty();
                            var viewUserContainer = $(`a#${topicId} .list-view-user`)
                                , viewUsers = itemFormated.view_users || []
                                , totalViewUsers = itemFormated.total_view_user || 0;
                            if (totalViewUsers > 0) {
                                const maxUser = 5 == totalViewUsers ? 5 : totalViewUsers > 5 ? 4 : totalViewUsers;
                                for (let i = 0; i < maxUser; i++) {
                                    const user = viewUsers[i];
                                    var avatar = user ? user.avatar : "";
                                    avatar && "" != avatar || (avatar = "/public/images/avatars/avt-default.jpg");
                                    const name = user ? user.name : "";
                                    var img = $(`<img class="la-so-avt-activity lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${avatar}" title="${name}">`);
                                    $(viewUserContainer).append(img)
                                }
                                if (totalViewUsers > 5) {
                                    let moreUser = totalViewUsers - 4 > 99 ? 99 : totalViewUsers - 4;
                                    const more = $('<div class="la-so-preview-activity-more txt-sub-content"></div>').text(`+${moreUser}`);
                                    $(viewUserContainer).append(more)
                                }
                            }
                            initSaveTopicGlobal(),
                                $(".lazy").lazy()
                        }
                        )
                }
            }
            ))
        }
        ))
}
function loadNextAndPreDay() {
    $("#previous-date").on("click", (function () {
        const current = $("#next-date")
            , day = current.attr("data-day")
            , month = current.attr("data-month")
            , year = current.attr("data-year");
        console.log("zo pre", `${day}/${month}/${year}`);
        const yesterday = new Date(month + "/" + day + "/" + year);
        yesterday.setDate(yesterday.getDate() - 1),
            current.attr("data-day", yesterday.getDate()),
            current.attr("data-month", yesterday.getMonth() + 1),
            current.attr("data-year", yesterday.getFullYear()),
            $(this).attr("data-day", yesterday.getDate()),
            $(this).attr("data-month", yesterday.getMonth() + 1),
            $(this).attr("data-year", yesterday.getFullYear()),
            getLichVanNienByDay(yesterday.getDate(), yesterday.getMonth() + 1, yesterday.getFullYear())
    }
    )),
        $("#next-date").on("click", (function () {
            const current = $("#previous-date")
                , day = current.attr("data-day")
                , month = current.attr("data-month")
                , year = current.attr("data-year");
            console.log("zo next", `${day}/${month}/${year}`);
            const yesterday = new Date(month + "/" + day + "/" + year);
            yesterday.setDate(yesterday.getDate() + 1),
                current.attr("data-day", yesterday.getDate()),
                current.attr("data-month", yesterday.getMonth() + 1),
                current.attr("data-year", yesterday.getFullYear()),
                $(this).attr("data-day", yesterday.getDate()),
                $(this).attr("data-month", yesterday.getMonth() + 1),
                $(this).attr("data-year", yesterday.getFullYear()),
                console.log("check yesterday: ", yesterday),
                getLichVanNienByDay(yesterday.getDate(), yesterday.getMonth() + 1, yesterday.getFullYear())
        }
        )),
        $("#previous-date-right").on("click", (function () {
            const current = $(this)
                , next = $("#next-date-right")
                , day = current.attr("data-day")
                , month = current.attr("data-month")
                , year = current.attr("data-year")
                , yesterday = new Date(month + "/" + day + "/" + year);
            yesterday.setDate(yesterday.getDate() - 1),
                next.attr("data-day", yesterday.getDate()),
                next.attr("data-month", yesterday.getMonth() + 1),
                next.attr("data-year", yesterday.getFullYear()),
                current.attr("data-day", yesterday.getDate()),
                current.attr("data-month", yesterday.getMonth() + 1),
                current.attr("data-year", yesterday.getFullYear()),
                getLichVanNienByDay(yesterday.getDate(), yesterday.getMonth() + 1, yesterday.getFullYear())
        }
        )),
        $("#next-date-right").on("click", (function () {
            const current = $(this)
                , pre = $("#previous-date-right")
                , day = current.attr("data-day")
                , month = current.attr("data-month")
                , year = current.attr("data-year")
                , yesterday = new Date(month + "/" + day + "/" + year);
            yesterday.setDate(yesterday.getDate() + 1),
                pre.attr("data-day", yesterday.getDate()),
                pre.attr("data-month", yesterday.getMonth() + 1),
                pre.attr("data-year", yesterday.getFullYear()),
                current.attr("data-day", yesterday.getDate()),
                current.attr("data-month", yesterday.getMonth() + 1),
                current.attr("data-year", yesterday.getFullYear()),
                getLichVanNienByDay(yesterday.getDate(), yesterday.getMonth() + 1, yesterday.getFullYear())
        }
        ))
}
function resizeInHome() {
    const lapLaSo = $("#lap-la-so-tu-vi")
        , rightSideAds = $("#rightside-ads")
        , lichAmDuong = $("#lich-am-duong")
        , timLichNhanh = $("#tim-lich-nhanh")
        , groupFB = $("#group-fb")
        , lapLaSoRes = $("#lap-la-so-responsive")
        , rightSideAdsRes = $("#rightside-ads-responsive")
        , lichAmDuongRes = $("#lich-am-duong-responsive")
        , rightContent = $(".right-content")
        , width = $(window).width();
    width < 769 ? 0 === lapLaSoRes.find("#lap-la-so-tu-vi").length && (lapLaSoRes.prepend(lapLaSo),
        rightSideAdsRes.prepend(rightSideAds),
        lichAmDuongRes.prepend(lichAmDuong)) : 0 === rightContent.find("#lap-la-so-tu-vi").length && rightContent.prepend(lapLaSo, lichAmDuong, groupFB, timLichNhanh, rightSideAds)
}
function getRanking(limit, page, rankBy, id) {
    const url = `${APIs.ranking.get}?limit=${limit}&page=${page}&rankBy=${rankBy}`;
    Agents.get(url, (function (res) {
        if (console.log("res: ", res),
            res && res.data) {
            const listRanking = res.data.data
                , container = $(`${id}`);
            container.empty();
            const header = '<tr class="txt-sub-content-bold"><td>Hạng</td><td>Thầy</td><td>Cấp độ</td><td>Điểm uy tín</td></tr>';
            container.append(header),
                listRanking.forEach((function (ranking) {
                    let className = "", rank;
                    switch (ranking.rank) {
                        case 1:
                            className = "top-professor-rank top-professor-1 m-auto",
                                ranking.rank = "";
                            break;
                        case 2:
                            className = "top-professor-rank top-professor-2 m-auto",
                                ranking.rank = "";
                            break;
                        case 3:
                            className = "top-professor-rank top-professor-3 m-auto",
                                ranking.rank = "";
                            break;
                        default:
                            className = ""
                    }
                    const obj = {
                        item: ranking,
                        className: className
                    }
                        , tmpl = $("#getRanking").tmpl(obj);
                    container.append(tmpl)
                }
                ))
        }
    }
    ), (function (err) {
        console.log("ERROR: ", err)
    }
    ))
}
function getLichVanNienByDay(day, month, year) {
    const url = `${APIs.others.lichVanNien}?day=${day}&month=${month}&year=${year}`;
    Agents.get(url, (function (res) {
        if (console.log("res: ", res),
            res = res.data) {
            $("#lvn-full").text(res.full_format),
                $("#lvn-l-month").text("Tháng " + res.lunar_month),
                $("#lvn-l-day").text(res.lunar_day),
                $("#lvn-ch-day").text(res.can_chi_ngay),
                $("#lvn-ch-month").text(res.can_chi_thang),
                $("#xem-chi-tiet-am-duong").attr("href", `/xem-ngay-${res.solar_day}-${res.solar_month}-${res.solar_year}`),
                $("#lvn-full-right").text(res.full_format),
                $("#lvn-full-right").attr("data-day", res.solar_day),
                $("#lvn-full-right").attr("data-month", res.solar_month),
                $("#lvn-full-right").attr("data-year", res.solar_year),
                $("#lvn-l-month-right").text("Tháng " + res.lunar_month),
                $("#lvn-l-day-right").text(res.lunar_day),
                $("#lvn-ch-day-right").text(res.can_chi_ngay),
                $("#lvn-ch-month-right").text(res.can_chi_thang);
            let times = res.gio_tot_xaus;
            if (times) {
                let good = "";
                for (let i = 0; i < times.length; i++) {
                    let item = times[i];
                    "T" == item.type && (good += item.time + ", ")
                }
                good = good.substr(0, good.length - 2),
                    $("#lvn-ngay-tot").text(good),
                    $("#lvn-ngay-tot-right").text(good)
            }
            let dateFromApi = `${res.solar_month}/${res.solar_day}/${res.solar_year}`
                , formatDate = new Date(dateFromApi)
                , dateCurrent = new Date;
            formatDate.getDate() === dateCurrent.getDate() && formatDate.getMonth() === dateCurrent.getMonth() && formatDate.getFullYear() === dateCurrent.getFullYear() ? $("#txt-today").removeClass("d-none") : $("#txt-today").addClass("d-none")
        }
    }
    ))
}
function initThongKeCanXuongScreen() {
    $("#btn-thong-ke-can-xuong").on("click", (function () {
        const year = $("#TKCX-year").val()
            , month = $("#TKCX-month").val()
            , day = $("#TKCX-day").val()
            , hour = $("#TKCX-hour").val()
            , order = $("#TKCX-order").val();
        let link = `thong-ke-can-xuong-${year}-${month}-${day}-${hour}-${order}`;
        window.location.href = link
    }
    )),
        loadThongKeCanXuong()
}
function loadThongKeCanXuong() {
    var container = $("#pagination-tkcx")
        , totalNumber = parseInt($("#list-result-thong-ke").attr("data-total-number"))
        , order = $("#TKCX-order").val()
        , day = $("#TKCX-day").val()
        , month = $("#TKCX-month").val()
        , year = parseInt($("#TKCX-year").val())
        , hour = $("#TKCX-hour").val()
        , url = `${APIs.others.canXuong}?year=${year}&month=${month}&day=${day}&hour=${hour}&order=${order}`;
    console.log(url),
        container.pagination({
            dataSource: url,
            locator: "data.edges",
            totalNumber: totalNumber,
            pageSize: 20,
            showPageNumbers: !0,
            showPrevious: !0,
            showNext: !0,
            showFirstOnEllipsisShow: !0,
            showLastOnEllipsisShow: !0,
            ajax: {},
            callback: function (response, pagination) {
                if (response) {
                    const listThongKe = response
                        , container = $("#list-result-thong-ke");
                    container.empty();
                    const header = '<tr class="txt-content-bold bg-background">\n                                <td>Năm</td>\n                                <td>Tháng</td>\n                                <td>Ngày</td>\n                                <td>Giờ</td>\n                                <td>Điểm cân xương</td>\n                            </tr>';
                    container.html(header),
                        listThongKe.forEach((function (item) {
                            const obj = {
                                item: item
                            };
                            var tmpl = $("#tkcxTable").tmpl(obj);
                            container.append(tmpl)
                        }
                        ))
                } else
                    console.log("ERROR: NO DATA", response)
            }
        })
}
function initBadGoodDayScreen() {
    $("#sb-xem-ngay-tot-xau").on("click", (function () {
        const form = $("#form-ngay-tot-xau")
            , filter = $('select[name="filter"]').val()
            , month = $('select[name="month"]').val()
            , year = $('select[name="year"]').val();
        window.location.href = `/xem-ngay-tot-xau-thang-${month}-nam-${year}?filter=${filter}`
    }
    ))
}
function initThuVienTuViScreen() {
    const totalPage = parseInt($("#info-page-knowledge").attr("data-total-page"))
        , currentPage = parseInt($("#info-page-knowledge").attr("data-current-page"))
        , category = $("#info-page-knowledge").attr("data-category");
    console.log(category);
    let link = "/category/";
    "" != category ? link += category : link = "/thu-vien-tu-vi";
    let arrPage = [];
    if (totalPage > 0 && currentPage <= totalPage) {
        if (totalPage < 5)
            arrPage = Array.from(new Array(totalPage), (x, i) => i + 1);
        else if (currentPage <= 4)
            arrPage = Array.from(new Array(5), (x, i) => i + 1);
        else if (currentPage >= totalPage - 1)
            for (let i = totalPage - 4; i < totalPage + 1; i++)
                arrPage.push(i);
        else
            arrPage = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
        const containerPaging = $("#knowledge-pagination");
        let elementsPaging = [];
        if (currentPage > 1) {
            let backpage, back = '\n                                <li class="page-item pagination-previous">\n                                <a href=" ' + link + "?page=" + (currentPage - 1) + ' ">\n                                    <span class="page-link txt-sub-content color-content" aria-label="Previous">\n                                        <span aria-hidden="true"><</span>\n                                        <span class="sr-only">Previous</span>\n                                    </span>\n                                    </a>\n                                </li>\n                             ';
            elementsPaging.push(back)
        }
        if (arrPage.forEach((function (item) {
            let active, ele = '\n                                <li class="page-item pagination-item-sc ' + (item == currentPage ? "active" : "") + ' " data-page=" + item + ">\n                                <a href=" ' + link + "?page=" + item + `">\n                                        <span class="page-link txt-sub-content color-content"> ${item} </span>\n                                        </a>\n                                </li>\n                            `;
            elementsPaging.push(ele)
        }
        )),
            currentPage < totalPage) {
            let nextpage, next = '\n                                <li class="page-item pagination-next">\n                                <a href=" ' + link + "?page=" + (currentPage + 1) + '">\n                                    <span class="page-link txt-sub-content color-content" aria-label="Next">\n                                        <span aria-hidden="true">></span>\n                                        <span class="sr-only">Next</span>\n                                    </span>\n                                    </a>\n                                </li>\n                             ';
            elementsPaging.push(next)
        }
        containerPaging.html(elementsPaging)
    }
    function searchCategories() {
        const textSearch = $("#text-search-category").val()
            , url = `${APIs.categories.get}?page=1&limit=20&search=${textSearch}`;
        Agents.get(url, (function (res) {
            if (200 == res.code) {
                const data = res.data
                    , container = $("#list-category")
                    , active = "" == textSearch ? " current" : ""
                    , list = ['<a href="/thu-vien-tu-vi">\n                        <div class="category' + active + '">\n                            <span>Tất cả bài viết</span>\n                        </div>\n                    </a>']
                    , categories = data.edges;
                container.empty(),
                    categories && categories.length > 0 ? (categories.forEach((function (cat) {
                        const temp = '<a href="/thu-vien-tu-vi?category=' + cat.slug + '">\n                            <div class="category">\n                                <span>' + cat.name + "</span>\n                            </div>\n                        </a>";
                        list.push(temp)
                    }
                    )),
                        container.html(list)) : container.html("<p>Không tìm thấy kết quả</p>")
            } else
                container.html("<p>Có lỗi xảy ra!</p>")
        }
        ), (function (err) {
            console.log("ERROR: ", err)
        }
        ))
    }
    $("#text-search-category").keypress((function (event) {
        var keycode;
        "13" == (event.keyCode ? event.keyCode : event.which) && searchCategories()
    }
    )),
        $("#btn-search-category").on("click", (function () {
            searchCategories()
        }
        ))
}
function initSystemReportScreen() {
    function onSubmit(token) {
        let response = grecaptcha.getResponse();
        return 0 !== response.length && response
    }
    $("#spinnerReportSystem").hide(),
        $("#imgReportSystem").on("change", (function () {
            "" != this.value ? $("#defaultTxtImage").text(this.value.split("\\").pop()) : $("#defaultTxtImage").text("URL image")
        }
        )),
        $("#btnSystemReport").on("click", (function (e) {
            let name = $("#nameReporter").val().trim()
                , email = $("#emailReporter").val().trim()
                , error_id = parseInt($("#errorId").val())
                , content = $("#contentReporter").val()
                , token = ""
                , paramFalse = !1;
            if (validateName(name) ? $("#nameReporter").css("border", "solid 1px var(--border-color)") : ($("#nameReporter").css("border", "2.5px solid yellow"),
                paramFalse = !0),
                validateEmail(email) ? $("#emailReporter").css("border", "solid 1px var(--border-color)") : ($("#emailReporter").css("border", "2.5px solid yellow"),
                    paramFalse = !0),
                validateAddress(content) ? $("#contentReporter").css("border", "solid 1px var(--border-color)") : ($("#contentReporter").css("border", "2.5px solid yellow"),
                    paramFalse = !0),
                onSubmit() ? token = onSubmit() : paramFalse = !0,
                paramFalse)
                $("#titleMes").text("Lưu ý!!"),
                    $("#contentMes").text("Tín chủ cần điền đầy đủ, chính xác thông tin và xác nhận mã captcha. Các thông tin sai hoặc thiếu đã được bôi vàng. Vui lòng kiểm tra lại");
            else {
                const input = document.querySelector("#imgReportSystem")
                    , curFiles = input.files
                    , form_data = new FormData;
                form_data.append("name", name),
                    form_data.append("email", email),
                    form_data.append("title_id", error_id),
                    form_data.append("content", content),
                    form_data.append("captcha", token);
                for (const file of curFiles)
                    file || ($("#titleMes").text("Lưu ý!!"),
                        $("#contentMes").text("Upload ảnh không thành công!! Tín chủ vui lòng thử lại.")),
                        form_data.append("file", file);
                Agents.upload(APIs.others.systemReport, Agents.methods.POST, form_data, (function (res) {
                    res && 200 == res.code ? ($("#titleMes").text("Phản hồi thành công"),
                        $("#contentMes").text("Phản hồi của tín chủ đã được gửi đi thành công. Tuvi.vn cảm ơn tín chủ đã góp ý!"),
                        $("#contentMes").append('<br/><br/><a style="font-size: 14px" href="/"><< Trở về trang chủ</a>'),
                        $("#nameReporter").val(""),
                        $("#emailReporter").val(""),
                        $("#errorId").val(1),
                        $("#contentReporter").val(""),
                        $("#imgReportSystem").val(""),
                        $("#defaultTxtImage").text("URL image"),
                        grecaptcha.reset()) : (console.log("ERROR: ", res.msg),
                            $("#titleMes").text("Phản hồi không thành công"),
                            $("#contentMes").text("Phản hồi của tín chủ chưa được gửi thành công!"),
                            grecaptcha.reset())
                }
                ), (function (err) {
                    console.log("ERROR: ", err),
                        $("#titleMes").text("Phản hồi không thành công"),
                        $("#contentMes").text("Phản hồi của tín chủ chưa được gửi thành công!"),
                        grecaptcha.reset()
                }
                ))
            }
        }
        ))
}
function eventOnFocusInput() {
    let htmls = [];
    const container = $("#listMaster");
    let input = $("#nameMaster").val().toLowerCase()
        , url = "" != input ? `${APIs.master.get}?search=${input}` : APIs.master.get;
    console.log("HIEPPPPBBB: ", url),
        container.empty(),
        htmls = [],
        Agents.get(url, (function (res) {
            const listMaster = res.data.data || [];
            listMaster.length ? (listMaster.forEach((function (item) {
                let name = item.name || ""
                    , rankId = item.rank_id || 1
                    , rank = item.rank || null
                    , rankTitle = rank ? rank.title : ""
                    , username = item.username || ""
                    , avatar = item.avatar || "/public/images/avatars/avt-default.jpg";
                1 == rankId ? htmls.push(`<li data-item-master class="item-master" name="itemMaster" data-id-master="${item.id}">\n                            <img class="cmt-avt" src="${avatar}">\n                            <div data-item-master class="d-flex flex-column">\n                            <span class="txt-content-mid" data-item-master name="nameMaster">${name}</span>\n                            <span class="txt-sub-content text-secondary" data-item-master name="username">@${username}</span>\n                           </div>\n                     </li>`) : htmls.push(`<li data-item-master class="item-master" name="itemMaster" data-id-master="${item.id}">\n                            <img class="cmt-avt" src="${avatar}">\n                            <div data-item-master class="d-flex flex-column">\n                            <span class="txt-content-mid" data-item-master name="nameMaster">${name}</span>\n                            <span class="txt-sub-content text-secondary" data-item-master name="username">@${username}</span>\n                            <div data-item-master class="d-inline-flex align-items-center m-t-5">\n                                <div data-item-master class="user-medal-rank user-medal-rank-${rankId} zoom-half mr-2"></div>\n                                <span data-item-master class="user-title-rank-${rankId}">${rankTitle}</span>\n                            </div>\n                           </div>\n                     </li>`)
            }
            )),
                container.html(htmls),
                container.append("<script>$('li.item-master').on('click', function(event) {\n                            event.stopImmediatePropagation();\n                        let nameSpans = $(this).find('span[name=nameMaster]');\n                        let nameMaster = $(nameSpans[0]).text()\n                        let idMaster = $(this).attr('data-id-master') || 0;\n                        $('#nameMaster').val(nameMaster);\n                        $('#nameMaster').attr('data-id-master-selected', idMaster)\n                        $('#listMaster').addClass('d-none')\n                        $('#nameMaster').attr('disabled', true)\n                        $('#delInput').removeAttr('hidden')\n                    }) \n                    $(window).on('mousedown', function(event) {\n                      let target = $(event.target).attr('data-item-master')\n                      if(typeof target !== 'undefined' && target !== false){\n                           $('#nameMaster').off('blur')\n                      } else {\n                          $('#nameMaster').on('blur', function() {\n                            $('#listMaster').empty();\n                            $('#listMaster').addClass('d-none');\n                          })\n                      }\n                    })\n                        <\/script>"),
                container.removeClass("d-none"),
                $("#nameMaster").attr("")) : (container.html('<div class="text-center">Không có kết quả tìm kiếm</div>'),
                    container.removeClass("d-none"))
        }
        ), (function (error) {
            console.log("ERROR: ", error)
        }
        ))
}
function searchMaster() {
    var delayTimer;
    $("#delInput").on("click", (function () {
        $("#nameMaster").val(""),
            $("#delInput").attr("hidden", !0),
            $("#nameMaster").removeAttr("data-id-master-selected"),
            $("#nameMaster").removeAttr("disabled"),
            $("#nameMaster").attr("placeholder", "Nhập tên thầy...")
    }
    )),
        $("#nameMaster").on("focusin", (function () {
            let idMaster;
            $("#nameMaster").attr("data-id-master-selected") || eventOnFocusInput(),
                $("#nameMaster").on("keyup", (function () {
                    $("#listMaster").html('<div class="w-100 text-center"><div class="spinner-border " role="status"><span class="sr-only">Loading...</span></div></div>'),
                        clearTimeout(delayTimer),
                        delayTimer = setTimeout((function () {
                            eventOnFocusInput()
                        }
                        ), 700)
                }
                ))
        }
        ))
}
function initCountdownClock() {
    $("#clock-c").countdown("2024/02/10", (function (event) {
        var $this = $(this).html(event.strftime('<span class="h1 font-weight-bold">%D</span> Ngày<span class="h1 font-weight-bold">%H</span> Giờ<span class="h1 font-weight-bold">%M</span> Phút<span class="h1 font-weight-bold">%S</span> Giây'))
    }
    ))
}
function initLasoScreen(path) {
    console.log("Init detail la so"),
        pushLaSoToHistory(path),
        loadLaSoHistory(),
        searchMaster(),
        checkAnSao();
    for (var suggestPrice = parseInt($("#body-detail-laso").attr("data-suggest-price")), searchEles = document.getElementsByClassName("cung"), id = 0, i = 0; i < searchEles.length; i++) {
        const a = searchEles[i].childNodes[1].childNodes[1].childNodes[1].childNodes[3].childNodes[1];
        a.innerHTML.trim().includes("Mệnh") && (id = parseInt($(searchEles[i]).attr("data-cung-full-id")))
    }
    function checkAnSao() {
        $("#click-an-sao-luu-dai-van").is(":checked") || $("*[data-name*=sao-tot-xau]").each((function () {
            var btn = $(this);
            let text = btn.text() || "";
            text = text.trim(),
                text.startsWith("ĐV.") && btn.addClass("d-none")
        }
        )),
            $("#click-an-sao-luu-tu-duc").is(":checked") || $("*[data-name*=sao-tot-xau]").each((function () {
                var btn = $(this);
                let text = btn.text() || "";
                text = text.trim(),
                    "L.Nguyệt Đức" != text && "L.Thiên Đức" != text && "L.Phúc Đức" != text && "L.Long Đức" != text || btn.addClass("d-none")
            }
            ))
    }
    function setLaSoSize() {
        var windowWidth = $(window).width()
            , height = "250px";
        $("#click-tu-hoa-phai").is(":checked") ? height = "340px" : ($("#click-an-sao-luu-dai-van").is(":checked") || $("#click-an-sao-luu-tu-duc").is(":checked")) && (height = "295px"),
            $(".cung").css("height", height),
            $(".cung-view").css("height", height),
            windowWidth < 769 && $("#content-la-so").css("height", $("#table-la-so")[0].getBoundingClientRect().height)
    }
    $(".view-con-giap-la-so").addClass(`list-line-${id}`),
        $(".cung").hover((function () {
            handlerHoverLaSo(this, "")
        }
        ), (function () {
            handlerUnHoverLaSo(this, "")
        }
        )),
        $(".view-item-suggest").on("click", (function (e) {
            $(".view-item-suggest").removeClass("active-item-suggest");
            const cung = $(this).attr("data-cung");
            console.log("cung", cung);
            const loaded = $(this).attr("data-loaded");
            if ("dai-van" == cung)
                goToByScroll("binh-giai-dai-van");
            else if ("tieu-van" == cung)
                goToByScroll("binh-giai-tieu-van");
            else {
                const paramSearch = getParamSearch(cung);
                e.preventDefault();
                const parent = $("#cung-" + cung)
                    , loaded = parent.attr("data-loaded");
                inActiveTab(),
                    activeTab("#cung-" + cung),
                    goToByScroll("cung-" + cung);
                let container = $("#cung-" + cung + " div.detail-binh-giai-12-cung");
                "false" == loaded && (container.empty(),
                    container.html('\n                      <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    '),
                    loadLuanGiai(paramSearch, (function (res) {
                        if ("200" == res.code) {
                            const data = res.data;
                            handlerLoadLG(parent, container, data)
                        }
                    }
                    )))
            }
            $(this).addClass("active-item-suggest")
        }
        )),
        $("#muc-luc-12-cung").on("click", (function () {
            $("#list-12-cung-muc-luc").toggleClass("d-none"),
                $("#muc-luc-12-cung > .icon-up").toggleClass("turn-up")
        }
        )),
        $("#muc-luc #muc-luc-item").on("click", (function (e) {
            const cung = $(this).attr("data-cung");
            if (cung)
                if ("dai-van" == cung)
                    goToByScroll("binh-giai-dai-van");
                else if ("tieu-van" == cung)
                    goToByScroll("binh-giai-tieu-van");
                else if ("tong-quan" == cung)
                    goToByScroll("binh-giai-tong-quan");
                else {
                    let cung = $(this).attr("data-cung"), than = "", isCungThan = !1, paramSearch;
                    if ("than" == cung) {
                        var c = $('span[data-cung="than"]'), p, first = $(c.parent()).children()[0];
                        than = $(first).attr("data-cung"),
                            isCungThan = !0
                    }
                    paramSearch = getParamSearch(isCungThan ? than : cung, isCungThan),
                        e.preventDefault();
                    const parent = $("#cung-" + cung)
                        , loaded = parent.attr("data-loaded");
                    inActiveTab(),
                        activeTab("#cung-" + cung),
                        goToByScroll("cung-" + cung);
                    let container = $("#cung-" + cung + " div.detail-binh-giai-12-cung");
                    "false" == loaded && (container.empty(),
                        container.html('\n                            <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    '),
                        loadLuanGiai(paramSearch, (function (res) {
                            if ("200" == res.code) {
                                const data = res.data;
                                handlerLoadLG(parent, container, data)
                            }
                        }
                        )))
                }
        }
        )),
        $("#table-binh-giai-dai-van > tbody > tr > td").on("click", (function () {
            handlerClickBinhGiaiDaiVan($(this), $("#list-binh-giai-dai-van"))
        }
        )),
        $("#binh-giai-tieu-van > tbody > tr > td").on("click", (function () {
            handlerClickBinhGiaiTieuVan($(this), $("#list-binh-giai-tieu-van"))
        }
        )),
        $("#binh-giai-12-cung-content > div.cung-data").on("click", (function (e) {
            handlerClickBinhGiai12Cung($(this), e)
        }
        )),
        $(".text-sao-chinh-tinh").click((function (e) {
            "block" == $("#modal-la-so").css("display") ? handlerClickTextSaoChinhTinh($(this), e, "#modal-la-so > div.modal-content > div.luan-giai-modal > div#binh-giai-12-cung > div#binh-giai-12-cung-content > ", !0) : handlerClickTextSaoChinhTinh($(this), e, "")
        }
        )),
        $("#xemCungChieu").click((function () {
            1 == $("#xemCungChieu").is(":checked") ? $(".cung").hover((function () {
                handlerHoverLaSo(this, "")
            }
            ), (function () {
                handlerUnHoverLaSo(this, "")
            }
            )) : $(".cung").off("mouseenter mouseleave")
        }
        )),
        $(".text-dai-van-number").click((function () {
            "block" == $("#modal-la-so").css("display") ? handlerClickDaiVanNumber($(this), $("#modal-la-so > div.modal-content > div.luan-giai-modal > div#binh-giai-dai-van > div.binh-giai-dai-van-content > div#list-binh-giai-dai-van"), $("#modal-la-so > div.modal-content > div.luan-giai-modal > div#binh-giai-dai-van > div.binh-giai-dai-van-content > table > tbody > tr > td"), !0, $("#modal-la-so > div.modal-content > div.luan-giai-modal > div#binh-giai-dai-van")) : handlerClickDaiVanNumber($(this), $("#list-binh-giai-dai-van"), $("#table-binh-giai-dai-van > tbody > tr > td"), !1, $("#binh-giai-dai-van"))
        }
        )),
        $("#click-Cung-Sao2").click((function () {
            1 == $("#click-Cung-Sao2").is(":checked") ? ($(".text-sao-chinh-tinh").removeClass("event-click-sao"),
                $(".text-dai-van-number").removeClass("event-click-sao")) : ($(".text-sao-chinh-tinh").addClass("event-click-sao"),
                    $(".text-dai-van-number").addClass("event-click-sao"))
        }
        )),
        $("#xemCungChieu").prop("checked", !0),
        $("#click-tu-hoa-phai").click((function () {
            1 == $("#click-tu-hoa-phai").is(":checked") ? $(".cung-middle-tu-hoa-phai").css("display", "block") : $(".cung-middle-tu-hoa-phai").css("display", "none"),
                setLaSoSize()
        }
        )),
        $("#click-an-sao-luu-dai-van").click((function () {
            1 == $("#click-an-sao-luu-dai-van").is(":checked") ? $("*[data-name*=sao-tot-xau]").each((function () {
                var btn = $(this);
                let text = btn.text() || "";
                text = text.trim(),
                    text.startsWith("ĐV.") && btn.removeClass("d-none")
            }
            )) : $("*[data-name*=sao-tot-xau]").each((function () {
                var btn = $(this);
                let text = btn.text() || "";
                text = text.trim(),
                    text.startsWith("ĐV.") && btn.addClass("d-none")
            }
            )),
                setLaSoSize()
        }
        )),
        $("#click-an-sao-luu-tu-duc").click((function () {
            1 == $("#click-an-sao-luu-tu-duc").is(":checked") ? $("*[data-name*=sao-tot-xau]").each((function () {
                var btn = $(this);
                let text = btn.text() || "";
                text = text.trim(),
                    "L.Nguyệt Đức" != text && "L.Thiên Đức" != text && "L.Phúc Đức" != text && "L.Long Đức" != text || btn.removeClass("d-none")
            }
            )) : $("*[data-name*=sao-tot-xau]").each((function () {
                var btn = $(this);
                let text = btn.text() || "";
                text = text.trim(),
                    "L.Nguyệt Đức" != text && "L.Thiên Đức" != text && "L.Phúc Đức" != text && "L.Long Đức" != text || btn.addClass("d-none")
            }
            )),
                setLaSoSize()
        }
        )),
        $("#laSoDenTrang, #laSoDenTrang2").click((function () {
            $(".table-la-so").addClass("la-so-den-trang"),
                $("#note-la-so").addClass("note-la-so-none")
        }
        )),
        $("#laSoMau, #laSoMau2").click((function () {
            $(".table-la-so").removeClass("la-so-den-trang"),
                $("#note-la-so").removeClass("note-la-so-none")
        }
        )),
        $("#print-la-so").on("click", (function () {
            const name = $(this).attr("data-name");
            var divContents = $("#content-la-so").html()
                , printWindow = window.open("", "", "height=700,width=900");
            printWindow.document.write("<html><head><title>" + name + "</title>"),
                printWindow.document.write('<link rel="stylesheet" href="/public/css/main.css" type="text/css"/>'),
                printWindow.document.write('<link rel="stylesheet" href="/public/css/bootstrap.min.css" type="text/css"/>'),
                printWindow.document.write("</head><body>"),
                printWindow.document.write(divContents),
                printWindow.document.write("</body></html>"),
                printWindow.document.close(),
                printWindow.onload = function () {
                    printWindow.focus(),
                        printWindow.print()
                }
        }
        )),
        $("#print-la-so-den-trang").on("click", (function () {
            const name = $(this).attr("data-name");
            var divContents = $("#content-la-so").html()
                , printWindow = window.open("", "", "height=700,width=900");
            printWindow.document.write("<html><head><title>" + name + "</title>"),
                printWindow.document.write("<style>*{-webkit-filter: grayscale(100%); \n  filter: grayscale(100%);}</style>"),
                printWindow.document.write('<link rel="stylesheet" href="/public/css/main.css" type="text/css"/>'),
                printWindow.document.write('<link rel="stylesheet" href="/public/css/bootstrap.min.css" type="text/css"/>'),
                printWindow.document.write("</head><body>"),
                printWindow.document.write(divContents),
                printWindow.document.write("</body></html>"),
                printWindow.document.close(),
                printWindow.onload = function () {
                    printWindow.focus(),
                        printWindow.print()
                }
        }
        ));
    const MAX_SAO_IN_BLOCK = 8;
    function addViewMoreSpecialCase() {
        const saoTot = $(".sao-tot");
        saoTot && saoTot.each((function () {
            const container = $(this)
                , sao = container.find("div");
            if (sao.length > 8) {
                container.empty();
                for (let index = 0; index < 7; index++)
                    container.append(sao[index]);
                var moreSao = $(sao[7]).text();
                for (let index = 8; index < sao.length; index++)
                    moreSao += "\n" + $(sao[index]).text();
                container.append(`<div class="txt-tiny text-sao-xau-tot more_info" title="${moreSao}">Xem thêm...</div>`)
            }
        }
        ));
        const saoXau = $(".sao-xau");
        saoXau && saoXau.each((function () {
            const container = $(this)
                , sao = container.find("div");
            if (sao.length > 8) {
                container.empty();
                for (let index = 0; index < 7; index++)
                    container.append(sao[index]);
                var moreSao = $(sao[7]).text();
                for (let index = 8; index < sao.length; index++)
                    moreSao += "\n" + $(sao[index]).text();
                container.append(`<div class="txt-tiny text-sao-xau-tot more_info" title="${moreSao}">Xem thêm...</div>`)
            }
        }
        ))
    }
    $("#viewMonth3,#inputYear").change((function () {
        console.log("this", $(this).attr("name"));
        const nameEle = $(this).attr("name")
            , dataLaSo = $("#table-la-so")
            , dataHour = parseInt(dataLaSo.attr("data-hour"))
            , dataDay = parseInt(dataLaSo.attr("data-day"))
            , dataMonth = parseInt(dataLaSo.attr("data-month"))
            , dataYear = parseInt(dataLaSo.attr("data-year"))
            , tuHoaPhaiVal = parseInt($("#tuHoaPhaiSelect").val());
        let dataThangXem, dataNamXem;
        "year" == nameEle ? (dataThangXem = parseInt(dataLaSo.attr("data-month-see")),
            dataNamXem = parseInt($(this).val())) : (dataThangXem = parseInt($(this).val()),
                dataNamXem = parseInt(dataLaSo.attr("data-year-see")));
        let dataGender = dataLaSo.attr("data-gender");
        if (dataGender = "M" == dataGender,
            dataHour && dataDay && dataMonth && dataYear && dataThangXem && dataNamXem && tuHoaPhaiVal) {
            const param = {
                hour_id: dataHour,
                day: dataDay,
                month: dataMonth,
                year: dataYear,
                male: dataGender,
                solar_calendar: !0,
                thang_xem: dataThangXem,
                nam_xem: dataNamXem,
                tu_hoa_phai_mode: tuHoaPhaiVal || 0
            };
            console.log("data day", param),
                loadNamXem(param, (function (res) {
                    if (res && res.code && "200" == res.code) {
                        dataLaSo.attr("data-month-see", dataThangXem),
                            dataLaSo.attr("data-year-see", dataNamXem);
                        const data = res.data;
                        console.log("data", data.cung_model),
                            $("*[data-name*=sao-tot-xau]").each((function () {
                                var btn = $(this);
                                let text = btn.text() || "";
                                text = text.trim(),
                                    (text.startsWith("L.") || text.startsWith("Hóa") || text.startsWith("ĐV.")) && btn.remove()
                            }
                            )),
                            $("*[class*=cung-middle-tu-hoa-phai]").each((function () {
                                $(this).empty()
                            }
                            )),
                            $("#current-time-full").text(data.current_time_full),
                            data && data.cung_model && data.cung_model.forEach((item, index) => {
                                item && ($(`#LN${item.id}`).text(item.luu_nien),
                                    $(`#KNH${item.id}`).text(item.khoi_nguyet_han),
                                    $(`#DVT${item.id}`).text(item.dai_van_text),
                                    item && item.sao && item.sao.forEach((i, idx) => {
                                        i.sao && ("H" == i.sao.status ? i.sao.is_special ? $(`#sao-xau-${item.id}`).append(`<div class="font-weight-bold txt-tiny-bold text-sao-xau-tot" \ndata-sao-id="${i.sao.id}" data-name="sao-tot-xau" \nstyle="color: ${i.sao.color_code}">\n${i.sao.name} ${i.do_sang && i.do_sang.abbr ? `(${i.do_sang.abbr})` : ""}\n</div>`) : $(`#sao-xau-${item.id}`).append(`<div class="txt-tiny text-sao-xau-tot" \ndata-sao-id="${i.sao.id}" data-name="sao-tot-xau" \nstyle="color: ${i.sao.color_code}">\n${i.sao.name} ${i.do_sang && i.do_sang.abbr ? `(${i.do_sang.abbr})` : ""}\n</div>`) : i.sao.is_special ? $(`#sao-tot-${item.id}`).append(`<div class="font-weight-bold txt-tiny-bold text-sao-xau-tot" \ndata-sao-id="${i.sao.id}" data-name="sao-tot-xau" \nstyle="color: ${i.sao.color_code}">\n${i.sao.name} ${i.do_sang && i.do_sang.abbr ? `(${i.do_sang.abbr})` : ""}\n</div>`) : $(`#sao-tot-${item.id}`).append(`<div class="txt-tiny text-sao-xau-tot" \ndata-sao-id="${i.sao.id}" data-name="sao-tot-xau" \nstyle="color: ${i.sao.color_code}">\n${i.sao.name} ${i.do_sang && i.do_sang.abbr ? `(${i.do_sang.abbr})` : ""}\n</div>`))
                                    }
                                    ),
                                    item && item.tu_hoa_phais && item.tu_hoa_phais.forEach((i, idx) => {
                                        i.cung && i.sao && (i.cung == item.cung.name ? $(`#THP${item.id}`).append(`<p class="txt-tiny mb-0 font-italic"\n                                                           style="color: ${i.sao.color_code}"><span\n                                                                    class="color-highlight">Tự</span> ${i.sao.name}\n                                                        </p>`) : $(`#THP${item.id}`).append(`<p class="txt-tiny mb-0 font-italic"><span\n                                                                    style="color: ${i.sao.color_code}">${i.sao.name}</span>\n                                                            - ${i.cung}</p>`))
                                    }
                                    ))
                            }
                            ),
                            checkAnSao()
                    } else
                        console.log("a1", res),
                            alert("Năm xem không hợp lệ")
                }
                ))
        } else
            console.log("a2"),
                alert("Vui lòng nhập thông tin")
    }
    )),
        $("#tuHoaPhaiSelect").on("change", (function (e) {
            var tableLaSo = document.getElementById("table-la-so");
            $("#inputYear").trigger("change"),
                tableLaSo.scrollIntoView({
                    behavior: "smooth",
                    inline: "start"
                })
        }
        )),
        $("#next-year,#previous-year").click((function () {
            var tableLaSo = document.getElementById("table-la-so");
            const name = $(this).attr("name");
            if (name && "next" == name) {
                const year = $("#inputYear").val();
                year && year > 0 && ($("#inputYear").val(parseInt(year) + 1),
                    $("#inputYear").trigger("change"),
                    tableLaSo.scrollIntoView({
                        behavior: "smooth",
                        inline: "start"
                    }))
            } else {
                const year = $("#inputYear").val();
                year && year > 0 && ($("#inputYear").val(parseInt(year) - 1),
                    $("#inputYear").trigger("change"),
                    tableLaSo.scrollIntoView({
                        behavior: "smooth",
                        inline: "start"
                    }))
            }
        }
        )),
        $("#next-month,#previous-month").click((function () {
            var tableLaSo = document.getElementById("table-la-so");
            const name = $(this).attr("name");
            if (name && "next" == name) {
                const month = $("#viewMonth3").val();
                month && month > 0 && month < 12 && ($("#viewMonth3").val(parseInt(month) + 1),
                    $("#viewMonth3").trigger("change"),
                    tableLaSo.scrollIntoView({
                        behavior: "smooth",
                        inline: "start"
                    }))
            } else {
                const month = $("#viewMonth3").val();
                month && month > 1 && ($("#viewMonth3").val(parseInt(month) - 1),
                    $("#viewMonth3").trigger("change"),
                    tableLaSo.scrollIntoView({
                        behavior: "smooth",
                        inline: "start"
                    }))
            }
        }
        )),
        $("#image-la-so").on("click", (function () {
            if (isMobile())
                return $("#la-so-anh-tab").click(),
                    void $("html, body").animate({
                        scrollTop: $("#laso-tab").offset().top
                    }, 1e3);
            const current = $(this);
            current.empty(),
                current.html('<div class="d-flex justify-content-center align-items-center" style="width: 74px">\n                        <div class="spinner-border spinner-border-sm" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                     </div>');
            var name = current.attr("data-name"), tableLaSo;
            const newTableDownload = $("#table-la-so").clone().appendTo("#file-hinh-clone");
            newTableDownload.css("top", ""),
                newTableDownload.css("-webkit-transform", "scale(2)"),
                newTableDownload.css("-webkit-transform-origin", "0%");
            const height = newTableDownload[0].getBoundingClientRect().height
                , width = newTableDownload[0].getBoundingClientRect().width;
            html2canvas(newTableDownload[0], {
                scale: 2,
                windowWidth: width,
                windowHeight: height
            }).then(canvas => {
                var imgageData = canvas.toDataURL("image/png")
                    , a = document.createElement("a")
                    , newData = imgageData.replace(/^data:image\/png/, "data:application/octet-stream");
                a.href = newData,
                    a.download = name + ".png",
                    a.click(),
                    current.html('<i class="ic-FileDownloadOutlined h5 mb-0 mr-1"></i> Tải lá số'),
                    $("#file-hinh-clone").html("")
            }
            )
        }
        )),
        $("#view-full-screen").click((function (e) {
            $("#modal-la-so").css("display", "block"),
                $("body").css("overflow", "hidden");
            const containerLaSo = $("#table-la-so");
            $("#la-so-modal").html(containerLaSo);
            var height = $(window).height();
            containerLaSo.css("transform", `scale(${(height + 150) / $("#table-la-so")[0].getBoundingClientRect().height}) translate(0%)`),
                containerLaSo.css("transform-origin", "50% 0"),
                containerLaSo.css("left", "0");
            const containerTongQuan = $("#binh-giai-tong-quan")
                , container12Cung = $("#binh-giai-12-cung")
                , containerDaiVan = $("#binh-giai-dai-van")
                , containerTieuVan = $("#binh-giai-tieu-van");
            $("#luan-giai-modal").append(containerTongQuan, container12Cung, containerDaiVan, containerTieuVan)
        }
        )),
        $("#shareLaso").on("click", (function () {
            var url, iFrame = '<iframe src="https://tuvi.vn/share/iframe/' + window.location.pathname.substring(1) + '" frameBorder="0" width="500" height="775" title="Lá số tử vi"/>';
            console.log(iFrame)
        }
        )),
        $("#share-la-so-content button.btn-copy").on("click", (function () {
            console.log("click copy");
            const parent = $(this).parent();
            if (parent) {
                const input = parent.find("input");
                input && ($(input).select(),
                    document.execCommand("copy"))
            }
        }
        )),
        $("#share-ls-fb").on("click", (function () {
            var winTop = screen.height / 2 - 260
                , winLeft = screen.width / 2 - 175
                , url = window.location.href;
            window.open("http://www.facebook.com/sharer.php?s=100&p[url]=" + url, "top=" + winTop + ",left=" + winLeft + ",toolbar=0,status=0,width=520,height=350")
        }
        )),
        $(".viewChoLaSo").on("click", (function () {
            window.location.href = "/cho-la-so"
        }
        ));
    let listImage = [];
    $(".pushChoLaSo").on("click", (function (event) {
        if (isLogged()) {
            const tieuVanTopic = $("select[name=yearTieuVan]")
                , yob = tieuVanTopic.attr("data-yob");
            if (parseInt(tieuVanTopic.val())) {
                var tuoiTieuVan = parseInt(tieuVanTopic.val()) - parseInt(yob) + 1;
                $("#tuoiTieuVan").text(tuoiTieuVan),
                    $(".topic-select-tieu-van").removeClass("w-100")
            } else
                $("#descriptionTieuVan").addClass("d-none"),
                    $(".topic-select-tieu-van").addClass("w-100");
            tieuVanTopic.on("change", (function () {
                if (parseInt(tieuVanTopic.val())) {
                    var tuoiTieuVan = parseInt(tieuVanTopic.val()) - parseInt(yob) + 1;
                    $("#tuoiTieuVan").text(tuoiTieuVan),
                        $("#descriptionTieuVan").removeClass("d-none"),
                        $(".topic-select-tieu-van").removeClass("w-100")
                } else
                    $("#descriptionTieuVan").addClass("d-none"),
                        $(".topic-select-tieu-van").addClass("w-100")
            }
            )),
                $("#yearOfTieuVan2Res").select2({
                    dropdownParent: $("#modalPushLaSo")
                });
            const inputTitleTopic = $("#inputTitleTopic");
            inputTitleTopic.on("keydown", (function (e) {
                13 == e.keyCode && e.preventDefault()
            }
            )),
                inputTitleTopic.on("keyup", (function (e) {
                    const count = $(this).val().length;
                    $("#titleCountCharacter").text(count + "/500")
                }
                )),
                $("#namePro").select2({
                    dropdownParent: $("#modalPushLaSo")
                }),
                $("#modalPushLaSo").modal("show"),
                $("#imgPushLaSo").on("change", (function () {
                    listImg = [],
                        listImage = imagesPreview(this, "div.gallery")
                }
                ));
            var listTagActive = $("#list-tag-topic > .category.current");
            listTagActive && checkSuggestPriceCurrent(listTagActive, $("#color-green-la-so"), suggestPrice)
        } else
            openModalLogin(event)
    }
    ));
    var defaultIdTag = [];
    const tags = $("#list-tag-topic").find("div");
    $(tags[0]).on("click", (function () {
        tags.removeClass("current"),
            $(this).addClass("current")
    }
    ));
    for (var i = 1; i < tags.length; i++)
        defaultIdTag.push(parseInt($(tags[i]).attr("data-id-tag"))),
            $(tags[i]).on("click", (function () {
                $(tags[0]).removeClass("current"),
                    $(this).hasClass("current") ? $(this).removeClass("current") : $(this).addClass("current");
                const activeTag = $("#list-tag-topic").find(".current");
                activeTag.length == tags.length - 1 && (tags.removeClass("current"),
                    $(tags[0]).addClass("current")),
                    checkSuggestPriceCurrent(activeTag, $("#color-green-la-so"), suggestPrice)
            }
            ));
    $("#formPushLaSo").on("submit", (function (event) {
        if ($(this).find("button").attr("disabled", !0),
            isLogged()) {
            event.preventDefault();
            const name = $("#name-la-so").text() || ""
                , errEle = $(this).find("div[id=errorForm]");
            var title = $(this).find("textarea[id=inputTitleTopic]").val() || "";
            title = title.trim();
            const idLaso = parseInt($(this).find("input[name=idLaso]").val())
                , budget = parseFloat($(this).find("select[name=budget]").val())
                , tags = $("#list-tag-topic").find("div.category.current")
                , tieuVan = "0" !== $(this).find("select[name=yearTieuVan]").val() ? "Tiểu vận " + $(this).find("select[name=yearTieuVan]").val() + " (" + $(this).find("#descriptionTieuVan").text() + ")" : ""
                , daiVan = "0" !== $(this).find("select[name=yearsDaiVan]").val() ? $(this).find("select[name=yearsDaiVan]").val() : ""
                , idMaster = "" !== $("#nameMaster").attr("data-id-master-selected") ? parseInt($("#nameMaster").attr("data-id-master-selected")) : 0
                , privacy = $("#check-privacy-topic").is(":checked");
            var selectedTags = [];
            if (1 == tags.length && "0" == $(tags[0]).attr("data-id-tag"))
                selectedTags = defaultIdTag;
            else
                for (var i = 0; i < tags.length; i++)
                    selectedTags.push(parseInt($(tags[i]).attr("data-id-tag")));
            if (0 == selectedTags.length)
                $(errEle).text("Chọn tối thiểu 1 chủ đề"),
                    blinkMe(errEle),
                    $("#formPushLaSo").find("button").attr("disabled", !1);
            else if (title.length < 3 || title.length > 500)
                $(this).find("textarea[id=inputTitleTopic]").val(title),
                    $("#titleCountCharacter").text(title.length + "/500"),
                    $(errEle).text("Tiêu đề là bắt buộc và có độ dài từ 3-500 ký tự"),
                    blinkMe(errEle),
                    $("#formPushLaSo").find("button").attr("disabled", !1);
            else {
                const url = `${DOMAIN}/markets/topics`
                    , params = {
                        title: title,
                        budget: budget,
                        la_so_id: idLaso,
                        tags: selectedTags,
                        dai_van: daiVan,
                        tieu_van: tieuVan,
                        name: name,
                        privacy: privacy ? 2 : 1
                    };
                function callbackPushLaSoWhenError(error) {
                    $("#formPushLaSo").find("button").attr("disabled", !1);
                    const err = error.responseJSON
                        , uri = window.location
                        , previous = encodeURIComponent(uri);
                    "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                        blinkMe(errEle)),
                        "600001005" == err.code && ($(errEle).html(`<span>Số lượt đăng lá số lên chợ có giới hạn. <a href='/payment?previous=${previous}'>Nâng cấp</a> lên  <span class="txt-sub-content-mid">Tài khoản VIP</span> để nhận thêm lượt</span>`),
                            blinkMe(errEle)),
                        "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                            blinkMe(errEle))
                }
                idMaster && (params.masters = [{
                    id: idMaster
                }]),
                    listImg && listImg.length ? ($(errEle).html("<span>Xin đợi trong lúc tải hình của bạn lên</span>"),
                        Promise.all([uploadImgTopic(listImg)]).then((function (res) {
                            if ($(errEle).empty(),
                                res && res.length) {
                                let images = res[0].images || []
                                    , mediaId = images.length ? images[0].id : 0;
                                mediaId && (params.media = mediaId),
                                    Agents.post(url, params, (function (response) {
                                        if ("200" == response.code) {
                                            console.log("push top: ", response.data.slug);
                                            const topicId = response.data.slug;
                                            window.location.href = "/" + topicId
                                        }
                                    }
                                    ), error => callbackPushLaSoWhenError(error))
                            }
                        }
                        ), (function (err) {
                            console.log("ERR UPLOAD IMAGE", err),
                                $(errEle).html("<span>Lỗi quá trình tải ảnh, hãy chọn ảnh khác và thử lại</span>"),
                                blinkMe(errEle),
                                $("#formPushLaSo").find("button").attr("disabled", !1)
                        }
                        ))) : Agents.post(url, params, (function (response) {
                            if ("200" == response.code) {
                                console.log("push top: ", response.data.slug);
                                const topicId = response.data.slug;
                                window.location.href = "/" + topicId
                            }
                        }
                        ), error => callbackPushLaSoWhenError(error))
            }
        } else
            event.preventDefault(),
                openModalLogin(event),
                $(this).find("button").attr("disabled", !0);
        const tenThay = $(this).find("select[name=getPro]").val();
        console.log("ten thay: ", tenThay)
    }
    ))
}
var listImg = []
    , hasUpload = !1;
function imagesPreview(input, placeToInsertImagePreview) {
    if (input.files) {
        let filesAmount = input.files.length;
        for (let i = 0; i < filesAmount; i++) {
            var reader = new FileReader;
            reader.onload = function (event) {
                const src = event.target.result
                    , newImage = `<div class="d-flex list-file-img-container list-image-comment-1 flex-wrap"><div class="view-image-comment"><img class="image-comment-upload" src="${src}"><div id="btnDeleteImgCreateTopic" class="cursor-pointer delete-image-comment"><div class="total-icon icon-delete-image-topic"></div></div></div></div>`;
                $("div.gallery").empty(),
                    $(placeToInsertImagePreview).append(newImage),
                    $("#btnDeleteImgCreateTopic").click((function () {
                        $("div.gallery").empty(),
                            listImg = [],
                            hasUpload = !0,
                            $(input).val("")
                    }
                    ))
            }
                ,
                reader.readAsDataURL(input.files[i]),
                listImg.push(input.files[i])
        }
        return listImg
    }
}
function uploadImgTopic(files) {
    return new Promise((function (resolve, reject) {
        files && files.length > 0 ? uploadImgToServer(files, (function (res) {
            res && "200" == res.code && resolve({
                images: res.data
            })
        }
        )) : reject({
            images: []
        })
    }
    ))
}
function uploadImgToServer(fileInput, callBack) {
    var form = new FormData;
    fileInput && fileInput.forEach(item => {
        form.append("files", item, item.name)
    }
    );
    var settings = {
        url: APIs.media.upload,
        method: "POST",
        timeout: 0,
        headers: {
            "X-TU-VI": getToken()
        },
        processData: !1,
        mimeType: "multipart/form-data",
        contentType: !1,
        data: form
    };
    $.ajax(settings).done((function (response) {
        var res = JSON.parse(response);
        callBack(res)
    }
    ))
}
function pushLaSoToHistory(path) {
    let anDuong = $("#dia-ban").attr("data-gender"), namSinhText = $("#dia-ban").attr("data-nam-sinh"), namSinhNumber = $("#dia-ban").attr("data-nam-sinh-number"), amDuongText;
    amDuongText = anDuong.includes("Nam") ? "Nam mệnh" : "Nữ mệnh";
    let tuoi = namSinhNumber.split(" ");
    const infoLaSo = `${amDuongText} - ${namSinhText} - ${namSinhNumber}`;
    let cucLaSo = $("#dia-ban").attr("data-cuc").split("(")
        , banMenh = $("#dia-ban").attr("data-menh");
    const cucMenh = `${banMenh} - ${cucLaSo[0]}`
        , newLaSo = {
            dateCreate: new Date
        };
    let menh = banMenh.split(" ");
    $("#name-la-so").text() ? newLaSo.name = $("#name-la-so").text() : newLaSo.name = "Lập Lá Số Tử Vi",
        infoLaSo && (newLaSo.info = infoLaSo),
        tuoi && (newLaSo.tuoi = tuoi[1]),
        menh && (newLaSo.menh = menh[menh.length - 1]),
        cucMenh && (newLaSo.cucMenh = cucMenh),
        path && (newLaSo.path = path),
        $("#luong-la-so").text() && (newLaSo.canLuong = $("#luong-la-so").text());
    try {
        let listUrl = JSON.parse(localStorage.getItem("history"));
        listUrl && listUrl.length > 0 ? (listUrl.length > 6 && listUrl.splice(1, 1),
            listUrl.push(newLaSo),
            localStorage.setItem("history", JSON.stringify(listUrl))) : localStorage.setItem("history", JSON.stringify([newLaSo]))
    } catch (e) {
        22 !== e.code && 1024 !== e.code || console.log("Quota exceeded!")
    }
}
function loadLaSoHistory() {
    try {
        const history = JSON.parse(localStorage.getItem("history"));
        history && history.length > 0 && $.map(history.reverse(), (function (item, index) {
            if (index < 6 && index > 0) {
                item.timeSince = sinceTime(item.dateCreate);
                const obj = {
                    item: item
                };
                var tmpl = $("#laSoCardMini").tmpl(obj);
                $("#la-so-created").append(tmpl)
            }
        }
        ))
    } catch (e) {
        22 !== e.code && 1024 !== e.code || console.log("Quota exceeded!")
    }
}
function resizeLaSo() {
    var width = $(window).width();
    const content = $("#content-la-so")
        , table = $("#table-la-so");
    if (width < 769) {
        if (table.css("-webkit-transform", `scale(${(width - 20) / 748}) translateX(-50%)`),
            table.css("-webkit-transform-origin", "0% 0"),
            table.length > 0) {
            const first = table.get(0);
            content.css("height", first.getBoundingClientRect().height),
                content.css("position", "relative"),
                table.css("position", "absolute"),
                table.css("top", "0"),
                table.css("left", "50%")
        }
        "block" == $("#modal-detail-topic").css("display") ? $("#close-modal-detail-topic").click() : "block" == $("#modal-la-so").css("display") && $("#close-modal-la-so").click()
    } else
        "block" != $("#modal-detail-topic").css("display") && "block" != $("#modal-la-so").css("display") && (table.removeAttr("style"),
            content.removeAttr("style"));
    width >= 768 && width < 1024 ? $(".item-la-so").removeClass("col-6") : $(".item-la-so").addClass("col-6");
    const containerRes = $("#setting-la-so-responsive")
        , containerRight = $(".right-content");
    if (width < 769) {
        if (0 === containerRes.find("#setting-la-so").length) {
            const settingLaSo = $("#setting-la-so");
            containerRes.append(settingLaSo)
        }
    } else if ("block" != $("#modal-detail-topic").css("display") && 0 === containerRight.find("#setting-la-so").length) {
        const settingLaSo = $("#setting-la-so");
        containerRight.prepend(settingLaSo)
    }
}
function inActiveTab() {
    let parent = $("#binh-giai-12-cung-content > div");
    for (var i = 0; i < parent.length; i++) {
        let text = parent[i].querySelector(" div.view-header-follow-la-so.m-b-5 > div:nth-child(2) > span")
            , icon = parent[i].querySelector(" div.view-header-follow-la-so.m-b-5 > div:nth-child(2) > div")
            , content = parent[i].querySelector(".detail-binh-giai-12-cung");
        text.textContent = "Xem chi tiết",
            $(content).removeClass("show-detail-item-12-cung"),
            $(icon).removeClass("turn-up")
    }
}
function activeTab(id) {
    const parent = $(id);
    let text = parent[0].querySelector(" div.view-header-follow-la-so.m-b-5 > div:nth-child(2) > span")
        , icon = parent[0].querySelector(" div.view-header-follow-la-so.m-b-5 > div:nth-child(2) > div")
        , content = parent[0].querySelector("div.detail-binh-giai-12-cung");
    text.textContent = "Thu gọn",
        $(content).addClass("show-detail-item-12-cung"),
        $(icon).addClass("turn-up")
}
function loadLuanGiai(param, success) {
    var settings = {
        url: APIs.laSo.luanGiai,
        method: "POST",
        timeout: 0,
        headers: {
            "Content-Type": "application/json"
        },
        data: JSON.stringify(param)
    };
    $.ajax(settings).done((function (response) {
        success(response)
    }
    ))
}
function handlerLoadLG(parent, container, data) {
    container.empty();
    let htmls = [];
    if (data && data.length > 0)
        for (let i = 0; i < data.length; i++) {
            let item = data[i]
                , title = item.title || ""
                , content = item.content || ""
                , source = "";
            item.luan_giai_source && (source = item.luan_giai_source.name || ""),
                htmls.push('<div class="m-b-10">\n                                            <p class="m-b-10 txt-content-bold color-title">' + title + '</p>\n                                            <p class="m-b-10 txt-content">' + content + '</p>\n                                            <p class="mb-0 text-author-binh-giai">' + source + "</p>\n                                       </div>\n                                    ")
        }
    else
        htmls.push('<h6 class="text-center">Chưa có dữ liệu</h6>');
    parent && parent.attr("data-loaded", "true"),
        container.html(htmls)
}
function handlerClickBinhGiaiDaiVan(data, contain) {
    const current = data
        , text = current.text();
    if (text) {
        $("#table-binh-giai-dai-van > tbody > tr > td").removeClass("active-binh-giai-dai-van"),
            data.addClass("active-binh-giai-dai-van");
        const container = contain;
        container.empty(),
            container.html('\n                            <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    ');
        let t, split, daiVan = text.trim().toLowerCase().replace("đại vận", "").replace("tuổi", "").trim().split("-")[0];
        const cungEl = $(`td[data-dai-van="${daiVan}"]`)
            , att = $(cungEl[0]).attr("id")
            , searchParam = getParamSearch(att.replace("parent-", ""));
        searchParam.type = "DAI-VAN",
            loadLuanGiai(searchParam, (function (res) {
                if ("200" == res.code) {
                    const data = res.data;
                    handlerLoadLG(null, container, data)
                } else
                    container.html('<h6 class="text-center">Chưa có dữ liệu</h6>')
            }
            ))
    }
}
function handlerClickBinhGiaiTieuVan(data, contain) {
    const current = data
        , text = current.text();
    if (text) {
        $("#binh-giai-tieu-van > tbody > tr > td").removeClass("active-binh-giai-dai-van"),
            data.addClass("active-binh-giai-dai-van");
        const container = contain;
        container.empty(),
            container.html('\n                            <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    ');
        const cungEl = $('td[data-luu-nien="LN.MỆNH"]')
            , att = $(cungEl[0]).attr("id")
            , searchParam = getParamSearch(att.replace("parent-", ""));
        searchParam.type = "VAN-NAM",
            container.html('<h6 class="text-center">Chưa có dữ liệu</h6>')
    }
}
function handlerClickBinhGiai12Cung(data, e) {
    console.log("data: ", data, e),
        e.preventDefault();
    const a = data.offset().top;
    console.log("a", a),
        $("html,body").animate({
            scrollTop: a - 40
        }, "slow");
    const parent = data
        , loaded = parent.attr("data-loaded");
    let text = parent[0].querySelector(" div.view-header-follow-la-so.m-b-5 > div:nth-child(2) > span")
        , icon = parent[0].querySelector(" div.view-header-follow-la-so.m-b-5 > div:nth-child(2) > div")
        , content = parent[0].querySelector("div.detail-binh-giai-12-cung");
    "Thu gọn" == text.textContent ? text.textContent = "Xem chi tiết" : text.textContent = "Thu gọn",
        $(content).toggleClass("show-detail-item-12-cung"),
        $(icon).toggleClass("turn-up");
    var cung = parent.attr("id");
    let than = "", isCungThan = !1, nCung = cung.replace("cung-", ""), paramSearch;
    if ("than" == nCung) {
        var c = $('span[data-cung="than"]')
            , p = $(c.parent());
        console.log(p);
        var first = p.children()[0];
        than = $(first).attr("data-cung"),
            isCungThan = !0
    }
    paramSearch = getParamSearch(isCungThan ? than : nCung, isCungThan);
    let container = $("#" + cung + " div.detail-binh-giai-12-cung");
    "false" == loaded && (container.empty(),
        container.html('\n                            <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    '),
        loadLuanGiai(paramSearch, (function (res) {
            if ("200" == res.code) {
                const data = res.data;
                handlerLoadLG(parent, container, data)
            } else
                container.html('<h6 class="text-center">Chưa có dữ liệu</h6>')
        }
        )))
}
function handlerHoverLaSo(data, contain) {
    if ($(".view-con-giap-la-so").css("display", "none"),
        $(".view-con-giap-la-so-hover").css("display", "block"),
        $(`${contain} #list-line-la-so-hover`).removeAttr("class"),
        data && data.childNodes.length < 6) {
        var idHover = parseInt($(data).attr("data-cung-full-id"));
        $(`${contain} #list-line-la-so-hover`).addClass("view-con-giap-la-so-hover"),
            $(`${contain} #list-line-la-so-hover`).addClass(`list-line-${idHover}`);
        var idHoverNumber1 = idHover;
        if (idHover > 3 && idHover < 8)
            var idHoverNumber2 = idHover - 4
                , idHoverNumber3 = idHover + 4;
        else if (idHover > 7)
            var idHoverNumber2 = idHover - 4
                , idHoverNumber3 = idHover - 8;
        else
            var idHoverNumber2 = idHover + 4
                , idHoverNumber3 = idHover + 8;
        if (idHover > 5)
            var idHoverNumber4 = idHover - 6;
        else
            var idHoverNumber4 = idHover + 6;
        if (0 == idHover || 6 == idHover)
            var idHoverNumber5 = idHover + 1;
        else if (1 == idHover || 7 == idHover)
            var idHoverNumber5 = idHover - 1;
        else if (2 == idHover)
            var idHoverNumber5 = idHover + 9;
        else if (11 == idHover)
            var idHoverNumber5 = idHover - 9;
        else if (3 == idHover)
            var idHoverNumber5 = idHover + 7;
        else if (10 == idHover)
            var idHoverNumber5 = idHover - 7;
        else if (4 == idHover)
            var idHoverNumber5 = idHover + 5;
        else if (9 == idHover)
            var idHoverNumber5 = idHover - 5;
        else if (5 == idHover)
            var idHoverNumber5 = idHover + 3;
        else
            var idHoverNumber5 = idHover - 3;
        for (let i = 0; i < 12; i++)
            i == idHoverNumber1 || i == idHoverNumber2 || i == idHoverNumber3 || i == idHoverNumber4 || i == idHoverNumber5 ? $(contain + "#cung" + i).addClass("cung-view-hover") : $(contain + "#cung" + i).addClass("none-cung-view-hover")
    }
}
function handlerUnHoverLaSo(data, contain) {
    if ($(`${contain} #list-line-la-so-hover`).css("display", "none"),
        $(`${contain} #list-line-la-so`).css("display", "block"),
        data && data.childNodes.length < 6) {
        var idHover = parseInt($(data).attr("data-cung-full-id"))
            , idHoverNumber1 = idHover;
        if (idHover > 3 && idHover < 8)
            var idHoverNumber2 = idHover - 4
                , idHoverNumber3 = idHover + 4;
        else if (idHover > 7)
            var idHoverNumber2 = idHover - 4
                , idHoverNumber3 = idHover - 8;
        else
            var idHoverNumber2 = idHover + 4
                , idHoverNumber3 = idHover + 8;
        if (idHover > 5)
            var idHoverNumber4 = idHover - 6;
        else
            var idHoverNumber4 = idHover + 6;
        if (0 == idHover || 6 == idHover)
            var idHoverNumber5 = idHover + 1;
        else if (1 == idHover || 7 == idHover)
            var idHoverNumber5 = idHover - 1;
        else if (2 == idHover)
            var idHoverNumber5 = idHover + 9;
        else if (11 == idHover)
            var idHoverNumber5 = idHover - 9;
        else if (3 == idHover)
            var idHoverNumber5 = idHover + 7;
        else if (10 == idHover)
            var idHoverNumber5 = idHover - 7;
        else if (4 == idHover)
            var idHoverNumber5 = idHover + 5;
        else if (9 == idHover)
            var idHoverNumber5 = idHover - 5;
        else if (5 == idHover)
            var idHoverNumber5 = idHover + 3;
        else
            var idHoverNumber5 = idHover - 3;
        for (let i = 0; i < 12; i++)
            i == idHoverNumber1 || i == idHoverNumber2 || i == idHoverNumber3 || i == idHoverNumber4 || i == idHoverNumber5 ? $(contain + "#cung" + i).removeClass("cung-view-hover") : $(contain + "#cung" + i).removeClass("none-cung-view-hover")
    }
}
function handlerClickTextSaoChinhTinh(data, e, contain, isModal) {
    let cung = data.attr("data-cung"), than = "", isCungThan = !1, paramSearch;
    if (console.log("aa", cung),
        "than" == cung) {
        var parent, first = $(data.parent()).children()[0];
        than = $(first).attr("data-cung"),
            isCungThan = !0
    }
    if (paramSearch = getParamSearch(isCungThan ? than : cung, isCungThan),
        "dai-van" == cung)
        goToByScroll("binh-giai-dai-van");
    else if ("tieu-van" == cung)
        goToByScroll("binh-giai-tieu-van");
    else {
        e.preventDefault();
        const parent = $("#cung-" + cung)
            , loaded = parent.attr("data-loaded");
        inActiveTab(),
            activeTab(contain + "#cung-" + cung);
        let a = $(contain + "#cung-" + cung).offset().top;
        if (console.log("cung name a", $(contain + "#cung-" + cung)),
            isModal) {
            let position = $(contain + "#cung-" + cung)[0].offsetTop;
            $("#luan-giai-modal").animate({
                scrollTop: position
            }, "slow")
        } else
            $("html,body").animate({
                scrollTop: a - 5
            }, "slow");
        let container = $(contain + "#cung-" + cung + " div.detail-binh-giai-12-cung");
        "false" == loaded && (container.empty(),
            container.html('\n                      <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    '),
            loadLuanGiai(paramSearch, (function (res) {
                if ("200" == res.code) {
                    console.log("zo 2", container);
                    const data = res.data;
                    handlerLoadLG(parent, container, data)
                }
            }
            )))
    }
}
function handlerClickDaiVanNumber(data, contain, item, isModal, binhGiaiDaiVan) {
    const current = data
        , text = current.text()
        , dvInt = parseInt(text);
    if (text) {
        $("#table-binh-giai-dai-van > tbody > tr > td").removeClass("active-binh-giai-dai-van");
        let items = item;
        for (let i = 0; i < items.length; i++) {
            let item = items[i], text, t, split = $(item).text().trim().toLowerCase().replace("đại vận", "").replace("tuổi", "").trim().split("-"), min = parseInt(split[0]), max = parseInt(split[1]);
            if (dvInt >= min && dvInt < max) {
                $(item).addClass("active-binh-giai-dai-van");
                break
            }
        }
        const container = contain;
        container.empty(),
            container.html('\n                            <div class="spinner-border" role="status" style="margin: auto 50%">\n                              <span class="sr-only">Loading...</span>\n                            </div>\n                    ');
        let a = binhGiaiDaiVan.offset().top;
        if (isModal) {
            let position = binhGiaiDaiVan[0].offsetTop;
            $("#luan-giai-modal").animate({
                scrollTop: position
            }, "slow")
        } else
            $("html,body").animate({
                scrollTop: a - 5
            }, "slow");
        const cungEl = $(`td[data-dai-van="${dvInt}"]`)
            , att = $(cungEl[0]).attr("id")
            , searchParam = getParamSearch(att.replace("parent-", ""));
        searchParam.type = "DAI-VAN",
            loadLuanGiai(searchParam, (function (res) {
                if ("200" == res.code) {
                    const data = res.data;
                    handlerLoadLG(null, container, data)
                }
            }
            ))
    }
}
function loadNamXem(param, success) {
    var settings = {
        url: APIs.laSo.luuNien,
        method: "POST",
        timeout: 0,
        headers: {
            "Content-Type": "application/json"
        },
        data: JSON.stringify(param)
    };
    $.ajax(settings).done((function (response) {
        success(response)
    }
    ))
}
function getDataFromCung(cung) {
    const cungRoot = $("#parent-" + cung)
        , chiId = cungRoot.attr("data-chi")
        , cungId = cungRoot.attr("data-cung-id")
        , saoIds = []
        , chinhTinh = cungRoot.find("p.text-chinh-chinh");
    for (let i = 0; i < chinhTinh.length; i++) {
        let item = chinhTinh[i];
        const saoId = $(item).attr("data-sao-id");
        saoIds.push({
            id: parseInt(saoId)
        })
    }
    const saoTot = cungRoot.find("div.sao-tot > div");
    for (let i = 0; i < saoTot.length; i++) {
        let item = saoTot[i];
        const saoId = $(item).attr("data-sao-id");
        saoIds.push({
            id: parseInt(saoId)
        })
    }
    const saoXau = cungRoot.find("div.sao-xau > div");
    for (let i = 0; i < saoXau.length; i++) {
        let item = saoXau[i];
        const saoId = $(item).attr("data-sao-id");
        saoIds.push({
            id: parseInt(saoId)
        })
    }
    var data;
    return {
        cung_id: parseInt(cungId),
        chi_id: parseInt(chiId),
        saos: saoIds
    }
}
function findCungTapHop(cungName) {
    return "menh" == cungName ? ["quan-loc", "tai-bach"] : "huynh-de" == cungName ? ["dien-trach", "tat-ach"] : "phu-the" == cungName ? ["phuc-duc", "thien-di"] : "tu-tuc" == cungName ? ["phu-mau", "no-boc"] : "tai-bach" == cungName ? ["menh", "quan-loc"] : "tat-ach" == cungName ? ["huynh-de", "dien-trach"] : "thien-di" == cungName ? ["phuc-duc", "thien-di"] : "no-boc" == cungName ? ["phu-mau", "tu-tuc"] : "quan-loc" == cungName ? ["menh", "tai-bach"] : "dien-trach" == cungName ? ["huynh-de", "tat-ach"] : "phuc-duc" == cungName ? ["phu-the", "thien-di"] : "phu-mau" == cungName ? ["tu-tuc", "no-boc"] : void 0
}
function findCungChieu(cungName) {
    return "menh" == cungName ? "thien-di" : "huynh-de" == cungName ? "no-boc" : "phu-the" == cungName ? "quan-loc" : "tu-tuc" == cungName ? "dien-trach" : "tai-bach" == cungName ? "phuc-duc" : "tat-ach" == cungName ? "phu-mau" : "thien-di" == cungName ? "menh" : "no-boc" == cungName ? "huynh-de" : "quan-loc" == cungName ? "phu-the" : "dien-trach" == cungName ? "tu-tuc" : "phuc-duc" == cungName ? "tai-bach" : "phu-mau" == cungName ? "tat-ach" : void 0
}
function findNhiHop(cung) {
    const cungRoot = $("#parent-" + cung)
        , chiId = cungRoot.attr("data-cung-full-id");
    var chiNH = 0;
    0 == chiId ? chiNH = 1 : 1 == chiId ? chiNH = 0 : 2 == chiId ? chiNH = 11 : 11 == chiId ? chiNH = 2 : 3 == chiId ? chiNH = 10 : 10 == chiId ? chiNH = 3 : 4 == chiId ? chiNH = 9 : 9 == chiId ? chiNH = 4 : 5 == chiId ? chiNH = 8 : 8 == chiId ? chiNH = 5 : 6 == chiId ? chiNH = 7 : 7 == chiId && (chiNH = 6);
    var cungParent = $('#table-la-so td[data-cung-full-id="' + chiNH + '"]');
    if (cungParent) {
        var cungName = cungParent.attr("id");
        return getDataFromCung(cungName = cungName.replace("parent-", ""))
    }
}
function getParamSearch(cung, isCungThan) {
    var main = getDataFromCung(cung);
    isCungThan && (main.cung_id = 50);
    var cungChieu, chieu = getDataFromCung(findCungChieu(cung)), tamHop = findCungTapHop(cung), th_left = getDataFromCung(tamHop[0]), th_right, nhiHop;
    const paramSearch = {
        main: main,
        type: "CUNG",
        th_right: getDataFromCung(tamHop[1]),
        th_left: th_left,
        nhi_hop: findNhiHop(cung),
        chieu: chieu
    };
    return paramSearch
}
function initLoginScreen() {
    $('input[name="password"]').on("change", (function () {
        const pass = $(this).val();
        Validate.password(pass) ? $("#errPass").text("") : $("#errPass").text("Mật khẩu độ dài 6-30 ký tự và không có cách trống")
    }
    )),
        $('input[name="re_password"]').on("change", (function () {
            const rePass = $(this).val()
                , pass = $('input[name="password"]').val().trim();
            pass != rePass ? $("#errRePass").text("Not match the Password!") : $("#errRePass").text("")
        }
        )),
        $("#formLogin").on("submit", (function (event) {
            $(this).find("button").attr("disabled", !0);
            const email = $(this).find('input[name="email"]').val().trim()
                , pass = $(this).find('input[name="password"]').val().trim();
            email && validateEmail(email) && pass && validatePassword(pass) ? console.log("validate OK") : ($("#errPass").text("Sai định dạng Email hoặc Password"),
                event.preventDefault(),
                $(this).find("button").attr("disabled", !1))
        }
        ))
}
function initRegisterScreen() {
    $("#formRegister").on("submit", (function (event) {
        $("#btnRegister").attr("disabled", !0);
        const name = $(this).find('input[name="name"]').val().trim()
            , email = $(this).find('input[name="email"]').val().trim()
            , pass = $(this).find('input[name="password"]').val().trim()
            , rePass = $(this).find('input[name="re_password"]').val().trim();
        Validate.email(email) ? email.length > 320 ? ($("#errEmail").text("Email ít hơn 320 ký tự"),
            event.preventDefault(),
            $("#btnRegister").attr("disabled", !0)) : $("#errEmail").text("") : ($("#errEmail").text("Email không đúng định dạng"),
                event.preventDefault(),
                $("#btnRegister").attr("disabled", !0)),
            Validate.name(name) ? $("#errName").text("") : ($("#errName").text("Tên có độ dài 3-50 ký tự không được chứa số hoặc ký tự đặc biệt"),
                event.preventDefault(),
                $("#btnRegister").attr("disabled", !1)),
            Validate.password(pass) ? $("#errPass").text("") : ($("#errPass").text("Mật khẩu độ dài từ 6-30 ký tự và không có cách trống"),
                event.preventDefault(),
                $("#btnRegister").attr("disabled", !1)),
            pass != rePass ? ($("#errRePass").text("Không trùng mật khẩu"),
                event.preventDefault(),
                $("#btnRegister").attr("disabled", !1)) : $("#errRePass").text("")
    }
    )),
        $('input[name="password"]').on("change", (function () {
            const pass = $(this).val();
            Validate.password(pass) ? $("#errPass").text("") : $("#errPass").text("Mật khẩu độ dài từ 6-30 ký tự và không có cách trống")
        }
        )),
        $('input[name="re_password"]').on("change", (function () {
            const rePass = $(this).val()
                , pass = $('input[name="password"]').val().trim();
            Validate.password(rePass) ? pass != rePass ? $("#errRePass").text("Không trùng mật khẩu") : $("#errRePass").text("") : $("#errRePass").text("Mật khẩu độ dài từ 6-30 ký tự và không có cách trống")
        }
        ))
}
function initForgotPassword() {
    $("#formRequestToken").on("submit", (function (event) {
        event.preventDefault(),
            $(this).find("button").attr("disabled", !0);
        const email = $(this).find('input[name="email"]').val().trim();
        if (email)
            if (Validate.email(email) && email.length <= 320) {
                console.log(email),
                    $("#errEmail").text("");
                const param = {
                    email: email
                };
                Agents.post(APIs.auth.forgotPassword, param, (function (response) {
                    console.log("send email ok change pass pls"),
                        console.log(response),
                        "200" == response.code ? ($("#formRequestToken").empty(),
                            $("#formRequestToken").html("<span>Yêu cầu gửi thành công! Kiểm tra email để thay đổi mật khẩu mới</span>")) : $("#errEmail").text("Email không tồn tại, thử lại email khác"),
                        $("#formRequestToken").find("button").attr("disabled", !1)
                }
                ), (function (err) {
                    const res = err.responseJSON;
                    console.log(err),
                        res ? ("500001016" == res.code ? $("#errEmail").text("Chưa xác thực email này, hãy truy cập email để xác thực") : $("#errEmail").text("Email không tồn tại, thử lại email khác"),
                            $("#formRequestToken").find("button").attr("disabled", !1)) : window.location.href = "/404"
                }
                ))
            } else
                $("#errEmail").text("Sai định dạng Email"),
                    $(this).find("button").attr("disabled", !1);
        else
            $("#errEmail").text("Email là trường bắt buộc"),
                $(this).find("button").attr("disabled", !1)
    }
    )),
        $("#formRequestNewPass").on("submit", (function (event) {
            event.preventDefault(),
                $(this).find("button").attr("disabled", !0);
            const token = $(this).find('input[name="token"]').val().trim()
                , password = $(this).find('input[name="password"]').val().trim()
                , rePass = $(this).find('input[name="re_password"]').val().trim();
            if (token && password && rePass)
                if (Validate.password(password) && Validate.password(rePass))
                    if (password === rePass) {
                        const param = {
                            token: token,
                            new_password_1: password,
                            new_password_2: rePass
                        };
                        Agents.post(APIs.auth.changeForgotPassword, param, (function (response) {
                            console.log(response),
                                "200" == response.code ? window.location.href = "/login?message=changePassSuccess" : window.location.href = "/404",
                                $("#formRequestNewPass").find("button").attr("disabled", !1)
                        }
                        ), (function (err) {
                            const res = err.responseJSON;
                            "500001012" == res.msg ? (console.log(res),
                                $("#formRequestNewPass").empty(),
                                $("#formRequestNewPass").html('<div>Yêu cầu đã hết hạn, vui lòng <a href="/forgot-password">gửi lại</a> yêu cầu khác hoặc <a href="/login">đăng nhập</a> để tiếp tục</div>')) : window.location.href = "/404"
                        }
                        ))
                    } else
                        $("#errRePass").text("Nhập lại mật khẩu không khớp"),
                            $(this).find("button").attr("disabled", !1);
                else
                    $("#errPass").text("Mật khẩu độ dài từ 6-30 ký tự và không có cách trống"),
                        $(this).find("button").attr("disabled", !1);
            else
                $("#errPass").text("Mật khẩu độ dài từ 6-30 ký tự và không có cách trống"),
                    $(this).find("button").attr("disabled", !1)
        }
        ))
}
function initProfileGuestScreen() {
    const userId = $("input[name=userId]").val() || "";
    function loadTopics(page) {
        const limit = 6
            , container = $("#topicsContainer");
        container.empty();
        for (let i = 0; i < 6; i++)
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>');
        Agents.get(`${APIs.markets.masterTopics}?limit=6&page=${page}&user=${userId}`, (function (res) {
            if (res) {
                const data = res.data;
                data && setTimeout((function () {
                    const total = data.total_count || 0
                        , totalPage = data.total_page || 0
                        , currentPage = data.page || 1;
                    $("#total-topics").html(`Hiện có ${total} lá số`);
                    const items = data.data || [];
                    container.empty(),
                        $("#topics-pagination").css("display", "none"),
                        items.length ? (items.forEach((function (item) {
                            const topicId = (item = topicItemHandler(item)).id || 0
                                , card = $("#cardTopicMarket").tmpl(item);
                            card.appendTo("#topicsContainer");
                            const user = item.user
                                , isThay = user && user.is_thay;
                            item && item.media && item.media.path && $(`a#${topicId} .topic-picture-preview`).append(`<img class="topic-picture lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${item.media.path}" alt="topicPicture">`),
                                isThay && $(`a#${topicId} .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="professorIc">');
                            var tagContainer = $(`a#${topicId} > div.list-tag`);
                            tagContainer && 1 == tagContainer.length && (tagContainer = tagContainer[0]);
                            const tags = item.tags || [];
                            if (tags.length > 0)
                                for (let i = 0; i < tags.length; i++) {
                                    const tagItem = tags[i]
                                        , idTag = tagItem.id || 0
                                        , iconTag = getIconTagTopic(idTag)
                                        , child = $(iconTag);
                                    var div = $("<div class='small-tag'></div>");
                                    div.html(child),
                                        $(tagContainer).find(".tag-container").append(div)
                                }
                            else
                                $(tagContainer).addClass("d-none"),
                                    $(tagContainer).empty();
                            var viewUserContainer = $(`a#${topicId} .list-view-user`)
                                , viewUsers = item.view_users || []
                                , totalViewUsers = item.total_view_user || 0;
                            if (totalViewUsers > 0) {
                                const maxUser = 5 == totalViewUsers ? 5 : totalViewUsers > 5 ? 4 : totalViewUsers;
                                for (let i = 0; i < maxUser; i++) {
                                    const user = viewUsers[i];
                                    var avatar = user ? user.avatar : "";
                                    avatar && "" != avatar || (avatar = "/public/images/avatars/avt-default.jpg");
                                    const name = user ? user.name : "";
                                    var img = $(`<img class="la-so-avt-activity lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${avatar}" title="${name}">`);
                                    $(viewUserContainer).append(img)
                                }
                                if (totalViewUsers > 5) {
                                    let moreUser = totalViewUsers - 4 > 99 ? 99 : totalViewUsers - 4;
                                    const more = $('<div class="la-so-preview-activity-more txt-sub-content"></div>').text(`+${moreUser}`);
                                    $(viewUserContainer).append(more)
                                }
                            }
                        }
                        )),
                            items && items.length && showPageHandler(totalPage, currentPage, "topics-pagination"),
                            initSaveTopic(),
                            $(".lazy").lazy()) : container.append('<div class="text-center">Không có kết quả tìm kiếm</div>')
                }
                ), 100)
            }
        }
        ))
    }
    function showPageHandler(totalPage, currentPage, container) {
        var arrPage = [];
        if (totalPage > 0 && currentPage <= totalPage) {
            if (totalPage < 5)
                arrPage = Array.from(new Array(totalPage), (x, i) => i + 1);
            else if (currentPage <= 4)
                arrPage = Array.from(new Array(5), (x, i) => i + 1);
            else if (currentPage >= totalPage - 1)
                for (var i = totalPage - 4; i < totalPage + 1; i++)
                    arrPage.push(i);
            else
                arrPage = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
            var containerPaging = $(`#${container}`)
                , elementsPaging = [];
            if (currentPage > 1) {
                var backpage, back = `<li class="paginationjs-prev" data-page="${currentPage - 1}"><a class="cursor-pointer" >«</a></li>`;
                elementsPaging.push(back)
            } else {
                var back = '\n                                    <li class="paginationjs-prev disabled">\n                                     <a class="cursor-pointer">«</a>\n                                    </li>\n                                 ';
                elementsPaging.push(back)
            }
            if (arrPage.forEach((function (item) {
                var active, ele = `\n                                    <li class="paginationjs-page J-paginationjs-page ${item == currentPage ? "active" : ""}" data-page="${item}">\n                                          <a class="cursor-pointer">${item}</a>\n                                    </li>\n                                `;
                elementsPaging.push(ele)
            }
            )),
                currentPage < totalPage) {
                var nextpage, next = `\n                                    <li class="paginationjs-next" data-page="${currentPage + 1}">\n                                    <a class="cursor-pointer" >»</a>\n                                    </li>\n                                 `;
                elementsPaging.push(next)
            } else {
                var next = '\n                                    <li class="paginationjs-next disabled">\n                                    <a class="cursor-pointer">»</a>\n                                    </li>\n                                 ';
                elementsPaging.push(next)
            }
            containerPaging.html(elementsPaging),
                containerPaging.css("display", "block"),
                "topics-pagination" == container ? loadOnClickPage() : loadOnClickPageArticle()
        }
    }
    function loadOnClickPage() {
        $("#topics-pagination > li").on("click", (function (e) {
            const item = $(this);
            if (!item.hasClass("active") && !item.hasClass("disabled")) {
                const data = item.attr("data-page")
                    , page = parseInt(data);
                loadTopics(page)
            }
        }
        ))
    }
    function initSaveTopic() {
        $("button[name=saveTopic]").on("click", (function (event) {
            if (event.preventDefault(),
                isLogged())
                try {
                    const element = $(this)
                        , icon = "BUTTON" == event.target.nodeName ? $(event.target.children) : $(event.target)
                        , topicId = element.attr("data-id")
                        , isSaved = element.attr("data-save")
                        , url = `${DOMAIN}/user/saved-list`
                        , param = {
                            module: "TOPIC",
                            item_object: topicId
                        };
                    topicId ? "false" == isSaved ? Agents.post(url, param, (function (res) {
                        if (console.log("success ", res),
                            "200" == res.code) {
                            element.attr("data-save", "true"),
                                icon.attr("src", "/public/images/ic-saved.png");
                            const otherTopicSameId = $(`button[name=saveTopic][data-id=${topicId}]`);
                            console.log(otherTopicSameId),
                                otherTopicSameId.attr("data-save", "true"),
                                otherTopicSameId.html(icon)
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    )) : Agents.delete(url, param, (function (res) {
                        if (console.log("success ", res),
                            "200" == res.code) {
                            element.attr("data-save", "false"),
                                icon.attr("src", "/public/images/ic-save.png");
                            const otherTopicSameId = $(`button[name=saveTopic][data-id=${topicId}]`);
                            console.log(otherTopicSameId),
                                otherTopicSameId.attr("data-save", "false"),
                                otherTopicSameId.html(icon)
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    )) : console.log("Missing Topic ID")
                } catch (err) {
                    console.log("error: ", err)
                }
            else
                openModalLogin(event)
        }
        ))
    }
    function loadArticle(page) {
        const limit = 5
            , container = $("#articleContainer");
        container.empty();
        for (let i = 0; i < 6; i++)
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>');
        Agents.get(`${APIs.article.get}?limit=5&page=${page}&author=${userId}`, (function (res) {
            if (res) {
                const data = res.data;
                data && setTimeout((function () {
                    const totalPage = data.total_page || 0
                        , currentPage = data.page || 1
                        , items = data.edges || [];
                    container.empty(),
                        $("#article-pagination").css("display", "none"),
                        items.length ? (items.forEach((function (item) {
                            const card = $("#cardArticleAuthor").tmpl(item);
                            card.appendTo("#articleContainer")
                        }
                        )),
                            items && items.length && showPageHandler(totalPage, currentPage, "article-pagination"),
                            $(".lazy").lazy()) : container.append('<div class="text-center m-t-20">Người dùng chưa có bài viết !</div>')
                }
                ), 100)
            }
        }
        ))
    }
    function loadOnClickPageArticle() {
        $("#article-pagination > li").on("click", (function (e) {
            const item = $(this);
            if (!item.hasClass("active") && !item.hasClass("disabled")) {
                const data = item.attr("data-page")
                    , page = parseInt(data);
                loadArticle(page),
                    goToByScroll("widget-article")
            }
        }
        ))
    }
    loadTopics(1),
        loadArticle(1)
}
function initProfileScreen() {
    const input = document.querySelector("#avatarInputProfile")
        , preview = document.querySelector("#preview");
    function updateImageDisplay() {
        for (; preview.firstChild;)
            preview.removeChild(preview.firstChild);
        console.log("input: ", preview);
        const curFiles = input.files
            , container = $("#preview");
        if (container.empty(),
            container.html('<div class="d-flex justify-content-center align-items-center" style="width: 74px">\n                        <div class="spinner-border spinner-border" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                     </div>'),
            0 === curFiles.length) {
            container.empty();
            const para = document.createElement("p");
            para.textContent = "Vui lòng chọn ảnh đại diện!",
                para.className = "text-white",
                preview.appendChild(para)
        } else
            for (const file of curFiles) {
                const para = document.createElement("p");
                if (validFileType(file) && validFileSize(file) && isLogged()) {
                    var formData = new FormData;
                    formData.append("file", file),
                        Agents.upload(APIs.users.updateAvatar, Agents.methods.POST, formData, (function (res) {
                            if (res)
                                if (200 == res.code) {
                                    container.empty();
                                    const image = document.createElement("img");
                                    image.src = URL.createObjectURL(file),
                                        image.className = "avatar-profile",
                                        preview.appendChild(image)
                                } else
                                    container.empty(),
                                        para.textContent = "Upload avatar không thành công",
                                        preview.appendChild(para);
                            else
                                container.empty(),
                                    para.textContent = "Upload avatar không thành công",
                                    preview.appendChild(para)
                        }
                        ), (function (err) {
                            console.log(err),
                                container.empty(),
                                para.textContent = "Upload avatar không thành công",
                                preview.appendChild(para)
                        }
                        ))
                } else
                    container.empty(),
                        file.size > 2e6 ? para.textContent = "Dung lượng ảnh quá lớn" : para.textContent = `File name ${file.name}: Not a valid file type. Update your selection.`,
                        preview.appendChild(para)
            }
    }
    function profileGetList(url, nameList, type, card, currentPage, containerTopic, paginationTopic) {
        currentPage || (currentPage = 1);
        const container = containerTopic || $("#ls-container");
        container.empty(),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>');
        const profilePaginationTopic = paginationTopic || $("#profilePaginationTopic");
        var option = ""
            , reUpOption = !1;
        url.includes("type=1") ? option = "Thu hồi" : url.includes("type=0") && (option = "Đăng lại",
            reUpOption = !0),
            console.log("re", url, reUpOption),
            Agents.get(url + "&pageSize=6&pageNumber=" + currentPage, (function (res) {
                if (200 == res.code) {
                    console.log("data2: ", res.data);
                    const data = res.data
                        , dataList = data.data
                        , nullList = "laso" === type ? `<p class="txt-sub-content text-secondary text-center m-t-20">Chưa có ${nameList}. <a href="/lap-la-so-tu-vi">Tạo lá số mới</a> </p>` : `<p class="txt-sub-content text-secondary text-center m-t-20">Chưa có ${nameList}</p>`;
                    if (!dataList && container.html(nullList) && container.addClass("d-block"),
                        dataList && dataList.length > 0) {
                        container.empty(),
                            container.removeClass("d-block"),
                            dataList.forEach((function (item, index) {
                                var data = item;
                                if ("topic" === type)
                                    data = topicItemHandler(data = data.item_object || data);
                                else {
                                    const objectId = data.id;
                                    (data = item.laso).id = objectId,
                                        console.log(item);
                                    const name = item.name || ""
                                        , slug = data.slug || ""
                                        , conGiap = data.can_chi_tuoi || ""
                                        , menh = data.loai_hanh_cua_ban_menh || ""
                                        , menhs = menh.split(" ");
                                    data.background = getBackgroundLaSoPreview(conGiap.split(" ")[1], menhs[menhs.length - 1]),
                                        data.href = "" != name ? slug + "?name=" + name : slug
                                }
                                data.option = option;
                                var tmpl = card.tmpl({
                                    item: data
                                });
                                container.append(tmpl);
                                const user = item.user
                                    , isThay = user && user.is_thay;
                                isThay && ($(`div[data-id-card=${data.id}] .username-topic`).empty(),
                                    $(`div[data-id-card=${data.id}] .username-topic`).append(`${user.name}<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="">`)),
                                    console.log(reUpOption),
                                    reUpOption && ($(`li[data-action=deleteTopic][data-id=${data.id}]`).attr("data-action", "reUpTopic"),
                                        $("li[data-action=reUpTopic]").attr("data-target", "#modalReUpTopic"))
                            }
                            )),
                            $("button[name=saveTopic]").on("click", (function (event) {
                                event.preventDefault();
                                try {
                                    const element = $(this)
                                        , topicId = element.attr("data-id")
                                        , deleteUrl = `${DOMAIN}/user/saved-list`
                                        , param = {
                                            module: "TOPIC",
                                            item_object: topicId
                                        };
                                    topicId ? Agents.delete(deleteUrl, param, (function (res) {
                                        if ("200" == res.code) {
                                            $(`div[data-id-topic=${topicId}]`).remove();
                                            const child = container[0].children
                                                , pageLoad = 0 === child.length ? currentPage > 1 ? currentPage - 1 : 1 : currentPage;
                                            profileGetList(url, nameList, type, card, pageLoad)
                                        }
                                    }
                                    ), (function (err) {
                                        console.log(err)
                                    }
                                    )) : console.log("Missing Topic ID")
                                } catch (err) {
                                    console.log("error: ", err)
                                }
                            }
                            )),
                            $("li[data-action=deleteTopic]").on("click", (function (event) {
                                event.preventDefault();
                                const element = $(this);
                                let targetId = element.attr("data-id") || 0
                                    , targetModule = "topic";
                                $("#modalConfirmDeleteBtn").attr("data-id", targetId),
                                    $("#modalConfirmDeleteBtn").attr("data-module", "topic"),
                                    $("#modalConfirmDeleteTitle").text("Gỡ lá số khỏi chợ"),
                                    $("#modalConfirmDeleteContent").text("Bạn có chắc chắn muốn gỡ lá số khỏi chợ? Số xu còn lại trên lá số sẽ được hoàn trả")
                            }
                            )),
                            $("li[data-action=reUpTopic]").on("click", (function (event) {
                                event.preventDefault();
                                var topicId = $(this).attr("data-id") || 0
                                    , topicTitle = $(this).attr("data-title") || 0
                                    , inputId = $("#idTopicReUp");
                                inputId && inputId.val(topicId);
                                var inputTitle = $("#titleTopicReUp");
                                inputTitle && inputTitle.val(topicTitle)
                            }
                            )),
                            $("li[data-action=deleteLaSo]").on("click", (function (event) {
                                event.preventDefault();
                                const element = $(this);
                                let targetId = element.attr("data-id") || 0
                                    , targetModule = "laso";
                                $("#modalConfirmDeleteBtn").attr("data-id", targetId),
                                    $("#modalConfirmDeleteBtn").attr("data-module", "laso"),
                                    $("#modalConfirmDeleteTitle").text("Xóa lá số đã tạo"),
                                    $("#modalConfirmDeleteContent").text("Bạn thực sự muốn xóa lá số này?")
                            }
                            ));
                        var totalPage = data.total_page || 0
                            , arrPage = [];
                        if (totalPage > 0 && currentPage <= totalPage) {
                            if (totalPage < 5)
                                arrPage = Array.from(new Array(totalPage), (x, i) => i + 1);
                            else if (currentPage <= 4)
                                arrPage = Array.from(new Array(5), (x, i) => x + 1);
                            else if (currentPage >= totalPage - 1)
                                for (var i = totalPage - 4; i < totalPage + 1; i++)
                                    arrPage.push(i);
                            else
                                arrPage = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
                            var elementsPaging = [];
                            if (currentPage > 1) {
                                var backpage, back = `<li class="paginationjs-prev" data-page="${currentPage - 1}"><a class="cursor-pointer" >«</a></li>`;
                                elementsPaging.push(back)
                            } else {
                                var back = '\n                                    <li class="paginationjs-prev disabled">\n                                     <a class="cursor-pointer">«</a>\n                                    </li>\n                                 ';
                                elementsPaging.push(back)
                            }
                            if (arrPage.forEach((function (item) {
                                var active, ele = `\n                                    <li class="paginationjs-page J-paginationjs-page ${item == currentPage ? "active" : ""}" data-page="${item}">\n                                          <a class="cursor-pointer">${item}</a>\n                                    </li>\n                                `;
                                elementsPaging.push(ele)
                            }
                            )),
                                currentPage < totalPage) {
                                console.log("aaaa", currentPage);
                                var nextpage, next = `\n                                    <li class="paginationjs-next" data-page="${currentPage + 1}">\n                                    <a class="cursor-pointer" >»</a>\n                                    </li>\n                                 `;
                                elementsPaging.push(next)
                            } else {
                                var next = '\n                                    <li class="paginationjs-next disabled">\n                                    <a class="cursor-pointer">»</a>\n                                    </li>\n                                 ';
                                elementsPaging.push(next)
                            }
                            profilePaginationTopic.html(elementsPaging),
                                profilePaginationTopic.attr("display", "block"),
                                profilePaginationTopic.find("li").on("click", (function (e) {
                                    profilePaginationTopic.attr("display", "none");
                                    const item = $(this);
                                    if (!item.hasClass("active") && !item.hasClass("disabled")) {
                                        const data = item.attr("data-page")
                                            , page = parseInt(data);
                                        console.log("click page", page),
                                            profileGetList(url, nameList, type, card, page, container, profilePaginationTopic)
                                    }
                                }
                                ))
                        }
                    }
                }
            }
            ), (function (err) {
                console.log(err)
            }
            ))
    }
    input && input.addEventListener("change", updateImageDisplay),
        $("#budget").on("change", (function () {
            $("div[id=errorForm]").html(""),
                $("#formReUpTopic").find("button").attr("disabled", !1)
        }
        )),
        $("#formReUpTopic").on("submit", (function (event) {
            $(this).find("button").attr("disabled", !0),
                event.preventDefault();
            const errEle = $(this).find("div[id=errorForm]")
                , title = $(this).find("input[id=titleTopicReUp]").val()
                , idTopic = parseInt($(this).find("input[id=idTopicReUp]").val())
                , budget = parseFloat($(this).find("select[name=budget]").val())
                , url = `${DOMAIN}/markets/topics`
                , params = {
                    title: title,
                    budget: budget,
                    id: idTopic
                };
            Agents.put(url, params, (function (response) {
                if (console.log(response),
                    "200" == response.code) {
                    console.log("push top: ", response.data.slug);
                    const topicSlug = response.data.slug || "";
                    window.location.href = "/" + topicSlug
                }
            }
            ), (function (error) {
                $("#formReUpTopic").find("button").attr("disabled", !1);
                const err = error.responseJSON
                    , uri = window.location
                    , previous = encodeURIComponent(uri);
                "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                    blinkMe(errEle)),
                    "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                        blinkMe(errEle)),
                    "600001005" == err.code && ($(errEle).html(`<span>Số lượt đăng lá số lên chợ có giới hạn. <a href='/payment?previous=${previous}'>Nâng cấp</a> lên  <span class="txt-sub-content-mid">Tài khoản VIP</span> để nhận thêm lượt</span>`),
                        blinkMe(errEle))
            }
            ))
        }
        ));
    const userId = $("input[name=userId]").val() || "";
    function loadTopics(page) {
        const limit = 6
            , container = $("#topicsContainer");
        container.empty();
        for (let i = 0; i < 6; i++)
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>');
        Agents.get(`${APIs.markets.masterTopics}?limit=6&page=${page}&user=${userId}`, (function (res) {
            if (res) {
                const data = res.data;
                data && setTimeout((function () {
                    const total = data.total_count || 0
                        , totalPage = data.total_page || 0
                        , currentPage = data.page || 1;
                    $("#total-topics").html(`Hiện có ${total} lá số`);
                    const items = data.data || [];
                    container.empty(),
                        $("#topics-pagination").css("display", "none"),
                        items.length ? (items.forEach((function (item) {
                            const topicId = (item = topicItemHandler(item)).id || 0
                                , card = $("#cardTopicMarket").tmpl(item);
                            card.appendTo("#topicsContainer");
                            const user = item.user
                                , isThay = user && user.is_thay;
                            item && item.media && item.media.path && $(`a#${topicId} .topic-picture-preview`).append(`<img class="topic-picture lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${item.media.path}" alt="topicPicture">`),
                                isThay && $(`a#${topicId} .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="professorIc">');
                            var tagContainer = $(`a#${topicId} > div.list-tag`);
                            tagContainer && 1 == tagContainer.length && (tagContainer = tagContainer[0]);
                            const tags = item.tags || [];
                            if (tags.length > 0)
                                for (let i = 0; i < tags.length; i++) {
                                    const tagItem = tags[i]
                                        , idTag = tagItem.id || 0
                                        , iconTag = getIconTagTopic(idTag)
                                        , child = $(iconTag);
                                    var div = $("<div class='small-tag'></div>");
                                    div.html(child),
                                        $(tagContainer).find(".tag-container").append(div)
                                }
                            else
                                $(tagContainer).addClass("d-none"),
                                    $(tagContainer).empty();
                            var viewUserContainer = $(`a#${topicId} .list-view-user`)
                                , viewUsers = item.view_users || []
                                , totalViewUsers = item.total_view_user || 0;
                            if (totalViewUsers > 0) {
                                const maxUser = 5 == totalViewUsers ? 5 : totalViewUsers > 5 ? 4 : totalViewUsers;
                                for (let i = 0; i < maxUser; i++) {
                                    const user = viewUsers[i];
                                    var avatar = user ? user.avatar : "";
                                    avatar && "" != avatar || (avatar = "/public/images/avatars/avt-default.jpg");
                                    const name = user ? user.name : "";
                                    var img = $(`<img class="la-so-avt-activity lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${avatar}" title="${name}">`);
                                    $(viewUserContainer).append(img)
                                }
                                if (totalViewUsers > 5) {
                                    let moreUser = totalViewUsers - 4 > 99 ? 99 : totalViewUsers - 4;
                                    const more = $('<div class="la-so-preview-activity-more txt-sub-content"></div>').text(`+${moreUser}`);
                                    $(viewUserContainer).append(more)
                                }
                            }
                        }
                        )),
                            items && items.length && showPageHandler(totalPage, currentPage),
                            initSaveTopic(),
                            $(".lazy").lazy()) : container.append('<div class="text-center">Không có kết quả tìm kiếm</div>')
                }
                ), 100)
            }
        }
        ))
    }
    function showPageHandler(totalPage, currentPage) {
        var arrPage = [];
        if (totalPage > 0 && currentPage <= totalPage) {
            if (totalPage < 5)
                arrPage = Array.from(new Array(totalPage), (x, i) => i + 1);
            else if (currentPage <= 4)
                arrPage = Array.from(new Array(5), (x, i) => x + 1);
            else if (currentPage >= totalPage - 1)
                for (var i = totalPage - 4; i < totalPage + 1; i++)
                    arrPage.push(i);
            else
                arrPage = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
            var containerPaging = $("#topics-pagination")
                , elementsPaging = [];
            if (currentPage > 1) {
                var backpage, back = `<li class="paginationjs-prev" data-page="${currentPage - 1}"><a class="cursor-pointer" >«</a></li>`;
                elementsPaging.push(back)
            } else {
                var back = '\n                                    <li class="paginationjs-prev disabled">\n                                     <a class="cursor-pointer">«</a>\n                                    </li>\n                                 ';
                elementsPaging.push(back)
            }
            if (arrPage.forEach((function (item) {
                var active, ele = `\n                                    <li class="paginationjs-page J-paginationjs-page ${item == currentPage ? "active" : ""}" data-page="${item}">\n                                          <a class="cursor-pointer">${item}</a>\n                                    </li>\n                                `;
                elementsPaging.push(ele)
            }
            )),
                currentPage < totalPage) {
                var nextpage, next = `\n                                    <li class="paginationjs-next" data-page="${currentPage + 1}">\n                                    <a class="cursor-pointer" >»</a>\n                                    </li>\n                                 `;
                elementsPaging.push(next)
            } else {
                var next = '\n                                    <li class="paginationjs-next disabled">\n                                    <a class="cursor-pointer">»</a>\n                                    </li>\n                                 ';
                elementsPaging.push(next)
            }
            containerPaging.html(elementsPaging),
                $("#topics-pagination").css("display", "block"),
                loadOnClickPage()
        }
    }
    function loadOnClickPage() {
        $("#topics-pagination > li").on("click", (function (e) {
            const item = $(this);
            if (!item.hasClass("active") && !item.hasClass("disabled")) {
                const data = item.attr("data-page")
                    , page = parseInt(data);
                loadTopics(page)
            }
        }
        ))
    }
    function initSaveTopic() {
        $("button[name=saveTopic]").on("click", (function (event) {
            if (event.preventDefault(),
                isLogged())
                try {
                    const element = $(this)
                        , icon = "BUTTON" == event.target.nodeName ? $(event.target.children) : $(event.target)
                        , topicId = element.attr("data-id")
                        , isSaved = element.attr("data-save")
                        , url = `${DOMAIN}/user/saved-list`
                        , param = {
                            module: "TOPIC",
                            item_object: topicId
                        };
                    topicId ? "false" == isSaved ? Agents.post(url, param, (function (res) {
                        if (console.log("success ", res),
                            "200" == res.code) {
                            element.attr("data-save", "true"),
                                icon.attr("src", "/public/images/ic-saved.png");
                            const otherTopicSameId = $(`button[name=saveTopic][data-id=${topicId}]`);
                            console.log(otherTopicSameId),
                                otherTopicSameId.attr("data-save", "true"),
                                otherTopicSameId.html(icon)
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    )) : Agents.delete(url, param, (function (res) {
                        if (console.log("success ", res),
                            "200" == res.code) {
                            element.attr("data-save", "false"),
                                icon.attr("src", "/public/images/ic-save.png");
                            const otherTopicSameId = $(`button[name=saveTopic][data-id=${topicId}]`);
                            console.log(otherTopicSameId),
                                otherTopicSameId.attr("data-save", "false"),
                                otherTopicSameId.html(icon)
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    )) : console.log("Missing Topic ID")
                } catch (err) {
                    console.log("error: ", err)
                }
            else
                openModalLogin(event)
        }
        ))
    }
    const isMaster = "true" == $("body").attr("data-master");
    isMaster && loadTopics(1);
    var sPageURL, tab = (window.location.search.substring(1) || "").toLowerCase();
    switch ($(".tab-profile .tab-item, #changeTabUpdateProfile").on("click", (function () {
        const id = $(this).attr("data-id");
        switch ($(".tab-item").removeClass("tab-item-active"),
        id) {
            case "1":
                window.history.pushState("", "", "?tab=1"),
                    $("#profile-master").removeClass("d-none"),
                    isMaster && loadTopics(1),
                    $(this).addClass("tab-item-active"),
                    Agents.get(APIs.users.update, (function (res) {
                        if (200 == res.code) {
                            var data = res.data
                                , gender = data.gender;
                            console.log(data),
                                res.data.gender = "M" == gender ? "Nam" : "Nữ";
                            var currentRank = data.rank;
                            currentRank || (res.data.rank = {
                                title: ""
                            });
                            var nextRank = data.next_rank
                                , needPoint = 0;
                            if (nextRank) {
                                let currentPoint = data.point || 0, baseNextRank;
                                needPoint = (nextRank.base_ranking || 0) - currentPoint,
                                    res.data.need_point = needPoint,
                                    res.data.next_rank_title = nextRank.title
                            } else
                                res.data.need_point = 0,
                                    res.data.next_rank_title = "";
                            var about = data.about || "";
                            $(this).addClass("tab-item-active"),
                                $("#bcProfile").text("Thông tin cá nhân"),
                                $("#widget-left").empty(),
                                $("#profileInformation").tmpl(res.data).appendTo("#widget-left"),
                                currentRank || ($("#currentRank").addClass("d-none"),
                                    $("#currentRank").empty()),
                                needPoint <= 0 && $("#needPoint").empty();
                            const isMaster = data.is_thay || !1;
                            if (isMaster) {
                                const userFullName = data.name;
                                $("#profileFullName").empty(),
                                    $("#profileFullName").html(`<p class="m-b-5 txt-sub-title-bold">Thầy:</p>\n                <p class="m-b-10 txt-content">${userFullName}<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1"/></p>`);
                                const tieuChi = $("#nextRank").find("a");
                                $(tieuChi).attr("name", "toBoardRankPageMaster")
                            }
                            "" == about && ($("#aboutContainer").addClass("d-none"),
                                $("#aboutContainer").empty()),
                                $("#widget-left").append("\n                            <script type=\"text/javascript\">\n                               $('#changeTabUpdateProfile').on('click', function() {\n                                 $('#btn-edit-profile').click()\n                               });\n                               $('a[name=toBoardRankPage]').click(function () {\n                                    localStorage.setItem('openCollapse', 'criteriaUser');\n                                    window.location.href = '/ho-tro-va-hoi-dap';\n                                })\n                                $('a[name=toBoardRankPageMaster]').click(function () {\n                                    localStorage.setItem('openCollapse', 'criteriaPro');\n                                    window.location.href = '/ho-tro-va-hoi-dap';\n                                })\n                             <\/script>       \n                            ")
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    ));
                break;
            case "2":
                window.history.pushState("", "", "?tab=2"),
                    $("#profile-master").addClass("d-none"),
                    $(this).addClass("tab-item-active"),
                    Agents.get(APIs.users.update, (function (res) {
                        if (200 == res.code) {
                            console.log("res: ", res);
                            const data = res.data
                                , gender = data.gender || "M";
                            if (data) {
                                $("#bcProfile").text("Chỉnh sửa thông tin"),
                                    $("#widget-left").empty(),
                                    $(this).addClass("tab-item-active");
                                const description = data.about || "";
                                let inputAbout;
                                "" == description && (data.about = description),
                                    $("#profileEdit").tmpl(data).appendTo("#widget-left"),
                                    initMaxDate(),
                                    $("#widget-left").append("\n                              <script type=\"text/javascript\">\n                                $('#btnUpdateProfile').on('click', function (e) {\n                                    const name = $('#nameInputProfile').val() || '';\n                                    let username = $('#usernameInputProfile').val()\n                                    let email = $('#emailInputProfile').val()\n                                    let dob = $('#dateInputProfile').val() || ''\n                                    let phone = $('#phoneInputProfile').val()\n                                    let gender = $('#genderInputProfile').val()\n                                    let address = $('#addressInputProfile').val()\n                                    let idCard = $('#idCardInputProfile').val()\n                                    let about = $('#aboutInputProfile').val()\n                    \n                                    let paramFalse = false\n                                    const selectedDate = new Date(dob);\n                                    const now = new Date();\n                                    if (dob && now.getTime() > selectedDate.getTime()) {\n                                        var splitDob = dob.split('-');\n                                        var year = splitDob[0];\n                                        var month = splitDob[1];\n                                        var day = splitDob[2];\n                                        dob = day + \"/\" + month + \"/\" + year\n                                        $('#dateInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                    } else {\n                                        $('#dateInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                        paramFalse = true\n                                    }\n                                    var param = {\n                                        name: name,\n                                        email: email,\n                                        dob: dob,\n                                        gender: gender,\n                                    }\n                                    if (validateName(name)) {\n                                        $('#nameInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                    } else {\n                                        $('#nameInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                        paramFalse = true\n                                    }\n                                    let oldUsername = $('#oldUsername');\n                                    oldUsername = oldUsername.val() || '';\n                                    if (username != oldUsername){\n                                        if (validateUsername(username)) {\n                                            $('#usernameInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                            let startUsername = username.substr(0,4);\n                                            if (startUsername == 'tuvi') {\n                                                $('#usernameInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                                $('#errUsername').text('Username thay đổi không thể bắt đầu bằng \"tuvi\"')\n                                                paramFalse = true\n                                            } else {\n                                                $('#errUsername').text('');\n                                                param.username = username;\n                                            }\n                                        } else {\n                                            $('#usernameInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                            paramFalse = true\n                                        }   \n                                    }\n                                    if (validateEmail(email)) {\n                                        $('#emailInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                    } else {\n                                        $('#emailInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                        paramFalse = true\n                                    }\n                                    if (phone) {\n                                        param.phone = phone;\n                                        if (validatePhone(phone)) {\n                                            $('#phoneInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                        } else {\n                                            $('#phoneInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                            paramFalse = true\n                                        }\n                                    }\n                                    if (address) {\n                                        param.address = address;\n                                        if (validateAddress(address)) {\n                                            $('#addressInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                        } else {\n                                            $('#addressInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                            paramFalse = true\n                                        }\n                                    }\n                                    if (idCard) {\n                                        param.id_card = idCard;\n                                        if (validateIdCard(idCard)) {\n                                            $('#idCardInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                        } else {\n                                            $('#idCardInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                            paramFalse = true\n                                        }\n                                    }\n                                    if (about) {\n                                        if(about.length>250){\n                                            about = about.substr(0,250);\n                                        }\n                                        param.about = about;\n                                    }\n                                    console.log('data: ', gender, ' ', dob, ' ', about)\n                                    if (paramFalse) {\n                                        $('#titleMes').text('Lưu ý!!')\n                                        $('#contentMes').text('Bạn cần điền đầy đủ, chính xác thông tin. Các thông tin sai hoặc thiếu đã được bôi vàng. Vui lòng kiểm tra lại')\n                                    } else {\n                                         $('#warningChangeEmail').text('');\n                                        Agents.put(APIs.users.update, param, function (res) {\n                                            console.log(res)\n                                            if (res) {\n                                                if (res.code == 200) {\n                                                    const oldEmail = $('#oldEmail').val() || '';\n                                                    if(email != oldEmail) {\n                                                         $('#emailInputProfile').css(\"border\", \"2.5px solid red\");\n                                                         $('#warningChangeEmail').text('Kiểm tra Email để xác thực email mới. Nếu không xác thực email sẽ quay về như cũ');\n                                                    }\n                                                    $('span[id=userFullName]').text(name);\n                                                    const username = $('#usernameInputProfile').val();\n                                                    $('#oldUsername').val(username);\n                                                    $('#titleMes').text('Cập nhật thành công')\n                                                    $('#contentMes').text('Bạn đã cập nhật thông tin cá nhân thành công. Tuvi.vn cảm ơn bạn!')\n                                                } else {\n                                                    $('#titleMes').text('Cập nhật không thành công')\n                                                    $('#contentMes').text('Bạn chưa cập nhật thông tin cá nhân thành công, vui lòng kiểm tra lại thông tin cá nhân')\n                                                }\n                                            } else {\n                                                console.log('SEVER ERROR')\n                                            }\n                                        }, function (err) {\n                                           const error = err.responseJSON || undefined;\n                                            if(error && error.data) {\n                                                const data = error.data;\n                                                const username = data.username || '';\n                                                const code = username.code || ''\n                                                if(code == \"700002019\") {\n                                                    $('#titleMes').text('Cập nhật không thành công')\n                                                    $('#contentMes').text('Username không hợp lệ, chứa các từ khóa bị cấm');\n                                                    $('#usernameInputProfile').css(\"border\", \"solid 1px red\");\n                                                } else {\n                                                    $('#titleMes').text('Cập nhật không thành công')\n                                                    $('#contentMes').text('Bạn chưa cập nhật thông tin cá nhân thành công, vui lòng kiểm tra lại thông tin cá nhân')\n                                                }\n                                            } else if(error && error.code == \"700002012\") {\n                                                $('#titleMes').text('Cập nhật không thành công')\n                                                $('#contentMes').text('Email đã trùng với tài khoản khác. Vui lòng chọn một Email khác');\n                                                const oldEmail = $('#oldEmail').val() || '';\n                                                $('#emailInputProfile').val(oldEmail);\n                                            } else if(error && error.code == \"700002013\") {\n                                                $('#titleMes').text('Cập nhật không thành công');\n                                                $('#contentMes').text('Username đã trùng với tài khoản khác. Vui lòng chọn một Username khác');\n                                                $('#usernameInputProfile').css(\"border\", \"solid 1px red\");\n                                            } else {\n                                                $('#titleMes').text('Cập nhật không thành công')\n                                                $('#contentMes').text('Bạn chưa cập nhật thông tin cá nhân thành công, vui lòng kiểm tra lại thông tin cá nhân')\n                                            }\n                                        })\n                                    }\n                                })\n                             <\/script>   \n                            "),
                                    $("#widget-left #genderInputProfile").val(gender),
                                    $("#aboutInputProfile").on("keyup", (function () {
                                        let count = $(this).val() || "";
                                        count = count.length + "/250",
                                            $("#aboutCountCharacter").text(count)
                                    }
                                    ))
                            }
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    ));
                break;
            case "3":
                {
                    window.history.pushState("", "", "?tab=3"),
                        $("#profile-master").addClass("d-none"),
                        $(this).addClass("tab-item-active"),
                        $("#bcProfile").text("Quản lý lá số trên chợ"),
                        $("#widget-left").empty(),
                        $("#profileLaSoManagement").tmpl().appendTo("#widget-left"),
                        $("#title-widget").text("Quản lý lá số trên chợ"),
                        $("#block-topic").tmpl().appendTo("#content-profile"),
                        $("#block-topic").tmpl().appendTo("#content-profile"),
                        $("#block-topic").tmpl().appendTo("#content-profile");
                    const containers = $("#widget-left").find("div[data-id=ls-container]")
                        , paginations = $("#widget-left").find("ul[class=pagination]")
                        , nameListEles = $("#widget-left").find("span[data-id=nameList]")
                        , listTitle = ["Lá số trên chợ", "Đã thu hồi", "Đã trả xu mở bình luận khóa"];
                    for (let index = 0; index < nameListEles.length; index++)
                        $(nameListEles[index]).text(listTitle[index]);
                    const urlLaSoTrenCho = `${DOMAIN}/users/topics?type=1&search=`;
                    profileGetList(urlLaSoTrenCho, listTitle[0], "topic", $("#lstcCardProfile"), 1, $(containers[0]), $(paginations[0]));
                    const urlLaSoThuHoi = `${DOMAIN}/users/topics?type=0&search=`;
                    profileGetList(urlLaSoThuHoi, listTitle[1], "topic", $("#lstcCardProfile"), 1, $(containers[1]), $(paginations[1]));
                    const urlDaMoKhoa = `${DOMAIN}/users/topics?type=2&search=`;
                    profileGetList(urlDaMoKhoa, listTitle[2], "topic", $("#unlockedCardProfile"), 1, $(containers[2]), $(paginations[2]));
                    break
                }
            case "4":
                {
                    window.history.pushState("", "", "?tab=4"),
                        $("#profile-master").addClass("d-none"),
                        $(this).addClass("tab-item-active"),
                        $("#bcProfile").text("Quản lý lá số đã tạo"),
                        $("#widget-left").empty(),
                        $("#profileLaSoManagement").tmpl().appendTo("#widget-left"),
                        $("#block-la-so-profile").tmpl().appendTo("#content-profile"),
                        $("#title-widget").text("Quản lý lá số đã tạo");
                    const urlLaSoDaTao = `${DOMAIN}/users/la-so?`;
                    profileGetList(urlLaSoDaTao, "Lá số đã tạo", "laso", $("#lasoCardProfile"));
                    break
                }
            case "5":
                {
                    window.history.pushState("", "", "?tab=5"),
                        $("#profile-master").addClass("d-none"),
                        $(this).addClass("tab-item-active"),
                        $("#bcProfile").text("Đã lưu"),
                        $("#widget-left").empty(),
                        $("#profileLaSoManagement").tmpl().appendTo("#widget-left"),
                        $("#block-la-so-profile").tmpl().appendTo("#content-profile"),
                        $("#title-widget").text("Đã lưu");
                    const urlLaSoDaLuu = `${DOMAIN}/user/saved-list?module=TOPIC`;
                    profileGetList(urlLaSoDaLuu, "Lá số đã lưu", "topic", $("#saveCardProfile"));
                    break
                }
            case "6":
                window.history.pushState("", "", "?tab=6"),
                    $("#profile-master").addClass("d-none"),
                    $(this).addClass("tab-item-active");
                const page = 1
                    , limit = 10;
                getHistoryTransaction(page, limit);
                break;
            case "7":
                window.history.pushState("", "", "?tab=7"),
                    $("#profile-master").addClass("d-none"),
                    $("#bcProfile").text("Đổi mật khẩu"),
                    $(this).addClass("tab-item-active"),
                    $("#widget-left").empty(),
                    $("#profileChangePassword").tmpl().appendTo("#widget-left"),
                    $("#widget-left").append("\n                        <script type=\"text/javascript\">\n                                $('#changePasswordProfile').on('click', function (e) {\n                                    let oldPass = $('#oldPasswordInputProfile').val()\n                                    let newPass = $('#newPasswordInputProfile').val()\n                                    let newPassConfirm = $('#newPasswordConfirmInputProfile').val()\n                    \n                                    let paramFalse = false\n                                    if (validatePassword(oldPass)) {\n                                        $('#oldPasswordInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                    } else {\n                                        $('#oldPasswordInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                        paramFalse = true\n                                    }\n                                    if (validatePassword(newPass)) {\n                                        $('#newPasswordInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                    } else {\n                                        $('#newPasswordInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                        paramFalse = true\n                                    }\n                                    if (validatePassword(newPassConfirm) && newPass === newPassConfirm) {\n                                            $('#newPasswordConfirmInputProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                        } else {\n                                            $('#newPasswordConfirmInputProfile').css(\"border\", \"2.5px solid yellow\")\n                                            paramFalse = true\n                                        }    \n                                    console.log('data: ', oldPass, ' ', newPass, ' ', newPassConfirm)\n                                    if (paramFalse) {\n                                        $(this).attr('type','button');\n                                        $('#titleMes').text('Lưu ý!!')\n                                        $('#contentMes').text('Bạn cần điền đầy đủ, chính xác thông tin. Các thông tin sai hoặc thiếu đã được bôi vàng. Vui lòng kiểm tra lại')\n                                        if (newPass != newPassConfirm) {\n                                            $('#contentMes').text('Nhập lại mật khẩu không chính xác');\n                                        }\n                                        $(this).attr('data-target','#exampleModalCenter');\n                                    } else {\n                                        var param = {\n                                            old_password: oldPass,\n                                            new_password_1: newPass,\n                                            new_password_2: newPassConfirm,\n                                        }\n                                        Agents.post(APIs.auth.changePassword, param, function (res) {\n                                            console.log(res)\n                                            if (res) {\n                                                console.log(\"res: \", res);\n                                                if (res.code == 200) {\n                                                    $('#titleMes').text('Cập nhật thành công')\n                                                    $('#contentMes').text('Bạn đã cập nhật mật khẩu thành công. Tuvi.vn cảm ơn bạn!')\n                                                    window.location.href = '/logout?previous=https://tuvi.vn/login?message=%C4%90%E1%BB%95i%20m%E1%BA%ADt%20kh%E1%BA%A9u%20th%C3%A0nh%20c%C3%B4ng%20%21'\n                                                } else {\n                                                    $('#titleMes').text('Cập nhật không thành công')\n                                                    $('#contentMes').text('Bạn chưa cập nhật mật khẩu thành công, vui lòng kiểm tra lại thông tin cá nhân')\n                                                }\n                                            } else {\n                                                console.log('SEVER ERROR')\n                                            }\n                                        }, function (err) {\n                                            const error = err.responseJSON || undefined;\n                                            if(error && error.code == \"500001008\") {\n                                                $('#titleMes').text('Cập nhật không thành công')\n                                                $('#contentMes').text('Sai mật khẩu cũ. Chọn Quên mật khẩu để lấy lại mật khẩu cũ qua email');\n                                            } else {\n                                                $('#titleMes').text('Cập nhật không thành công')\n                                                $('#contentMes').text('Bạn chưa cập nhật mật khẩu thành công, vui lòng kiểm tra lại thông tin cá nhân')\n                                            }\n                                        })\n                                        $(this).attr('data-target','#exampleModalCenter');\n                                        $(this).attr('type','reset');\n                                    }\n                                })\n                             <\/script>       \n                    ");
                break;
            case "8":
                window.history.pushState("", "", "?tab=8"),
                    $("#profile-master").addClass("d-none"),
                    $("#bcProfile").text("Quà tặng"),
                    $(this).addClass("tab-item-active"),
                    $("#widget-left").empty(),
                    $("#profileGiftCode").tmpl().appendTo("#widget-left"),
                    $("#widget-left").append("\n                        <script type=\"text/javascript\">\n                            $('#acceptGiftCodeProfile').on('click', function (e) {\n                                    const code = $('#giftCodeProfile').val() || '';\n                                    let paramFalse = false\n                                    var param = {\n                                        code: code,\n                                    }\n                                    if (validateUsername(code)) {\n                                        $('#giftCodeProfile').css(\"border\", \"solid 1px var(--border-color)\")\n                                    } else {\n                                        $('#giftCodeProfile').css(\"border\", \"2.5px solid yellow\")\n                                        paramFalse = true\n                                    }\n                                    if (paramFalse) {\n                                        $('#titleMes').text('Lưu ý!!')\n                                        $('#contentMes').text('Bạn cần điền đúng mã quà tặng. Vui lòng kiểm tra lại')\n                                    } else {\n                                        Agents.post(APIs.gift.code, param, function (res) {\n                                            console.log(res)\n                                            if (res) {\n                                                if (res.code == 200) {\n                                                    var codePrice =  res.data.value\n                                                    var balance = $('#userBalance')\n                                                    var balanceNumber = parseInt(balance.text().replaceAll('.',''))\n                                                    if(codePrice) {\n                                                        balance.text(formatPrice(balanceNumber + parseInt(codePrice)))\n                                                        $('#giftCodeProfile').val('')\n                                                    }\n                                                    $('#titleMes').text('Thành công')\n                                                    $('#contentMes').text('Bạn đã nhập mã quà tặng thành công!')\n                                                } else {\n                                                    $('#giftCodeProfile').val('')\n                                                    $('#titleMes').text('Không thành công')\n                                                    $('#contentMes').text('Mã quà tặng không đúng')\n                                                }\n                                            } else {\n                                                console.log('SEVER ERROR')\n                                            }\n                                        }, function (err) {\n                                            $('#giftCodeProfile').val('')\n                                            $('#titleMes').text('Không thành công')\n                                            $('#contentMes').text('Mã quà tặng không đúng')\n                                        })\n                                    }\n                                })\n                        <\/script>            \n                    ");
                break;
            case "9":
                $("#btn-logout").on("click", (function () {
                    window.location.href = "/logout"
                }
                ))
        }
    }
    )),
    tab) {
        case "tab=1":
            $(".tab-item[data-id=1]").trigger("click");
            break;
        case "tab=2":
            $(".tab-item[data-id=2]").trigger("click");
            break;
        case "tab=3":
            $(".tab-item[data-id=3]").trigger("click");
            break;
        case "tab=4":
            $(".tab-item[data-id=4]").trigger("click");
            break;
        case "tab=5":
            $(".tab-item[data-id=5]").trigger("click");
            break;
        case "tab=6":
            $(".tab-item[data-id=6]").trigger("click");
            break;
        case "tab=7":
            $(".tab-item[data-id=7]").trigger("click")
    }
    function getHistoryTransaction(page, limit) {
        var currentPage = page;
        const url = `${DOMAIN}/transactions?pageNumber=${currentPage}&pageSize=${limit}`;
        Agents.get(url, (function (res) {
            if (200 == res.code) {
                const data = res.data
                    , { balance: balance, all_spent: all_spent, all_received: all_received, edges: edges, total_page: total_page } = data;
                res.data.balance = formatPrice(balance),
                    res.data.all_spent = formatPrice(all_spent),
                    res.data.all_received = formatPrice(all_received),
                    $(this).addClass("tab-item-active"),
                    $("#bcProfile").text("Lịch sử giao dịch"),
                    $("#widget-left").empty(),
                    $("#profileHistoryManagement").tmpl(res.data).appendTo("#widget-left");
                const historyTransactionPagination = $("#historyTransactionPagination")
                    , container = $("#list-result-history-profile");
                var nullList = '<p class="txt-content-bold">Chưa có lịch sử giao dịch</p>';
                if (edges) {
                    var response = edges;
                    let header;
                    container.empty(),
                        header = response ? '<tr class="txt-content-bold bg-line">\n                                                    <td>STT</td>\n                                                    <td>Thời gian</td>\n                                                    <td>Phát sinh giao dịch</td>\n                                                    <td>Giao dịch (Xu)</td>\n                                                    <td>Số dư (Xu)</td>\n                                                  </tr>' : '<p class="txt-content-bold">Chưa có lịch sử giao dịch</p>',
                        container.html(header),
                        response && response.forEach((function (item, index) {
                            item.index = index + 1;
                            let amount = item.amount || 0;
                            amount = formatPrice(amount);
                            let newBalance = item.new_balance || 0
                                , oldBalance = item.old_balance || 0
                                , type = item.action_type || ""
                                , sender = item.sender_module || ""
                                , receiver = item.receiver_module || "";
                            const style = getTranStatus(newBalance > oldBalance, amount, type.toUpperCase());
                            type = getTranDetail(type.toUpperCase(), receiver.toUpperCase(), sender.toUpperCase()),
                                item.action_type = type,
                                item.color_code = style.color,
                                item.amount = style.amount,
                                item.new_balance = formatPrice(newBalance);
                            const obj = {
                                item: item
                            };
                            var tmpl = $("#lrhpTable").tmpl(obj);
                            container.append(tmpl)
                        }
                        )),
                        currentPage || (currentPage = 1);
                    var totalPage = total_page || 0
                        , arrPage = [];
                    if (totalPage > 0 && currentPage <= totalPage) {
                        if (totalPage < 5)
                            arrPage = Array.from(new Array(totalPage), (x, i) => i + 1);
                        else if (currentPage <= 4)
                            arrPage = Array.from(new Array(5), (x, i) => i + 1);
                        else if (currentPage >= totalPage - 1)
                            for (var i = totalPage - 4; i < totalPage + 1; i++)
                                arrPage.push(i);
                        else
                            arrPage = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
                        var elementsPaging = [];
                        if (currentPage > 1) {
                            var backpage, back = `<li class="paginationjs-prev" data-page="${currentPage - 1}"><a class="cursor-pointer" >«</a></li>`;
                            elementsPaging.push(back)
                        } else {
                            var back = '\n                                    <li class="paginationjs-prev disabled">\n                                     <a class="cursor-pointer">«</a>\n                                    </li>\n                                 ';
                            elementsPaging.push(back)
                        }
                        if (arrPage.forEach((function (item) {
                            var active, ele = `\n                                    <li class="paginationjs-page J-paginationjs-page ${item == currentPage ? "active" : ""}" data-page="${item}">\n                                          <a class="cursor-pointer">${item}</a>\n                                    </li>\n                                `;
                            elementsPaging.push(ele)
                        }
                        )),
                            currentPage < totalPage) {
                            var nextpage, next = `\n                                    <li class="paginationjs-next" data-page="${currentPage + 1}">\n                                    <a class="cursor-pointer" >»</a>\n                                    </li>\n                                 `;
                            elementsPaging.push(next)
                        } else {
                            var next = '\n                                    <li class="paginationjs-next disabled">\n                                    <a class="cursor-pointer">»</a>\n                                    </li>\n                                 ';
                            elementsPaging.push(next)
                        }
                        historyTransactionPagination.html(elementsPaging),
                            historyTransactionPagination.attr("display", "block"),
                            historyTransactionPagination.find("li").on("click", (function (e) {
                                const item = $(this);
                                if (!item.hasClass("active") && !item.hasClass("disabled")) {
                                    const data = item.attr("data-page")
                                        , page = parseInt(data);
                                    getHistoryTransaction(page, limit)
                                }
                            }
                            ))
                    }
                } else
                    container.html(nullList)
            }
        }
        ), (function (err) {
            console.log(err)
        }
        ))
    }
    function getTranStatus(check, amount, type) {
        return 0 == amount ? {
            color: "text-xu-cash-back",
            amount: `${amount}`
        } : check ? "CASH_BACK" == type ? {
            color: "text-xu-cash-back",
            amount: `+${amount}`
        } : {
            color: "text-xu-received",
            amount: `+${amount}`
        } : {
            color: "text-xu-used",
            amount: `-${amount}`
        }
    }
    function getTranDetail(type, receiver, sender) {
        switch (type) {
            case "DEPOSIT":
                return "Nạp tiền";
            case "CASH_BACK":
                return "Hoàn tiền";
            case "PUSH_LS_TO_MARKET":
                return "Đẩy lá số lên chợ";
            case "UP_TOP_LS_MARKET":
                return "Đẩy lá số lên Top chợ";
            case "GIFT_CODE":
                return "Quà tặng";
            case "UNLOCK_COMMENT":
                return "USER" == receiver && "SYSTEM" == sender ? "Luận giải được mở" : "Mở luận giải";
            default:
                return "Lỗi"
        }
    }
    function initMaxDate() {
        const today = new Date
            , y = today.getFullYear();
        var d = today.getDate();
        d = d > 9 ? d : "0" + d.toString();
        var m = today.getMonth() + 1;
        const max = y + "-" + (m = m > 9 ? m : "0" + m.toString()) + "-" + d;
        console.log(max),
            $("#dateInputProfile").attr("max", max)
    }
    $("#modalConfirmDeleteBtn").on("click", (function (event) {
        event.preventDefault(),
            $("#modalConfirmDelete").modal("hide");
        let targetId = $(this).attr("data-id") || 0
            , targetModule = $(this).attr("data-module") || "topic";
        if (targetId) {
            let deleteUrl, param;
            "topic" === targetModule ? (deleteUrl = `${DOMAIN}/users/topics`,
                param = {
                    id: parseInt(targetId)
                }) : (deleteUrl = `${DOMAIN}/la-so-user`,
                    param = {
                        id: parseInt(targetId)
                    }),
                Agents.delete(deleteUrl, param, (function (res) {
                    if ("200" == res.code) {
                        if ($(`div[data-id-card=${targetId}]`).remove(),
                            "topic" === targetModule) {
                            const containers = $("#widget-left").find("div[data-id=ls-container]")
                                , paginations = $("#widget-left").find("ul[class=pagination]")
                                , listTitle = ["Lá số trên chợ", "Đã thu hồi", "Đã trả xu mở bình luận khóa"]
                                , activePage = $(paginations[0]).find("li.paginationjs-page.J-paginationjs-page.active");
                            console.log(activePage);
                            let currentPage = activePage.length ? $(activePage[0]).attr("data-page") : 1;
                            const totalTopicOnPage = $(containers[0]).find("div[data-name=topic-market]");
                            currentPage > 1 && 0 == totalTopicOnPage.length && (currentPage -= 1),
                                profileGetList(`${DOMAIN}/users/topics?type=1&search=`, listTitle[0], "topic", $("#lstcCardProfile"), currentPage, $(containers[0]), $(paginations[0])),
                                profileGetList(`${DOMAIN}/users/topics?type=0&search=`, listTitle[1], "topic", $("#lstcCardProfile"), 1, $(containers[1]), $(paginations[1]))
                        }
                        if ("laso" === targetModule) {
                            const activePage = $("li.paginationjs-page.J-paginationjs-page.active");
                            let currentPage = activePage.attr("data-page") || 1;
                            const total_laso = $("#ls-container").find("div[data-name=la-so-da-tao]");
                            currentPage > 1 && 0 == total_laso.length && (currentPage -= 1),
                                profileGetList(`${DOMAIN}/users/la-so?`, "Lá số đã tạo", "laso", $("#lasoCardProfile"), currentPage)
                        }
                    }
                }
                ), (function (err) {
                    console.log(err)
                }
                ))
        } else
            console.log("Missing Topic ID")
    }
    )),
        $("a[name=toBoardRankPage]").click((function () {
            localStorage.setItem("openCollapse", "criteriaUser"),
                window.location.href = "/ho-tro-va-hoi-dap"
        }
        )),
        $("a[name=toBoardRankPageMaster]").click((function () {
            localStorage.setItem("openCollapse", "criteriaPro"),
                window.location.href = "/ho-tro-va-hoi-dap"
        }
        ))
}
function initTopTopicScreen() {
    const container = $("#pagination-topTopics")
        , totalNumber = parseInt($("#topTopicPageContainer").attr("data-total-top-topics"))
        , url = `${APIs.markets.top}`;
    container.pagination({
        dataSource: url,
        locator: "data.data",
        totalNumber: totalNumber,
        pageSize: 4,
        showPageNumbers: !0,
        showPrevious: !0,
        showNext: !0,
        showFirstOnEllipsisShow: !0,
        showLastOnEllipsisShow: !0,
        ajax: {},
        callback: function (res, pagination) {
            if (res) {
                const listTopTopics = res
                    , container = $("#topTopicPageContainer");
                container.empty(),
                    listTopTopics.forEach((function (item) {
                        item = topicItemHandler(item),
                            $("#topTopicPage").tmpl(item).appendTo("#topTopicPageContainer")
                    }
                    ))
            } else
                console.log("ERROR: ", res);
            initSaveTopicGlobal()
        }
    })
}
function initChoLasoScreen() {
    $("#btnUpLaso").addClass("d-none");
    const DEFAULT_MIN_BUDGET = 1e4
        , DEFAULT_MAX_BUDGET = 1e8;
    $("#min-budget-present").val(formatPrice(1e4)),
        $("#max-budget-present").val(formatPrice(1e8));
    const minEle = $("#min-budget")
        , maxEle = $("#max-budget");
    initSaveTopic(),
        $("#pushTopChoLaSo").click((function (e) {
            isLogged() ? window.location.href = "/profile?tab=3" : window.location.href = "/login?previous=/cho-la-so"
        }
        ));
    const widthBreak = 999900
        , stepBudget = 10221200;
    var breakPoints = []
        , startPoint = 1e4
        , endPoint = 1e4;
    for (let i = 1; i < 9; i++) {
        let point = {
            start: startPoint = endPoint + 10221200,
            end: endPoint = startPoint + 999900,
            class: "brake-point"
        };
        breakPoints.push(point)
    }
    var mySlider = $("#budgetSlider").slider({
        rangeHighlights: breakPoints
    });
    function initScreenChoLaSo() {
        const urlParams = new URLSearchParams(window.location.search)
            , page = urlParams.get("page") || 1;
        var params = {
            search: urlParams.get("search") || "",
            min: urlParams.get("min") || 1e4,
            max: urlParams.get("max") || 1e8,
            order: urlParams.get("order") || 0,
            tag: urlParams.get("tag") || 0
        };
        $("#min-budget-present").val(formatPrice(params.min)),
            $("#max-budget-present").val(formatPrice(params.max)),
            $("#list-tag-topic > .category").removeClass("current"),
            $(`#list-tag-topic > .category[data-id=${params.tag}]`).addClass("current"),
            $("#input-search-topic").val(params.search),
            $("#orderTopicBy").val(params.order);
        const min = parseFloat(params.min)
            , max = parseFloat(params.max);
        mySlider.slider("setValue", [min, max]),
            loadTopics(page, params, !0)
    }
    function loadOnClickPage() {
        $("#topics-pagination > li").on("click", (function (e) {
            const item = $(this);
            if (!item.hasClass("active") && !item.hasClass("disabled")) {
                const data = item.attr("data-page")
                    , page = parseInt(data)
                    , params = getSearchParam();
                loadTopics(page, params),
                    pushToHistory(page)
            }
        }
        ))
    }
    function pushToHistory(page) {
        const params = getSearchParam()
            , url = new URL(window.location);
        url.searchParams.set("page", page),
            url.searchParams.set("search", params.search),
            url.searchParams.set("min", params.min),
            url.searchParams.set("max", params.max),
            url.searchParams.set("order", params.order),
            url.searchParams.set("tag", params.tag || 0),
            window.history.pushState({
                params: params
            }, "", url)
    }
    function loadTopTopics(limit, page) {
        const container = $("#topTopicContainer");
        container.empty(),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>');
        const pre = $(".top-topic-container > .rectangle-left")
            , next = $(".top-topic-container > .rectangle-right");
        pre.removeClass("d-flex"),
            pre.addClass("d-none"),
            next.removeClass("d-flex"),
            next.addClass("d-none"),
            Agents.get(`${APIs.markets.top}?pageSize=${limit}&pageNumber=${page}`, (function (res) {
                setTimeout((function () {
                    if (res) {
                        const data = res.data;
                        if (data) {
                            console.log("data", data),
                                container.empty();
                            const items = data.data || []
                                , hasNext = data.page_info.has_next_page || !1
                                , hasPre = data.page_info.has_previous_page || !1
                                , page = data.page || 1;
                            items.forEach((function (item) {
                                const topicId = (item = topicItemHandler(item)).id || 0;
                                $("#topicsOrderBy").tmpl(item).appendTo("#topTopicContainer");
                                const user = item.user
                                    , isThay = user && user.is_thay;
                                isThay && $(`a[data-id-topic=${topicId}] .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="">')
                            }
                            )),
                                hasPre && (pre.removeClass("d-none"),
                                    pre.addClass("d-flex"),
                                    pre.attr("data-page", page)),
                                hasNext && (next.removeClass("d-none"),
                                    next.addClass("d-flex"),
                                    next.attr("data-page", page)),
                                $(".lazy").lazy()
                        }
                    }
                }
                ), 100)
            }
            ), (function (err) { }
            ))
    }
    function loadTopics(page, params, firstLoad) {
        firstLoad || $("html, body").animate({
            scrollTop: $("#topicsContainer").offset().top
        }, 500);
        const limit = 10
            , container = $("#topicsContainer");
        container.empty(),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>'),
            container.append('<div class="linear-background la-so-preview-item text-decoration-none right"></div>');
        var uri = `?pageSize=10&pageNumber=${page}`;
        if (params) {
            uri += `&max=${params.max}&min=${params.min}&search=${params.search}&order=${params.order}`;
            const tag = params.tag;
            tag && tag > 0 && (uri += `&tag=${tag}`)
        }
        Agents.get(`${APIs.markets.topics}${uri}`, (function (res) {
            if (res) {
                const data = res.data;
                data && setTimeout((function () {
                    const total = data.total_count || 0
                        , totalPage = data.total_page || 0
                        , currentPage = data.page || 1;
                    $("#total-topics").html(`Hiện có ${total} lá số`);
                    const items = data.data || [];
                    container.empty(),
                        $("#topics-pagination").css("display", "none"),
                        items.length ? (items.forEach((function (item) {
                            const topicId = (item = topicItemHandler(item)).id || 0
                                , card = $("#cardTopicMarket").tmpl(item);
                            card.appendTo("#topicsContainer");
                            const user = item.user
                                , isThay = user && user.is_thay;
                            item && item.media && item.media.path && $(`a#${topicId} .topic-picture-preview`).append(`<img class="topic-picture lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${item.media.path}" alt="topicPicture">`),
                                isThay && $(`a#${topicId} .username-topic`).append('<img src="/public/images/professor-verify.png" class="icon-professor-verify ml-1" alt="professorIc">');
                            var tagContainer = $(`a#${topicId} > div.list-tag`);
                            tagContainer && 1 == tagContainer.length && (tagContainer = tagContainer[0]);
                            const tags = item.tags || [];
                            if (tags.length > 0)
                                for (let i = 0; i < tags.length; i++) {
                                    const tagItem = tags[i]
                                        , idTag = tagItem.id || 0
                                        , iconTag = getIconTagTopic(idTag)
                                        , child = $(iconTag);
                                    var div = $("<div class='small-tag'></div>");
                                    div.html(child),
                                        $(tagContainer).find(".tag-container").append(div)
                                }
                            else
                                $(tagContainer).addClass("d-none"),
                                    $(tagContainer).empty();
                            var viewUserContainer = $(`a#${topicId} .list-view-user`)
                                , viewUsers = item.view_users || []
                                , totalViewUsers = item.total_view_user || 0;
                            if (totalViewUsers > 0) {
                                const maxUser = 5 == totalViewUsers ? 5 : totalViewUsers > 5 ? 4 : totalViewUsers;
                                for (let i = 0; i < maxUser; i++) {
                                    const user = viewUsers[i];
                                    var avatar = user ? user.avatar : "";
                                    avatar && "" != avatar || (avatar = "/public/images/avatars/avt-default.jpg");
                                    const name = user ? user.name : "";
                                    var img = $(`<img class="la-so-avt-activity lazy" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="${avatar}" title="${name}">`);
                                    $(viewUserContainer).append(img)
                                }
                                if (totalViewUsers > 5) {
                                    let moreUser = totalViewUsers - 4 > 99 ? 99 : totalViewUsers - 4;
                                    const more = $('<div class="la-so-preview-activity-more txt-sub-content"></div>').text(`+${moreUser}`);
                                    $(viewUserContainer).append(more)
                                }
                            }
                        }
                        )),
                            items && items.length && showPageHandler(totalPage, currentPage),
                            initSaveTopic(),
                            $(".lazy").lazy()) : container.append('<div class="text-center">Không có kết quả tìm kiếm</div>')
                }
                ), 100)
            }
        }
        ))
    }
    function showPageHandler(totalPage, currentPage) {
        var arrPage = [];
        if (totalPage > 0 && currentPage <= totalPage) {
            if (totalPage < 5)
                arrPage = Array.from(new Array(totalPage), (x, i) => i + 1);
            else if (currentPage <= 4)
                arrPage = Array.from(new Array(5), (x, i) => x + 1);
            else if (currentPage >= totalPage - 1)
                for (var i = totalPage - 4; i < totalPage + 1; i++)
                    arrPage.push(i);
            else
                arrPage = [currentPage - 2, currentPage - 1, currentPage, currentPage + 1, currentPage + 2];
            var containerPaging = $("#topics-pagination")
                , elementsPaging = [];
            if (currentPage > 1) {
                var backpage, back = `<li class="paginationjs-prev" data-page="${currentPage - 1}"><a class="cursor-pointer" >«</a></li>`;
                elementsPaging.push(back)
            } else {
                var back = '\n                                    <li class="paginationjs-prev disabled">\n                                     <a class="cursor-pointer">«</a>\n                                    </li>\n                                 ';
                elementsPaging.push(back)
            }
            if (arrPage.forEach((function (item) {
                var active, ele = `\n                                    <li class="paginationjs-page J-paginationjs-page ${item == currentPage ? "active" : ""}" data-page="${item}">\n                                          <a class="cursor-pointer">${item}</a>\n                                    </li>\n                                `;
                elementsPaging.push(ele)
            }
            )),
                currentPage < totalPage) {
                var nextpage, next = `\n                                    <li class="paginationjs-next" data-page="${currentPage + 1}">\n                                    <a class="cursor-pointer" >»</a>\n                                    </li>\n                                 `;
                elementsPaging.push(next)
            } else {
                var next = '\n                                    <li class="paginationjs-next disabled">\n                                    <a class="cursor-pointer">»</a>\n                                    </li>\n                                 ';
                elementsPaging.push(next)
            }
            containerPaging.html(elementsPaging),
                $("#topics-pagination").css("display", "block"),
                loadOnClickPage()
        }
    }
    function getSearchParam() {
        const search = $("#input-search-topic").val() || ""
            , min = $(minEle).val()
            , max = $(maxEle).val()
            , order = $("#orderTopicBy").val()
            , activeTag = $("#list-tag-topic > div.category.current");
        var tag = 0;
        if (activeTag) {
            const first = activeTag[0];
            first && (tag = $(first).attr("data-id"))
        }
        return {
            search: search,
            min: min,
            max: max,
            order: order,
            tag: tag
        }
    }
    function initSaveTopic() {
        $("button[name=saveTopic]").on("click", (function (event) {
            if (event.preventDefault(),
                isLogged())
                try {
                    const element = $(this)
                        , icon = "BUTTON" == event.target.nodeName ? $(event.target.children) : $(event.target)
                        , topicId = element.attr("data-id")
                        , isSaved = element.attr("data-save")
                        , url = `${DOMAIN}/user/saved-list`
                        , param = {
                            module: "TOPIC",
                            item_object: topicId
                        };
                    topicId ? "false" == isSaved ? Agents.post(url, param, (function (res) {
                        if (console.log("success ", res),
                            "200" == res.code) {
                            element.attr("data-save", "true"),
                                icon.attr("src", "/public/images/ic-saved.png");
                            const otherTopicSameId = $(`button[name=saveTopic][data-id=${topicId}]`);
                            console.log(otherTopicSameId),
                                otherTopicSameId.attr("data-save", "true"),
                                otherTopicSameId.html(icon)
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    )) : Agents.delete(url, param, (function (res) {
                        if (console.log("success ", res),
                            "200" == res.code) {
                            element.attr("data-save", "false"),
                                icon.attr("src", "/public/images/ic-save.png");
                            const otherTopicSameId = $(`button[name=saveTopic][data-id=${topicId}]`);
                            console.log(otherTopicSameId),
                                otherTopicSameId.attr("data-save", "false"),
                                otherTopicSameId.html(icon)
                        }
                    }
                    ), (function (err) {
                        console.log(err)
                    }
                    )) : console.log("Missing Topic ID")
                } catch (err) {
                    console.log("error: ", err)
                }
            else
                openModalLogin(event)
        }
        ))
    }
    mySlider.on("slide", (function (e) {
        const budget = e.value;
        if (budget && 2 == budget.length) {
            const start = budget[0] || 1e4
                , end = budget[1] || 1e8;
            $("#min-budget-present").val(formatPrice(start)),
                $("#max-budget-present").val(formatPrice(end))
        }
    }
    )),
        mySlider.on("slideStop", (function (e) {
            const budget = e.value
                , start = budget[0]
                , end = budget[1];
            $(minEle).val(start),
                $("#min-budget-present").val(formatPrice(start)),
                $(maxEle).val(end),
                $("#max-budget-present").val(formatPrice(end))
        }
        )),
        $(minEle).on("change", (function (e) {
            const max = parseFloat($(maxEle).val())
                , val = parseFloat($(this).val())
                , min = val > 1e4 ? val < max ? val : max - 1 : 1e4;
            mySlider.slider("setValue", [min, max]),
                $(this).val(min),
                $("#min-budget-present").val(formatPrice(min))
        }
        )),
        $("#min-budget-present, #max-budget-present").on("keydown", (function (e) {
            const regexInputBudget = /^[\d]$/
                , special = [8, 17, 18, 37, 38, 39, 40, 46];
            regexInputBudget.test(e.key) || special.includes(e.keyCode) || e.preventDefault(),
                0 == $(this).val().length && 48 == e.keyCode && e.preventDefault()
        }
        )),
        $("#min-budget-present, #max-budget-present").on("keyup", (function (e) {
            const val = $(this).val();
            val.length > 1 && $(this).val(formatPriceNew(val))
        }
        )),
        $("#min-budget-present").on("change", (function () {
            const val = $(this).val();
            $(minEle).val(val.replaceAll(".", "")),
                $(minEle).trigger("change")
        }
        )),
        $("#max-budget-present").on("change", (function () {
            const val = $(this).val();
            $(maxEle).val(val.replaceAll(".", "")),
                $(maxEle).trigger("change")
        }
        )),
        $(maxEle).on("change", (function (e) {
            const min = parseFloat($(minEle).val())
                , val = parseFloat($(this).val())
                , max = val < 1e8 ? val > min ? val : min + 1 : 1e8;
            mySlider.slider("setValue", [min, max]),
                $(this).val(max),
                $("#max-budget-present").val(formatPrice(max))
        }
        )),
        loadTopTopics(4, 1),
        $(".top-topic-container > .rectangle-left").on("click", (function () {
            const page = $(this).attr("data-page");
            var p = parseInt(page) - 1;
            p >= 1 && loadTopTopics(4, p)
        }
        )),
        $(".top-topic-container > .rectangle-right").on("click", (function () {
            const page = $(this).attr("data-page")
                , p = parseInt(page) + 1;
            loadTopTopics(4, p)
        }
        )),
        $("#list-tag-topic > .category").on("click", (function () {
            $("#list-tag-topic > .category").removeClass("current"),
                $(this).addClass("current");
            const params = getSearchParam();
            loadTopics(1, params),
                pushToHistory(1)
        }
        )),
        $("#btnFilterBudget").on("click", (function () {
            const params = getSearchParam();
            loadTopics(1, params),
                pushToHistory(1)
        }
        )),
        $("#btn-search-topic").on("click", (function () {
            const params = getSearchParam();
            loadTopics(1, params),
                pushToHistory(1)
        }
        )),
        $("#input-search-topic").keyup((function (e) {
            if (13 == e.keyCode) {
                const params = getSearchParam();
                loadTopics(1, params),
                    pushToHistory(1)
            }
        }
        )),
        $("#orderTopicBy").on("change", (function () {
            const params = getSearchParam();
            loadTopics(1, params),
                pushToHistory(1)
        }
        )),
        $("#criteriaUser").click((function () {
            localStorage.setItem("openCollapse", "criteriaUser"),
                window.location.href = "/ho-tro-va-hoi-dap"
        }
        )),
        $("#criteriaPro").click((function () {
            localStorage.setItem("openCollapse", "criteriaPro"),
                window.location.href = "/ho-tro-va-hoi-dap"
        }
        )),
        $("#ruleSocial").click((function () {
            localStorage.setItem("openCollapse", "ruleSocial"),
                window.location.href = "/ho-tro-va-hoi-dap"
        }
        )),
        initScreenChoLaSo(),
        window.onpopstate = function (event) {
            initScreenChoLaSo()
        }
        ;
    const expandEles = $("#expandParagraph");
    if (expandEles.length > 0) {
        const expandEle = expandEles[0]
            , heightTemp = expandEle.scrollHeight;
        heightTemp > 300 ? (expandEles.attr("style", "height: 300px"),
            $("#readMore").on("click", (function () {
                const h = heightTemp + "px";
                expandEles.attr("style", "height: " + h),
                    $(this).empty()
            }
            ))) : $("#readMore").empty()
    }
    const btnModes = $(".change-la-so-layout");
    for (let i = 0; i < btnModes.length; i++) {
        const btn = btnModes[i];
        $(btn).click((function () {
            var mode;
            btnModes.removeClass("change-la-so-layout-active"),
                $(this).addClass("change-la-so-layout-active"),
                ("1" === $(this).attr("data-mode") ? 1 : 0) ? $("#topicsContainer").attr("class", "la-so-preview-grid-layout") : $("#topicsContainer").attr("class", "la-so-preview-row-layout")
        }
        ))
    }
    $("#btn-create-laso").click((function (event) {
        isLogged() ? window.location.href = "/dang-la-so" : openModalLogin(event)
    }
    ));
    let filterContainer = $("#filter-container");
    var blockFilter = $("#filter-block");
    const heightTemp = blockFilter.scrollHeight;
    let width;
    $(window).width() > 768 ? backFilterToDefaultPosition() : putFilterToBlockMobile(),
        $("#btnFilterChoLaSo").click((function () {
            const filterMobileStatus = "true" === $(this).attr("data-expanded");
            if (filterMobileStatus)
                $(this).attr("style", "background-color: white"),
                    $(this).attr("data-expanded", !1),
                    blockFilter.attr("style", "height: 0px"),
                    filterContainer.addClass("d-none");
            else {
                $(this).attr("style", "background-color: var(--line-color)"),
                    $(this).attr("data-expanded", !0);
                const h = heightTemp + "px";
                blockFilter.attr("style", "height: " + h),
                    filterContainer.removeClass("d-none")
            }
        }
        ))
}
function putFilterToBlockMobile() {
    let searchBar = $(".div-search-topic");
    $("#filter-block").append(searchBar);
    let filterContainer = $("#filter-container");
    filterContainer.addClass("remove-padding-widget"),
        filterContainer.attr("style", "outline: none !important"),
        filterContainer.addClass("d-none"),
        $("#filter-block").append(filterContainer),
        $("#call-for-purchase-container-mobile").removeClass("d-none"),
        $("#call-for-purchase-container-web").addClass("d-none")
}
function backFilterToDefaultPosition() {
    let searchBar = $(".div-search-topic");
    $("#default-filter-position").append(searchBar);
    let filterContainer = $("#filter-container");
    filterContainer.removeClass("remove-padding-widget"),
        filterContainer.removeClass("d-none"),
        filterContainer.removeAttr("style"),
        $("#default-filter-position").append(filterContainer),
        $("#call-for-purchase-container-mobile").addClass("d-none"),
        $("#call-for-purchase-container-web").removeClass("d-none")
}
function resizeChoLaso() {
    const right = $("#right-content-sticky-cho-la-so")
        , width = $(window).width();
    width < 769 ? right.removeClass("sticky-top") : right.addClass("sticky-top")
}
function initPayment() {
    $("div.payments-container > div.payments").on("click", (function () {
        $("div.payments-container > div.payments").removeClass("payments-active"),
            $(this).addClass("payments-active");
        const container = $(this).attr("data-content");
        container && ($(".bank-container").addClass("d-none"),
            $("#" + container).removeClass("d-none"))
    }
    )),
        $("div.denominations-container > div.denominations").on("click", (function () {
            $("div.denominations-container > div.denominations").removeClass("denominations-active"),
                $(this).addClass("denominations-active");
            const display = $(this).attr("data-display");
            $("div.price-display > div:nth-child(2)").text(display)
        }
        )),
        $("div.bank-container > div.banks").on("click", (function () {
            $("div.bank-container > div.banks").removeClass("banks-active"),
                $(this).addClass("banks-active")
        }
        )),
        $("#paid").on("click", (function () {
            if (isLogged()) {
                const btn = $(this);
                btn.attr("disabled", !0),
                    btn.empty(),
                    btn.append('<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>');
                var method = $("div.payments-container > div.payments.payments-active").attr("data-method")
                    , amount = $("div.denominations-container > div.denominations.denominations-active").attr("data-value")
                    , bank = $("div.bank-container > div.banks.banks-active").attr("data-id");
                if (console.log(bank, method, amount),
                    bank && method && amount) {
                    var payload = {
                        amount: parseInt(amount),
                        bank: bank,
                        method: method
                    };
                    Agents.post(APIs.payments.requestPayment, payload, (function (res) {
                        if (btn.html("Thanh toán"),
                            btn.attr("disabled", !1),
                            "200" == res.code) {
                            const href = res.data;
                            href && (window.location.href = href)
                        } else
                            alert("Có lỗi sảy ra !")
                    }
                    ), (function (err) {
                        alert("Có lỗi sảy ra !"),
                            btn.attr("disabled", !1)
                    }
                    ))
                } else
                    alert("Vui lòng chọn ngân hàng!");
                btn.attr("disabled", !1),
                    btn.html("Thanh toán")
            }
        }
        ))
}
function initDetailTopic(path) {
    var topic = $("#detail-topic").attr("data-id");
    console.log("init detail topic", topic),
        $("#widget-comment").empty();
    var page = 1, hrefTopic = window.location.href, urlTopic, c = new URL(hrefTopic).searchParams.get("comment"), url = `${APIs.markets.comment}?topic=${topic}&limit=10&page=1&commentId=${c}`, fileImg = [], fileImgEdit = [], contentsForEdit = [], priceSuggest = parseInt($("#detail-topic").attr("data-suggest-price"));
    function upload(id, files) {
        return new Promise((function (resolve, reject) {
            files && files.length > 0 ? uploadImgToSever(files, (function (res) {
                res && "200" == res.code && resolve({
                    id: id,
                    images: res.data
                })
            }
            )) : resolve({
                id: id,
                images: []
            })
        }
        ))
    }
    function postComment(btn, res, content, type, timeNow, avatar, name, username, rankId, rankTitle, price, textTotal, textTotalKey, totalComment, totalCommentKey, idBtnPost, parent) {
        const { data: data } = res
            , { id: id } = data
            , dataComment = {
                id: id,
                content: content,
                type: type,
                created: timeNow,
                time: sinceTime(timeNow),
                like_count: 0,
                null_like: "d-none",
                owner_report: "d-none",
                is_mod: "d-none",
                total_unlock_str: "d-none",
                user: {
                    avatar: avatar || "/public/images/avatars/avt-default.jpg",
                    name: name,
                    username: username,
                    rank: {
                        title: rankTitle,
                        id: rankId
                    },
                    rank_id: rankId,
                    is_teacher: checkRole() ? "" : "d-none"
                }
            };
        var indexFirst;
        if (2 == type)
            dataComment.price = formatPrice(price),
                dataComment.price_null_formart = price;
        else if (content && content.split("\n").length - 1 > 5) {
            if (indexFirst = getPosition(content, "\n", 4)) {
                var firstContent = content.substring(0, indexFirst)
                    , secondContent = content.substring(indexFirst, content.length);
                firstContent && secondContent && (dataComment.is_view_more = "",
                    dataComment.show_line = "line-clamp-4",
                    dataComment.content_new = `${firstContent} <span class="d-none" id="more-${id}"> ${secondContent} </span> <span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${id}" id="dots-${id}">Xem thêm</span>`)
            }
        } else if (content && content.length > 500) {
            var indexFirst;
            if (indexFirst = 500) {
                var firstContent = content.substring(0, indexFirst)
                    , secondContent = content.substring(indexFirst, content.length);
                firstContent && secondContent && (dataComment.is_view_more = "",
                    dataComment.show_line = "line-clamp-4",
                    dataComment.content_new = `${firstContent} <span class="d-none" id="more-${id}"> ${secondContent} </span> <span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${id}" id="dots-${id}">Xem thêm</span>`)
            }
        } else
            dataComment.content_new = content,
                dataComment.is_view_more = "d-none";
        if (parent)
            if (dataComment.is_sub = "sub-cmt-margin",
                dataComment.isSub = !0,
                dataComment.id_comment = id,
                dataComment.id = parent,
                $(`#sub-comment-${parent}`).length > 0) {
                const obj = {
                    item: dataComment
                };
                if (1 == type) {
                    $.template("commentDefaultTemplate", commentDefaultTemplate);
                    var tmpl = checkMod() ? $.tmpl("commentDefaultTemplate", obj) : $("#comment-default-user").tmpl(obj);
                    $(`#sub-comment-${parent}`).append(tmpl),
                        textTotal.text(totalComment + 1)
                } else {
                    var tmpl = $("#comment-key-mine").tmpl(obj), contentComment;
                    forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), dataComment.content, id),
                        $(`#sub-comment-${parent}`).append(tmpl),
                        textTotal.text(totalComment + 1),
                        textTotalKey.text(totalCommentKey + 1)
                }
            } else {
                const d = document.createElement("div");
                $(d).attr("id", `sub-comment-${parent}`);
                const obj = {
                    item: dataComment
                };
                if (1 == type) {
                    $.template("commentDefaultTemplate", commentDefaultTemplate);
                    var tmpl = checkMod() ? $.tmpl("commentDefaultTemplate", obj) : $("#comment-default-user").tmpl(obj);
                    $(d).append(tmpl),
                        $(d).insertAfter(`#comment-${parent}`),
                        textTotal.text(totalComment + 1)
                } else {
                    var tmpl = $("#comment-key-mine").tmpl(obj), contentComment;
                    forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), dataComment.content, id),
                        $(d).append(tmpl),
                        $(d).insertAfter(`#comment-${parent}`),
                        textTotal.text(totalComment + 1),
                        textTotalKey.text(totalCommentKey + 1)
                }
            }
        else {
            const obj = {
                item: dataComment
            };
            if (1 == type) {
                $.template("commentDefaultTemplate", commentDefaultTemplate);
                var tmpl = checkMod() ? $.tmpl("commentDefaultTemplate", obj) : $("#comment-default-user").tmpl(obj);
                $("#container-comment").prepend(tmpl),
                    textTotal.text(totalComment + 1)
            } else {
                var tmpl = $("#comment-key-mine").tmpl(obj), contentComment;
                forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), dataComment.content, id),
                    $("#container-comment").prepend(tmpl),
                    textTotal.text(totalComment + 1),
                    textTotalKey.text(totalCommentKey + 1)
            }
        }
        $("#content-comment-" + idBtnPost).val(""),
            $(".content-comment-teacher-" + idBtnPost).val(""),
            $("#select-price-comment-" + idBtnPost).val("0"),
            $(`.comment-default-topic[data-id-comment=${idBtnPost}]`).click(),
            $(".lenght-comment").text("0"),
            "container" != idBtnPost && $("#form-comment-" + idBtnPost).remove(),
            btn.empty(),
            btn.text("Đăng");
        const path = window.location.pathname;
        deleteCommentDraft(path)
    }
    function editComment(btn, id, type, price, content_new, is_view_more, content) {
        var subComment = $("div#content-comment-topic[data-sub-id='" + id + "']")
            , comment = $("div#content-comment-topic[data-id='" + id + "']")
            , priceComment = $("div#price-comment-topic[data-id='" + id + "']")
            , priceSubComment = $("div#price-comment-topic[data-sub-id='" + id + "']");
        if (subComment.length > 0) {
            var btnSubEdit = $("li.edit-comment[data-sub-id='" + id + "']");
            2 == type ? (subComment.empty(),
                forContentCommentKey(subComment, content, id),
                priceSubComment.text(`${formatPrice(price)}`),
                btnSubEdit.attr("data-price", price)) : (btnSubEdit.attr("data-content", content),
                    checkMod() ? (subComment.html(content_new),
                        is_view_more ? subComment.next().addClass("d-none") : subComment.next().removeClass("d-none")) : (subComment.text(content_new),
                            subComment.removeClass("line-clamp-4"),
                            subComment.next().removeClass("d-none"),
                            is_view_more ? subComment.next().addClass("d-none") : (subComment.addClass("line-clamp-4"),
                                subComment.next().text("Xem thêm"))))
        } else {
            var btnEdit = $("li.edit-comment[data-id='" + id + "']")
                , commentChange = comment[0];
            2 == type ? ($(commentChange).empty(),
                forContentCommentKey($(commentChange), content, id),
                $(btnEdit[0]).attr("data-price", price),
                $(priceComment[0]).text(`${formatPrice(price)}`)) : ($(btnEdit[0]).attr("data-content", content),
                    checkMod() ? ($(commentChange).html(content_new),
                        is_view_more ? $(commentChange).next().addClass("d-none") : $(commentChange).next().removeClass("d-none")) : ($(commentChange).text(content_new),
                            $(commentChange).removeClass("line-clamp-4"),
                            $(commentChange).next().removeClass("d-none"),
                            is_view_more ? $(commentChange).next().addClass("d-none") : ($(commentChange).addClass("line-clamp-4"),
                                $(commentChange).next().text("Xem thêm"))))
        }
        var listContainerImg = document.querySelectorAll(".view-image-comment");
        listContainerImg && listContainerImg.forEach(item => {
            $(item).remove()
        }
        ),
            btn.empty(),
            btn.text("Xác nhận"),
            $("#editCommentModal").modal("hide")
    }
    Agents.get(url, (function (res) {
        if (console.log("res: ", res),
            res && 200 == res.code) {
            const dataListComment = res.data.data;
            res.data && res.data.page_info && !res.data.page_info.has_next_page && (res.data.page_info.next = "d-none"),
                res.data && res.data.page_info && !res.data.page_info.has_previous_page && (res.data.page_info.previous = "d-none"),
                checkRole() || (res.data.is_role = "d-none"),
                $("#widget-comment-topic").tmpl(res.data).appendTo("#widget-comment");
            var container = $("#container-comment");
            getListComment(dataListComment, container),
                c && goToByScroll(`comment-${c}`),
                container.append(`\n                    <script type="text/javascript">\n                        $('#next-page-comment').on('click', function() {\n                            const btn = $(this)\n                            var pageNew = $(this).attr('data-page')\n                            var hasNextPage = $(this).attr('data-has-next-page')\n                            if(hasNextPage) {\n                                pageNew = parseInt(pageNew) + 1;\n                                var valueSelect = $('#change-option-comment').val();\n                                var url = "${APIs.markets.comment}" + "?topic=${topic}&limit=10&page=" + pageNew + "&orderType=" + valueSelect;\n                                Agents.get(url, function(res) {\n                                    if(res && res.code == 200) {\n                                        const dataApi = res.data\n                                        console.log('next page: ', dataApi.page_info);\n                                        btn.attr('data-page', dataApi.page)\n                                        btn.attr('data-has-next-page', dataApi.page_info.has_next_page)\n                                        if(!dataApi.page_info.has_next_page) {\n                                            btn.addClass('d-none')\n                                        }\n                                        const dataListComment = dataApi.data\n                                        var container = $('#container-comment');\n                                        getListComment(dataListComment, container)\n                                    }\n                                }, function(err) {\n                                    console.log("error: ", err)\n                                })\n                          }\n                        })\n                        $('#previous-page-comment').on('click', function() {\n                            const btn = $(this)\n                            var pageNew = $(this).attr('data-page')\n                            var hasNextPage = $(this).attr('data-has-next-page')\n                            if(hasNextPage) {\n                                pageNew = parseInt(pageNew) - 1;\n                                var valueSelect = $('#change-option-comment').val();\n                                var url = "${APIs.markets.comment}" + "?topic=${topic}&limit=10&page=" + pageNew + "&orderType=" + valueSelect;\n                                Agents.get(url, function(res) {\n                                    if(res && res.code == 200) {\n                                        const dataApi = res.data\n                                        console.log('next page: ', dataApi.page_info);\n                                        btn.attr('data-page', dataApi.page)\n                                        btn.attr('data-has-next-page', dataApi.page_info.has_previous_page)\n                                        if(!dataApi.page_info.has_previous_page) {\n                                            btn.addClass('d-none')\n                                        }\n                                        const dataListComment = dataApi.data\n                                        var container = $('#container-comment');\n                                        getListComment(dataListComment, container, true)\n                                    }\n                                }, function(err) {\n                                    console.log("error: ", err)\n                                })\n                          }\n                        })\n                    <\/script>       \n                `)
        }
    }
    ), (function (err) {
        console.log("error: ", err)
    }
    )),
        saveDraftComment(path),
        $("#btn-hide-topic").on("click", (function () {
            const idTopic = $(this).attr("data-id-topic") || 0;
            $("#modConfirmHide").attr("data-id", idTopic),
                $("#modConfirmHide").attr("data-target-type", "")
        }
        )),
        $(document.body).on("click", (function (e) {
            var newPath = path.split("-")
                , topic = 0
                , last = newPath[newPath.length - 1];
            if (last && (topic = last.replace("t", "")),
                $(e.target).hasClass("btn-like-comment"))
                if (isLogged()) {
                    const btn = $(e.target);
                    var id = btn.attr("data-id")
                        , subId = btn.attr("data-sub-id")
                        , param = {};
                    subId ? (param.parent_id = parseInt(id),
                        param.id = parseInt(subId)) : param.id = parseInt(id),
                        console.log("param: ", param),
                        btn.hasClass("cmt-like") ? Agents.post(APIs.markets.unLike, param, (function (res) {
                            if (console.log("res", res),
                                res && 200 == res.code) {
                                btn.removeClass("cmt-like");
                                var likeCount = btn.next()
                                    , count = parseInt(likeCount.text());
                                1 == count ? (likeCount.addClass("d-none"),
                                    likeCount.text(0)) : likeCount.text(count - 1)
                            }
                        }
                        ), (function (err) {
                            console.log("error", err)
                        }
                        )) : Agents.post(APIs.markets.like, param, (function (res) {
                            if (console.log("res", res),
                                res && 200 == res.code) {
                                btn.addClass("cmt-like");
                                var likeCount = btn.next();
                                if (likeCount.hasClass("d-none"))
                                    likeCount.removeClass("d-none"),
                                        likeCount.text(1);
                                else {
                                    var count = parseInt(likeCount.text());
                                    likeCount.text(count + 1)
                                }
                            }
                        }
                        ), (function (err) {
                            console.log("error", err)
                        }
                        ))
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("btn-rep-comment"))
                if (isLogged()) {
                    const thisBtn = $(e.target);
                    var idComment = thisBtn.attr("data-id")
                        , isSub = thisBtn.attr("data-sub")
                        , idSubComment = thisBtn.attr("data-sub-id")
                        , dataTmpl = {
                            id_parent: idComment
                        };
                    if (dataTmpl.id = idSubComment || idComment,
                        checkRole() || (dataTmpl.is_role = "d-none"),
                        console.log("abc", $(`#form-comment-${dataTmpl.id}`).length),
                        0 == $(`#form-comment-${dataTmpl.id}`).length)
                        if ("true" == isSub)
                            if (idSubComment) {
                                var abc = `div[id=comment-${idComment}][data-sub-id=${idSubComment}]`;
                                $("#template-comment-topic").tmpl(dataTmpl).insertAfter(abc),
                                    $(`#content-comment-${idSubComment}`).focus()
                            } else
                                $("#template-comment-topic").tmpl(dataTmpl).insertAfter("#comment-" + idComment),
                                    $(`#content-comment-${idComment}`).focus();
                        else
                            $("#template-comment-topic").tmpl(dataTmpl).insertAfter("#comment-" + idComment),
                                $(`#content-comment-${idComment}`).focus()
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("edit-comment"))
                if (isLogged()) {
                    fileImgEdit = [];
                    var btn, content = (btn = $(e.target)).attr("data-content"), type = btn.attr("data-type"), is_paid = btn.attr("data-paid"), price = btn.attr("data-price"), id = btn.attr("data-id"), subId = btn.attr("data-sub-id"), inputComment;
                    if (console.log("a: ", content, type, is_paid, id, subId, price),
                        (inputComment = $("#editCommentInput")).attr("data-type", type),
                        subId ? inputComment.attr("data-id", subId) : inputComment.attr("data-id", id),
                        1 == type)
                        $("#formInputPrice").addClass("d-none"),
                            $("#form-input-default-comment").removeClass("d-none"),
                            content && inputComment.val(content);
                    else {
                        var listContent;
                        $("#list-content-edit").empty(),
                            subId ? (listContent = $(`.content-comment-topic[data-id=${id}][data-sub-id=${subId}]`),
                                console.log("listContent1: ", listContent)) : (listContent = $(`.content-comment-topic[data-id=${id}]`),
                                    console.log("listContent2: ", listContent[0].childList));
                        var contents = []
                            , listContents = [];
                        listContent && listContent[0].childNodes.forEach((item, index) => {
                            const tagName = $(item).prop("tagName");
                            "SPAN" == tagName ? $(item).hasClass("txt-content") ? contents.push(item) : $(item).hasClass("text-decoration-underline") || item.childNodes.forEach((i, idx) => {
                                contents.push(i)
                            }
                            ) : contents.push(item)
                        }
                        ),
                            contents && contents.forEach((item, index) => {
                                const tagName = $(item).prop("tagName");
                                "P" == tagName ? listContents.push({
                                    title: item.textContent,
                                    images: [],
                                    index: index
                                }) : "SPAN" == tagName ? (listContents[listContents.length - 1].content = item.textContent,
                                    listContents[listContents.length - 1].length = item.textContent.length) : item.childNodes.forEach((c, cdx) => {
                                        $(c).hasClass("image-comment-key") && (console.log("c: ", c),
                                            listContents[listContents.length - 1].images.push({
                                                id: parseInt($(c).attr("data-key")),
                                                path: $(c).attr("src")
                                            }))
                                    }
                                    )
                            }
                            ),
                            console.log("contents: ", contents),
                            console.log("listContents: ", listContents),
                            contentsForEdit = listContents,
                            listContents && listContents.forEach((item, index) => {
                                const obj = {
                                    item: item
                                };
                                var tmpl = $("#template-input-item-comment").tmpl(obj);
                                $("#list-content-edit").append(tmpl),
                                    item.images.forEach(i => {
                                        const img = `<div class="view-image-comment"><img src="${i.path}" class="image-comment-upload" alt=""><div class="cursor-pointer delete-image-comment" data-id="${i.id}" data-type="edit" data-key="edit"><div class="total-icon icon-delete-image-comment"></div></div></div>`;
                                        $(`.list-image-comment-${item.index}-edit`).append(img)
                                    }
                                    )
                            }
                            ),
                            $("#priceCommentInput").val(price),
                            $("#formInputPrice").removeClass("d-none"),
                            $("#form-input-default-comment").addClass("d-none")
                    }
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("delete-comment"))
                if (isLogged()) {
                    var btn = $(e.target)
                        , id = parseInt(btn.attr("data-id"))
                        , subId = parseInt(btn.attr("data-sub-id"))
                        , type = parseInt(btn.attr("data-type"));
                    console.log("id:", id, " sub: ", subId);
                    var btnAcceptDelete = $("#btn-check-delete-comment-topic");
                    btnAcceptDelete.attr("data-id", id),
                        btnAcceptDelete.attr("data-sub-id", subId),
                        btnAcceptDelete.attr("data-type", type)
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("report-comment"))
                if (console.log("report"),
                    isLogged()) {
                    var btn = $(e.target)
                        , id = parseInt(btn.attr("data-id"))
                        , subId = parseInt(btn.attr("data-sub-id"))
                        , inputComment = $("#reportCommentInput");
                    subId ? inputComment.attr("data-id", subId) : inputComment.attr("data-id", id)
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("comment-teacher")) {
                var btn = $(e.target);
                if (isLogged())
                    if (checkRole()) {
                        var id = btn.attr("data-id-comment");
                        $("#form-for-teacher-" + id).removeClass("d-none"),
                            $("#content-comment-" + id).addClass("d-none"),
                            $("#btn-comment-default-" + id).addClass("color-brand"),
                            $("#btn-comment-default-" + id).attr("data-type", 2),
                            setCommentDraft(path)
                    } else
                        $(".comment-default-topic").click(),
                            openModalHaveError("Chức năng chưa được mở khóa", "Tính năng này áp dụng cho tài khoản Thầy, vui lòng liên hệ Tuvi.vn để biết thêm thông tin!");
                else
                    $(".comment-default-topic").click(),
                        openModalLogin(e)
            } else if ($(e.target).hasClass("comment-default-topic")) {
                var btn, id = (btn = $(e.target)).attr("data-id-comment");
                $("#form-for-teacher-" + id).addClass("d-none"),
                    $("#content-comment-" + id).removeClass("d-none"),
                    $("#btn-comment-default-" + id).removeClass("color-brand"),
                    $("#btn-comment-default-" + id).attr("data-type", 1)
            } else if ($(e.target).hasClass("next-page-comment-sub")) {
                const btn = $(e.target);
                var pageNew = btn.attr("data-page")
                    , hasNextPage = btn.attr("data-has-next-page")
                    , idParent = btn.attr("data-parent");
                if (hasNextPage) {
                    pageNew = parseInt(pageNew) + 1;
                    var url = `${APIs.markets.comment}?topic=${topic}&limit=5&page=${pageNew}&parent=${idParent}`;
                    Agents.get(url, (function (res) {
                        if (res && 200 == res.code) {
                            const dataApi = res.data;
                            btn.attr("data-page", dataApi.page),
                                btn.attr("data-has-next-page", dataApi.page_info.has_next_page),
                                dataApi.page_info.has_next_page || btn.addClass("d-none");
                            const dataListComment = dataApi.data;
                            getComment(dataListComment, $("#sub-comment-" + idParent), dataApi.page, dataApi.page_info.has_next_page, idParent, !0)
                        }
                    }
                    ), (function (err) {
                        console.log("error: ", err)
                    }
                    ))
                }
            } else if ($(e.target).hasClass("btn-open-comment-key")) {
                const btn = $(e.target)
                    , btnOpenKey = $("#btn-open-comment-key-topic");
                var id = btn.attr("data-id")
                    , idSub = btn.attr("data-sub-id")
                    , price = btn.attr("data-price")
                    , priceNull = btn.attr("data-price-no-format");
                isLogged() ? id && (idSub ? btnOpenKey.attr("data-id", idSub) : btnOpenKey.attr("data-id", id),
                    btnOpenKey.attr("data-price", priceNull),
                    $("#price-comment-key-topic").text(price)) : openModalLogin(e)
            } else if ($(e.target).hasClass("btn-comment-default"))
                if (isLogged()) {
                    const btn = $(e.target);
                    btn.attr("data-target", ""),
                        btn.attr("data-toggle", "");
                    var idBtnPost = btn.attr("data-id-comment")
                        , topic = btn.attr("data-topic")
                        , type = btn.attr("data-type")
                        , avatar = btn.attr("data-avatar")
                        , name = btn.attr("data-name")
                        , username = btn.attr("data-username")
                        , parent = btn.attr("data-parent")
                        , rankId = btn.attr("data-rank-id")
                        , rankTitle = btn.attr("data-rank-title")
                        , content = $("#content-comment-" + idBtnPost).val().trim()
                        , timeNow = new Date
                        , price = 0
                        , checkLenghtContent = !0
                        , formComment = [];
                    if (btn.empty(),
                        btn.append('<div class="d-flex justify-content-center align-items-center spinner-image-comment" id="spinner-image-comment">\n                        <div class="spinner-border" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                     </div>'),
                        btn.hasClass("color-brand")) {
                        var titleList = document.querySelectorAll(`.title-comment-teacher-${idBtnPost}`)
                            , contentList = document.querySelectorAll(`.content-comment-teacher-${idBtnPost}`)
                            , listTitle = []
                            , listContent = [];
                        titleList && titleList.forEach((item, index) => {
                            const titleM = $(item).text().trim();
                            listTitle.push(titleM)
                        }
                        ),
                            console.log("list File: ", fileImg),
                            contentList && contentList.forEach(item => {
                                const contentM = $(item).val()
                                    , key = $(item).attr("data-key");
                                contentM.trim().length < 200 && (checkLenghtContent = !1),
                                    listContent.push({
                                        id: key,
                                        content: contentM
                                    })
                            }
                            ),
                            checkLenghtContent && listContent.forEach((item, index) => {
                                var find = fileImg.find(i => i.id == item.id)
                                    , images = find ? find.listFile : []
                                    , itemComment = {
                                        id: item.id || "",
                                        content: item.content || "",
                                        title: listTitle[index] || "",
                                        images: images
                                    };
                                formComment.push(itemComment)
                            }
                            ),
                            console.log("title: ", listTitle),
                            console.log("content: ", listContent),
                            console.log("formComment: ", formComment),
                            formComment && formComment.length > 0 && (content = formComment,
                                price = parseInt($(`#select-price-comment-${idBtnPost}`).val()))
                    }
                    if (console.log("zo", price, content, parent, sinceTime(timeNow), topic, type),
                        1 == type && content.length > 1e3 && (content = ""),
                        content && content.length > 0 && topic && type) {
                        var param = {
                            topic: parseInt(topic)
                        };
                        1 == type ? (param.content = content,
                            param.type = parseInt(type)) : param.contents = content,
                            parent && (param.parent = parseInt(parent)),
                            checkLenghtContent && (param.price = price),
                            console.log("param: ", param);
                        var textTotal = $("#total-comment")
                            , textTotalKey = $("#total-comment-key")
                            , totalComment = parseInt(textTotal.text())
                            , totalCommentKey = parseInt(textTotalKey.text())
                            , contents = param.contents;
                        console.log("contenssssss: ", contents);
                        var promises = [];
                        contents && contents.forEach((function (i) {
                            promises.push(upload(i.id, i.images))
                        }
                        )),
                            promises && promises.length > 0 && Promise.all(promises).then((function (res) {
                                let contents;
                                console.log("res", res),
                                    param.contents.forEach((function (c) {
                                        let find = res.find(i => i.id == c.id);
                                        if (find) {
                                            var ids = [];
                                            find.images.forEach((function (t) {
                                                ids.push({
                                                    id: t.id,
                                                    path: t.path
                                                })
                                            }
                                            )),
                                                c.images = ids,
                                                delete c.id
                                        }
                                    }
                                    )),
                                    console.log("---------------", param),
                                    Agents.post(APIs.markets.commentMaster, param, (function (res) {
                                        if (res && 200 == res.code) {
                                            postComment(btn, res, content, type, timeNow, avatar, name, username, rankId, rankTitle, price, textTotal, textTotalKey, totalComment, totalCommentKey, idBtnPost, parent),
                                                fileImg = [];
                                            var listContainerImg = document.querySelectorAll(".view-image-comment");
                                            listContainerImg && listContainerImg.forEach(item => {
                                                $(item).remove()
                                            }
                                            )
                                        }
                                    }
                                    ), (function (err) {
                                        btn.empty(),
                                            btn.text("Đăng"),
                                            openModalHaveError("Chưa viết bình luận", "Để đăng bình luận khóa bạn vui lòng viết đầy đủ bình luận!")
                                    }
                                    ))
                            }
                            ), (function (err) {
                                btn.empty(),
                                    btn.text("Đăng")
                            }
                            )),
                            1 == type && Agents.post(APIs.markets.comment, param, (function (res) {
                                res && 200 == res.code && postComment(btn, res, content, type, timeNow, avatar, name, username, rankId, rankTitle, price, textTotal, textTotalKey, totalComment, totalCommentKey, idBtnPost, parent)
                            }
                            ), (function (err) {
                                btn.empty(),
                                    btn.text("Đăng"),
                                    openModalHaveError("Bình luận", "Vui lòng viết bình luận (không quá 1000 ký tự)")
                            }
                            ))
                    } else
                        btn.empty(),
                            btn.text("Đăng"),
                            2 == type ? openModalHaveError("Chưa viết bình luận", "Để đăng bình luận khóa bạn vui lòng viết đầy đủ bình luận!") : openModalHaveError("Bình luận", "Vui lòng viết bình luận (không quá 1000 ký tự)")
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("btn-delete-form-comment"))
                if (isLogged()) {
                    var btn, key = (btn = $(e.target)).attr("data-key");
                    $(`#form-comment-${key}`).remove()
                } else
                    openModalLogin(e);
            else if ($(e.target).hasClass("btn-read-more")) {
                var btn, id = (btn = $(e.target)).attr("data-id"), idSub = btn.attr("data-sub-id"), idContainer = 0;
                console.log("id: ", id, idSub),
                    idContainer = idSub || id;
                var btnMore = $(`#more-${idContainer}`);
                btnMore.hasClass("d-none") ? (btnMore.removeClass("d-none"),
                    btn.text("Thu gọn")) : (btnMore.addClass("d-none"),
                        btn.text("Xem thêm"))
            } else if ($(e.target).hasClass("delete-image-comment") || $(e.target).hasClass("icon-delete-image-comment")) {
                var btn = $(e.target);
                $(e.target).hasClass("icon-delete-image-comment") && (btn = $(e.target).parent());
                var key = btn.attr("data-key")
                    , id = btn.attr("data-id")
                    , type = btn.attr("data-type")
                    , imgName = btn.attr("data-name");
                "edit" == type ? "edit" == key ? contentsForEdit.forEach(c => {
                    var images, newImages = (c.images || []).filter(i => i.id != id);
                    c.images = newImages
                }
                ) : fileImgEdit && fileImgEdit.forEach((item, index) => {
                    item.id == key && (item.listFile = item.listFile.filter(i => i.name != imgName))
                }
                ) : fileImg && fileImg.forEach((item, index) => {
                    item.id == key && (item.listFile = item.listFile.filter(i => i.name != imgName))
                }
                ),
                    console.log("contentsForEdit: ", contentsForEdit),
                    btn.parent().remove()
            } else if ($(e.target).hasClass("image-comment-key")) {
                var btn, parent = (btn = $(e.target)).parent(), pathImg = btn.attr("src");
                $("#img-preview").empty(),
                    parent && parent[0] && parent[0].childNodes && parent[0].childNodes.forEach(item => {
                        var path = $(item).attr("src");
                        path == pathImg ? $("#img-preview").append(`<img src="${path}" alt="" class="img-preview-modal">`) : $("#img-preview").append(`<img src="${path}" alt="" class="img-preview-modal d-none">`)
                    }
                    )
            } else if ($(e.target).hasClass("mode-hide-comment-topic")) {
                var btn;
                const idComment = (btn = $(e.target)).attr("data-sub-id") || btn.attr("data-id")
                    , targetType = btn.attr("data-sub-id") ? "data-sub-id" : "data-id";
                $("#modConfirmHide").attr("data-id", idComment),
                    $("#modConfirmHide").attr("data-target-type", targetType)
            } else if ($(e.target).hasClass("btn-read-more-default-comment")) {
                var btn = $(e.target), content;
                (content = btn.prev()).hasClass("line-clamp-4") ? (content.removeClass("line-clamp-4"),
                    btn.text("Thu gọn")) : (content.addClass("line-clamp-4"),
                        btn.text("Xem thêm"))
            }
        }
        )),
        $(document.body).on("change", (function (e) {
            if ($(e.target).hasClass("change-option-comment")) {
                var select, value = $(e.target).val(), url = `${APIs.markets.comment}?topic=${topic}&limit=10&page=1&orderType=${value}`;
                Agents.get(url, (function (res) {
                    if (res && 200 == res.code) {
                        console.log("target: ", res);
                        const dataListComment = res.data.data;
                        var btnNextPage = $("#next-page-comment");
                        btnNextPage.removeClass("d-none"),
                            res.data && res.data.page_info && !res.data.page_info.has_next_page && btnNextPage.addClass("d-none"),
                            btnNextPage.attr("data-page", res.data.page),
                            btnNextPage.attr("data-has-next-page", res.data.page_info.has_next_page);
                        var container = $("#container-comment");
                        container.empty(),
                            getListComment(dataListComment, container)
                    }
                }
                ), (function (err) {
                    console.log("error: ", err)
                }
                ))
            } else if ($(e.target).hasClass("select-price-comment")) {
                var budgetValue = parseInt($(e.target).val())
                    , budgetTopic = parseInt($("#text-budget-topic").attr("data-budget").replaceAll(".", ""));
                budgetTopic && budgetValue && budgetValue > budgetTopic && openModalHaveError("Cảnh báo", "Giá bình luận lớn hơn Ngân sách lá số, vui lòng xem xét lại lựa chọn của bạn!")
            } else if ($(e.target).hasClass("file-image-upload-comment")) {
                var input = $(e.target)
                    , key = input.attr("data-key")
                    , type = input.attr("data-type")
                    , container = $(`.list-image-comment-${key}`)
                    , containerEdit = $(`.list-image-comment-${key}-edit`);
                "edit" == type ? uploadImgForComment(containerEdit, e.target, fileImgEdit, key, type) : uploadImgForComment(container, e.target, fileImg, key, type)
            }
        }
        )),
        $(document.body).on("keydown", (function (event) {
            if ($(event.target).hasClass("text-area-comment") || $(event.target).hasClass("txt-comment-key")) {
                var id = $(event.target).attr("data-id");
                console.log("id: ", id),
                    0 == $(event.target).val().length && (13 != event.keyCode && 32 != event.keyCode || event.preventDefault())
            } else
                27 == event.keyCode && (event.preventDefault(),
                    $("#close-modal-detail-topic").click())
        }
        )),
        initSaveTopicGlobal(),
        $("#editCommentModal").on("show.bs.modal", (function (event) {
            $("#warningEditComment").text("")
        }
        )),
        $("#btn-accept-edit-comment").click((function (e) {
            console.log("file img edit: ", fileImgEdit);
            const btn = $(this);
            btn.attr("data-target", ""),
                btn.attr("data-toggle", ""),
                btn.empty(),
                btn.append('<div class="d-flex justify-content-center align-items-center spinner-image-comment" id="spinner-image-comment">\n                        <div class="spinner-border" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                     </div>');
            var inputComment = $("#editCommentInput")
                , content = inputComment.val()
                , id = parseInt(inputComment.attr("data-id"))
                , type = parseInt(inputComment.attr("data-type"))
                , price = parseInt($("#priceCommentInput").val())
                , checkLenghtContent = !0
                , content_new = "";
            if (console.log("abc: ", content, id, type, price),
                2 == type) {
                console.log("zo type 2");
                var titleList = document.querySelectorAll(".title-comment-teacher-edit")
                    , contentList = document.querySelectorAll(".content-comment-teacher-edit")
                    , listTitle = []
                    , listContent = []
                    , is_view_more = !0
                    , formComment = [];
                titleList && titleList.forEach(item => {
                    const titleM = $(item).text();
                    listTitle.push(titleM)
                }
                ),
                    contentList && contentList.forEach(item => {
                        const contentM = $(item).val()
                            , key = $(item).attr("data-key");
                        contentM.length < 200 && (checkLenghtContent = !1),
                            listContent.push({
                                id: key,
                                content: contentM
                            })
                    }
                    ),
                    console.log("check: ", checkLenghtContent),
                    checkLenghtContent && listContent.forEach((item, index) => {
                        var find = fileImgEdit.find(i => i.id == item.id)
                            , images = find ? find.listFile : []
                            , itemComment = {
                                id: item.id || "",
                                content: item.content || "",
                                title: listTitle[index] || "",
                                images: images
                            };
                        formComment.push(itemComment)
                    }
                    ),
                    console.log("formComment: ", formComment),
                    console.log("contentsssss: ", contentsForEdit),
                    formComment && formComment.length > 0 && (content = formComment)
            } else {
                var indexFirst;
                if (content && content.split("\n").length - 1 > 5) {
                    if (indexFirst = getPosition(content, "\n", 4)) {
                        var firstContent = content.substring(0, indexFirst)
                            , secondContent = content.substring(indexFirst, content.length);
                        firstContent && secondContent && (is_view_more = !1,
                            content_new = `${firstContent} <span class="d-none" id="more-${id}"> ${secondContent} </span><span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${id}" id="dots-${id}">Xem thêm</span>`)
                    }
                } else if (content && content.length > 500) {
                    var indexFirst;
                    if (indexFirst = 500) {
                        var firstContent = content.substring(0, indexFirst)
                            , secondContent = content.substring(indexFirst, content.length);
                        firstContent && secondContent && (is_view_more = !1,
                            content_new = `${firstContent} <span class="d-none" id="more-${id}"> ${secondContent} </span><span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${id}" id="dots-${id}">Xem thêm</span>`)
                    }
                } else
                    content_new = content,
                        is_view_more = !0
            }
            if (1 == type && content.length > 1e3 && (content = ""),
                content && content.length > 0 && id && type) {
                var param = {
                    id: id
                };
                2 == type ? (param.price = price,
                    param.contents = content) : (param.content = content,
                        param.type = type);
                var contents = param.contents
                    , promises = [];
                contents && contents.forEach((function (i) {
                    promises.push(upload(i.id, i.images))
                }
                )),
                    promises && promises.length > 0 && Promise.all(promises).then((function (res) {
                        console.log("res", res);
                        let contents = param.contents;
                        contents.forEach((function (c, cdx) {
                            let find = res.find(i => i.id == c.id);
                            if (find) {
                                var ids = [];
                                find.images.forEach((function (t) {
                                    ids.push({
                                        id: t.id,
                                        path: t.path
                                    })
                                }
                                )),
                                    c.images = ids,
                                    delete c.id
                            }
                            var listImagesOld = contentsForEdit[cdx].images;
                            listImagesOld && listImagesOld.forEach(item => {
                                c.images.push(item)
                            }
                            )
                        }
                        ));
                        var newContents = [];
                        contents.forEach((function (c) {
                            var newC = Object.assign({}, c), newImges = [], images;
                            (c.images || []).forEach((function (m) {
                                var newImage = Object.assign({}, m);
                                delete newImage.path,
                                    newImges.push(newImage)
                            }
                            )),
                                newC.images = newImges,
                                newContents.push(newC)
                        }
                        )),
                            param.contents = newContents,
                            Agents.put(APIs.markets.commentMaster, param, (function (res) {
                                console.log("res: ", res),
                                    res && 200 == res.code && editComment(btn, id, type, price, content_new, is_view_more, content)
                            }
                            ), (function (err) {
                                btn.empty(),
                                    btn.text("Xác nhận"),
                                    openModalHaveError("Sửa bình luận không thành công", "Bình luận đã được trả phí không thể Sửa!")
                            }
                            ))
                    }
                    ), (function (err) {
                        btn.empty(),
                            btn.text("Xác nhận")
                    }
                    )),
                    1 == type && Agents.put(APIs.markets.comment, param, (function (res) {
                        console.log("res: ", res),
                            res && 200 == res.code && editComment(btn, id, type, price, content_new, is_view_more, content)
                    }
                    ), (function (err) {
                        btn.empty(),
                            btn.text("Xác nhận"),
                            openModalHaveError("Sửa bình luận không thành công", "Bình luận đã được trả phí không thể Sửa!")
                    }
                    ))
            } else
                2 == type ? (btn.attr("data-dismiss", ""),
                    btn.empty(),
                    btn.text("Xác nhận"),
                    $("#warningEditComment").text("Để sửa bình luận khóa bạn vui lòng viết đầy đủ!"),
                    blinkMe($("#warningEditComment"))) : (btn.attr("data-dismiss", ""),
                        btn.empty(),
                        btn.text("Xác nhận"),
                        $("#warningEditComment").text("Vui lòng viết bình luận (không quá 1000 ký tự)"),
                        blinkMe($("#warningEditComment")))
        }
        )),
        $("#btn-accept-report-comment").click((function () {
            var inputComment = $("#reportCommentInput")
                , id = parseInt(inputComment.attr("data-id"))
                , titleId = parseInt($("#commentReportTitle").val())
                , content = inputComment.val();
            if (id && titleId) {
                console.log("abc: ", id, titleId, content);
                var param = {
                    title_id: titleId,
                    content: content || "",
                    comment_id: id
                };
                Agents.post(APIs.markets.report, param, (function (res) {
                    console.log("res: ", res),
                        res && 200 == res.code && (inputComment.val(""),
                            $("#titleCheckMes").text("Phản hồi thành công"),
                            $("#contentCheckMes").text("Phản hồi của bạn đã được gửi đi thành công. Tuvi.vn cảm ơn bạn đã góp ý!"))
                }
                ), (function (err) {
                    console.log("err: ", err),
                        inputComment.val(""),
                        $("#titleCheckMes").text("Phản hồi không thành công"),
                        $("#contentCheckMes").text("Phản hồi của bạn chưa được gửi thành công!")
                }
                ))
            }
        }
        )),
        $("#btn-open-comment-key-topic").click((function (e) {
            var btn, id = $(this).attr("data-id"), name = $("#detail-topic").attr("data-name");
            if ($("#openCommentKeyModal").modal("hide"),
                id) {
                var url = `${APIs.markets.private}?id=${parseInt(id)}`;
                Agents.post(url, null, (function (res) {
                    if (console.log("res: ", res),
                        res && 200 == res.code) {
                        var { data: data } = res, { contents: contents, price: price, user: user, id: id } = data, title = user.rank ? user.rank.title || "Lỗi xếp hạng" : "Chưa xếp hạng", itemHistory;
                        const obj = {
                            item: {
                                thay: {
                                    username: user.username,
                                    name: user.name,
                                    rank_id: user.rank_id,
                                    rank: {
                                        title: title
                                    }
                                },
                                user: {
                                    name: name
                                },
                                create_at: sinceTime(new Date),
                                amount: formatPrice(price)
                            }
                        };
                        var tmpl = $("#template-history-topic").tmpl(obj), priceNullFormat, newPrice = parseInt($("#budget-topic-history").text().replaceAll(".", "")) - price;
                        newPrice >= 0 && $("#budget-topic-history").text(formatPrice(newPrice));
                        var listHistory = $("#list-history-topic");
                        if ("false" == listHistory.attr("data-history") && (listHistory.empty(),
                            listHistory.attr("data-history", !0)),
                            listHistory.prepend(tmpl),
                            $("#titleCheckMes").text("Thành công"),
                            $("#contentCheckMes").text("Bạn đã mở khóa luận giải thành công, tuvi.vn Cảm ơn bạn!"),
                            $("#checkComment").modal("show"),
                            contents && contents.length > 0) {
                            var subComment = $("div#content-comment-key-topic[data-sub-id='" + id + "']")
                                , comment = $("div#content-comment-key-topic[data-id='" + id + "']");
                            if (console.log("zo here 2", subComment, comment),
                                subComment.length > 0)
                                subComment.attr("class", ""),
                                    subComment.parent().attr("class", "cmt-bubble-open"),
                                    subComment.addClass("unlocked-cmt-content"),
                                    subComment.next().remove(),
                                    subComment.next().remove(),
                                    subComment.prev().removeClass("d-none"),
                                    subComment.prev().addClass("d-flex"),
                                    subComment.empty(),
                                    forContentCommentKey(subComment, contents, id);
                            else {
                                var commentChange = comment[0];
                                commentChange && ($(commentChange).empty(),
                                    $(commentChange).attr("class", ""),
                                    $(commentChange).parent().attr("class", "cmt-bubble-open"),
                                    $(commentChange).addClass("unlocked-cmt-content"),
                                    $(commentChange).next().remove(),
                                    $(commentChange).next().remove(),
                                    $(commentChange).prev().removeClass("d-none"),
                                    $(commentChange).prev().addClass("d-flex"),
                                    forContentCommentKey($(commentChange), contents, id))
                            }
                        }
                    }
                }
                ), (function (err) {
                    console.log("error", err);
                    var uri = window.location.href;
                    const previous = encodeURIComponent(uri);
                    var is_owner;
                    $("#checkComment").modal("show"),
                        "true" == $("#view-comment-topic").attr("data-owner") ? $("#contentCheckMes").html('<p>Mở khóa luận giải thất bại, vui lòng <span class="text-decoration-underline cursor-pointer color-blue" onclick="clickEditTopic()">thay đổi ngân sách lá số</span> để mở khóa luận giải!</p>') : $("#contentCheckMes").html(`<p>Mở khóa luận giải thất bại, vui lòng <a href="/payment?previous=${previous}">nạp thêm xu</a> để mở khóa luận giải!</p>`),
                        $("#titleCheckMes").text("Không thành công")
                }
                ))
            }
        }
        )),
        $("#btn-check-delete-comment-topic").click((function (e) {
            var btn = $(this);
            btn.attr("data-dismiss", "modal"),
                btn.attr("data-target", ""),
                btn.attr("data-toggle", "");
            var id = parseInt(btn.attr("data-id"))
                , subId = parseInt(btn.attr("data-sub-id"))
                , type = parseInt(btn.attr("data-type"))
                , textTotal = $("#total-comment")
                , textTotalKey = $("#total-comment-key")
                , totalComment = parseInt(textTotal.text())
                , totalCommentKey = parseInt(textTotalKey.text());
            if (console.log("zo id:", id, " sub: ", subId),
                subId) {
                var param = {
                    id: subId
                };
                Agents.delete(APIs.markets.comment, param, (function (res) {
                    if (console.log("res: ", res),
                        res && 200 == res.code) {
                        var subComment = $("div[data-sub-id='" + subId + "']");
                        console.log("sub cmt", subComment),
                            subComment.remove(),
                            2 == type ? (textTotal.text(totalComment - 1),
                                textTotalKey.text(totalCommentKey - 1)) : textTotal.text(totalComment - 1)
                    }
                }
                ), (function (err) {
                    const error = err.responseJSON || void 0;
                    error && "600001001" == error.code ? (btn.attr("data-dismiss", ""),
                        console.log("abc: ", error, e),
                        openModalHaveError("Xóa bình luận không thành công", "Bình luận đã được trả phí không thể xóa!")) : (btn.attr("data-dismiss", ""),
                            openModalHaveError("Xóa bình luận không thành công", "Có lỗi xảy ra"))
                }
                ))
            } else {
                var param = {
                    id: id
                };
                Agents.delete(APIs.markets.comment, param, (function (res) {
                    if (console.log("res: ", res),
                        res && 200 == res.code) {
                        var comment = $(`#comment-${id}`)
                            , subComment = $(`#sub-comment-${id}`);
                        if (subComment) {
                            var next = subComment.next(), nextPage;
                            "true" == next.attr("data-has-next-page") ? (comment.remove(),
                                subComment.remove(),
                                next.remove()) : (comment.remove(),
                                    subComment.remove())
                        } else
                            comment.remove();
                        2 == type ? (textTotal.text(totalComment - 1),
                            textTotalKey.text(totalCommentKey - 1)) : textTotal.text(totalComment - 1)
                    }
                }
                ), (function (err) {
                    const error = err.responseJSON || void 0;
                    error && "600001001" == error.code ? openModalHaveError("Xóa bình luận không thành công", "Bình luận đã được trả phí không thể xóa!") : openModalHaveError("Xóa bình luận không thành công", "Có lỗi xảy ra")
                }
                ))
            }
        }
        )),
        $("#view-full-screen-topic").click((function (e) {
            $("body").css("overflow", "hidden"),
                $("#modal-detail-topic").css("display", "block");
            const btn = $(this);
            btn.addClass("d-none");
            const containerLaSo = $("#table-la-so")
                , contentLaSo = $("#content-detail-la-so")
                , containerSettingLaSo = $("#setting-la-so");
            contentLaSo.html(containerLaSo);
            var height = $(window).height();
            containerLaSo.css("transform", `scale(${(height + 150) / $("#table-la-so")[0].getBoundingClientRect().height}) translate(0%)`),
                containerLaSo.css("transform-origin", "50% 0"),
                containerLaSo.css("left", "0"),
                contentLaSo.css("width", $("#table-la-so")[0].getBoundingClientRect().width),
                $("#modal-content-detail-topic").css("height", $("#table-la-so")[0].getBoundingClientRect().height);
            const containerComment = $("#widget-comment");
            containerSettingLaSo.addClass("resize-setting-la-so"),
                $("#comment-topic-modal").append(containerSettingLaSo),
                $("#comment-topic-modal").append(containerComment)
        }
        )),
        $("#close-modal-detail-topic").click((function () {
            $("#modal-detail-topic").css("display", "none");
            const containerComment = $("#widget-comment")
                , containerLaSo = $("#table-la-so")
                , containerSetting = $("#setting-la-so");
            containerLaSo.removeAttr("style"),
                containerSetting.removeClass("resize-setting-la-so"),
                $("#wide-left-content").append(containerComment),
                $("#content-la-so").append(containerLaSo),
                $("#right-content-topic").prepend(containerSetting),
                $("#view-full-screen-topic").removeClass("d-none"),
                $("body").css("overflow", "")
        }
        )),
        $("#btn-next-page-history").click((function () {
            var btn = $(this), page = parseInt(btn.attr("data-page")), hasNext;
            if ("true" == btn.attr("data-next-page")) {
                var url = `${APIs.markets.unLock}?topic=${topic}&limit=10&page=${page + 1}`;
                Agents.get(url, (function (res) {
                    if (res && 200 == res.code) {
                        const { data: data, page: page, page_info: page_info } = res.data;
                        btn.attr("data-page", page),
                            btn.attr("data-next-page", page_info.has_next_page),
                            page_info && 0 == page_info.has_next_page && btn.remove(),
                            data && data.forEach((item, index) => {
                                item.amount && (item.amount = formatPrice(item.amount)),
                                    item.create_at && (item.create_at = sinceTime(item.create_at));
                                const obj = {
                                    item: item
                                };
                                var tmpl = $("#template-history-topic").tmpl(obj);
                                $("#list-history-topic").append(tmpl)
                            }
                            )
                    }
                }
                ), (function (err) {
                    const error = err.responseJSON || void 0;
                    error && openModalHaveError("Lỗi hệ thống", "Có lỗi xảy ra")
                }
                ))
            }
        }
        )),
        $("#modConfirmHide").click((function () {
            var id, target;
            openModalHideMod($(this).attr("data-id"), $(this).attr("data-target-type"))
        }
        )),
        $(".button-preview-image-modal").click((function () {
            var btn = $(this), listImg = $("#img-preview"), type = btn.attr("data-type"), imgNow, firstItem, lastItem;
            (console.log("abcd:", listImg, type),
                listImg && listImg[0] && listImg[0].childNodes.length > 1) && (console.log("zo"),
                    listImg[0].childNodes.forEach((item, index) => {
                        $(item).hasClass("d-none") || (imgNow = item),
                            0 == index ? firstItem = item : index == listImg[0].childNodes.length - 1 && (lastItem = item)
                    }
                    ),
                    imgNow && ("next" == type ? (console.log("zo", $(imgNow).next()),
                        $(imgNow).addClass("d-none"),
                        $(imgNow).next().length > 0 ? $(imgNow).next().removeClass("d-none") : $(firstItem).removeClass("d-none")) : (console.log("zo", $(imgNow).prev()),
                            $(imgNow).addClass("d-none"),
                            $(imgNow).prev().length > 0 ? $(imgNow).prev().removeClass("d-none") : $(lastItem).removeClass("d-none"))))
        }
        ));
    const titleTopic = $("#inputTitleTopic");
    let titleDefault = titleTopic.val() || "";
    titleDefault = titleDefault.trim();
    const initTagsTopic = $("#list-tag-edit-topic").find("div");
    for (var defaultClassTags = [], allIdTag = [], i = 0; i < initTagsTopic.length; i++)
        defaultClassTags.push(initTagsTopic[i].className),
            i > 0 && (allIdTag.push(parseInt($(initTagsTopic[i]).attr("data-id-tag"))),
                $(initTagsTopic[i]).on("click", (function () {
                    console.log("zo"),
                        $(initTagsTopic[0]).removeClass("current"),
                        $(this).hasClass("current") ? $(this).removeClass("current") : $(this).addClass("current");
                    const activeTag = $("#list-tag-edit-topic").find(".current");
                    activeTag.length === initTagsTopic.length - 1 && (initTagsTopic.removeClass("current"),
                        $(initTagsTopic[0]).addClass("current")),
                        checkSuggestPriceCurrent(activeTag, $("#color-green"), priceSuggest)
                }
                )));
    $(initTagsTopic[0]).on("click", (function () {
        initTagsTopic.removeClass("current"),
            $(this).addClass("current")
    }
    ));
    const tieuVanTopic = $("select[name=yearTieuVan]")
        , tieuVanDefault = tieuVanTopic.val()
        , daiVanTopic = $("select[name=yearsDaiVan]")
        , daiVanDefault = daiVanTopic.val();
    $("#listMaster").attr("hidden", !0),
        $("#delInput").on("click", (function () {
            $("#nameMaster").val(""),
                $("#nameMaster").attr("placeholder", "Nhập tên thầy..."),
                $("#nameMaster").on("click", (function () {
                    $("#listMaster").attr("hidden", !1),
                        eventOnFocusInput()
                }
                ))
        }
        ));
    const hasImg = $("div.gallery").attr("data-has-img");
    $("#imgEditLaSo").on("change", (function () {
        listImg = [],
            imagesPreview(this, "div.gallery"),
            hasUpload = !0
    }
    )),
        $("#btn-edit-topic").click((function (event) {
            if (event.preventDefault(),
                isLogged()) {
                $("#modalEditTopic").modal("show"),
                    titleTopic.val(titleDefault);
                const count = titleTopic.val().length;
                $("#titleCountCharacter").text(count + "/500"),
                    titleTopic.on("keydown", (function (e) {
                        13 == e.keyCode && e.preventDefault()
                    }
                    )),
                    titleTopic.on("keyup", (function (e) {
                        const count = $(this).val().length;
                        $("#titleCountCharacter").text(count + "/500")
                    }
                    ));
                for (var i = 0; i < initTagsTopic.length; i++)
                    $(initTagsTopic[i]).attr("class", defaultClassTags[i]);
                tieuVanTopic.val(tieuVanDefault);
                const yob = tieuVanTopic.attr("data-yob");
                if (parseInt(tieuVanDefault) ? $("#tuoiTieuVan").text(parseInt(tieuVanDefault) - parseInt(yob)) : ($("#descriptionTieuVan").addClass("d-none"),
                    $(".topic-select-tieu-van").addClass("w-100")),
                    tieuVanTopic.on("change", (function () {
                        parseInt(tieuVanTopic.val()) ? ($("#tuoiTieuVan").text(parseInt(tieuVanTopic.val()) - parseInt(yob)),
                            $("#descriptionTieuVan").removeClass("d-none"),
                            $(".topic-select-tieu-van").removeClass("w-100")) : ($("#descriptionTieuVan").addClass("d-none"),
                                $(".topic-select-tieu-van").addClass("w-100"))
                    }
                    )),
                    $("#yearOfTieuVan2Res").select2({
                        dropdownParent: $("#modalEditTopic")
                    }),
                    "true" == hasImg) {
                    const imgOld = $(".gallery").attr("data-default");
                    if (imgOld) {
                        let img = `<div class="d-flex list-file-img-container list-image-comment-1 flex-wrap"><div class="view-image-comment"><img class="image-comment-upload" src="${imgOld}"><div id="btnDeleteImgCreateTopic" class="cursor-pointer delete-image-comment"><div class="total-icon icon-delete-image-topic"></div></div></div></div>`;
                        listImg = [],
                            $(".gallery").empty(),
                            $(".gallery").append(img),
                            $("#btnDeleteImgCreateTopic").click((function () {
                                $("div.gallery").empty(),
                                    listImg = [],
                                    hasUpload = !0,
                                    console.log("hasUpload: ", hasUpload)
                            }
                            ))
                    } else {
                        let img = '<div class="d-flex list-file-img-container list-image-comment-1 flex-wrap"><div class="view-image-comment"><img class="image-comment-upload" src="#" alt="loadImg_error"><div id="btnDeleteImgCreateTopic" class="cursor-pointer delete-image-comment"><div class="total-icon icon-delete-image-topic"></div></div></div></div>';
                        listImg = [],
                            $(".gallery").empty(),
                            $(".gallery").append(img),
                            $("#btnDeleteImgCreateTopic").click((function () {
                                $("div.gallery").empty(),
                                    listImg = [],
                                    hasUpload = !0,
                                    console.log("hasUpload: ", hasUpload)
                            }
                            ))
                    }
                }
                "false" == hasImg && (listImg = [],
                    $(".gallery").empty()),
                    daiVanTopic.val(daiVanDefault);
                const defaultMaster = $("#nameMaster").attr("data-default-master");
                defaultMaster ? ($("#nameMaster").val(defaultMaster),
                    $("#delInput").attr("hidden", !1),
                    $("#nameMaster").attr("disabled", !0)) : ($("#delInput").attr("hidden", !0),
                        $("#nameMaster").val(""),
                        $("#nameMaster").attr("placeholder", "Nhập tên thầy..."),
                        $("#nameMaster").attr("disabled", !1),
                        $("#nameMaster").on("click", (function () {
                            $("#listMaster").attr("hidden", !1),
                                eventOnFocusInput()
                        }
                        )));
                var listTagActive = $("#list-tag-edit-topic > .category.current");
                listTagActive && checkSuggestPriceCurrent(listTagActive, $("#color-green"), priceSuggest)
            } else
                openModalLogin(event)
        }
        )),
        $("#formEditTopic").on("submit", (function (event) {
            if ($(this).find("button").attr("disabled", !0),
                isLogged()) {
                event.preventDefault();
                const name = $("#name-la-so").text() || ""
                    , errEle = $(this).find("div[id=errorForm]")
                    , title = $(this).find("textarea[id=inputTitleTopic]").val()
                    , idTopic = parseInt($(this).find("input[name=idTopic]").val())
                    , budget = parseFloat($(this).find("select[name=budget]").val())
                    , tags = $("#list-tag-edit-topic").find("div.category.current")
                    , tieuVan = "0" !== $(this).find("select[name=yearTieuVan]").val() ? "Tiểu vận " + $(this).find("select[name=yearTieuVan]").val() + " (" + $(this).find("#descriptionTieuVan").text() + ")" : ""
                    , daiVan = "0" !== $(this).find("select[name=yearsDaiVan]").val() ? $(this).find("select[name=yearsDaiVan]").val() : ""
                    , idMaster = "" !== $("#nameMaster").attr("data-id-master-selected") ? parseInt($("#nameMaster").attr("data-id-master-selected")) : 0;
                var selectedTags = [];
                if (1 == tags.length && "0" == $(tags[0]).attr("data-id-tag"))
                    selectedTags = allIdTag;
                else
                    for (var i = 0; i < tags.length; i++)
                        selectedTags.push(parseInt($(tags[i]).attr("data-id-tag")));
                if (0 == selectedTags.length)
                    $(errEle).text("Chọn tối thiểu 1 chủ đề"),
                        blinkMe(errEle);
                else if (title.length < 3 || title.length > 500)
                    $(errEle).text("Tiêu đề là bắt buộc và có độ dài từ 3-500 ký tự"),
                        blinkMe(errEle);
                else {
                    const url = `${DOMAIN}/markets/topics`
                        , params = {
                            title: title,
                            budget: budget,
                            id: idTopic,
                            tags: selectedTags,
                            dai_van: daiVan,
                            tieu_van: tieuVan,
                            name: name
                        };
                    if (idMaster && (params.masters = [{
                        id: idMaster
                    }]),
                        hasUpload)
                        listImg && listImg.length ? Promise.all([uploadImgTopic(listImg)]).then((function (res) {
                            if (res && res.length) {
                                let images = res[0].images || []
                                    , mediaId = images.length ? images[0].id : 0;
                                mediaId && (params.media = parseInt(mediaId)),
                                    console.log("params: ", params),
                                    Agents.put(url, params, (function (response) {
                                        console.log(response),
                                            $("#formEditTopic").find("button").attr("disabled", !1),
                                            "200" == response.code && window.location.reload()
                                    }
                                    ), (function (error) {
                                        console.log("error ", error),
                                            $("#formEditTopic").find("button").attr("disabled", !1);
                                        const uri = window.location
                                            , previous = encodeURIComponent(uri)
                                            , err = error.responseJSON;
                                        "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                                            blinkMe(errEle)),
                                            "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                                                blinkMe(errEle))
                                    }
                                    ))
                            }
                        }
                        )) : Agents.put(url, params, (function (response) {
                            console.log(response),
                                $("#formEditTopic").find("button").attr("disabled", !1),
                                "200" == response.code && window.location.reload()
                        }
                        ), (function (error) {
                            console.log("error ", error),
                                $("#formEditTopic").find("button").attr("disabled", !1);
                            const uri = window.location
                                , previous = encodeURIComponent(uri)
                                , err = error.responseJSON;
                            "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                                blinkMe(errEle)),
                                "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                                    blinkMe(errEle))
                        }
                        ));
                    else if (hasImg) {
                        let mediaId = $(".gallery").attr("data-id-img");
                        params.media = parseInt(mediaId),
                            console.log("params: ", params),
                            Agents.put(url, params, (function (response) {
                                console.log(response),
                                    $("#formEditTopic").find("button").attr("disabled", !1),
                                    "200" == response.code && window.location.reload()
                            }
                            ), (function (error) {
                                console.log("error ", error),
                                    $("#formEditTopic").find("button").attr("disabled", !1);
                                const uri = window.location
                                    , previous = encodeURIComponent(uri)
                                    , err = error.responseJSON;
                                "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                                    blinkMe(errEle)),
                                    "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                                        blinkMe(errEle))
                            }
                            ))
                    } else
                        Agents.put(url, params, (function (response) {
                            console.log(response),
                                $("#formEditTopic").find("button").attr("disabled", !1),
                                "200" == response.code && window.location.reload()
                        }
                        ), (function (error) {
                            console.log("error ", error),
                                $("#formEditTopic").find("button").attr("disabled", !1);
                            const uri = window.location
                                , previous = encodeURIComponent(uri)
                                , err = error.responseJSON;
                            "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                                blinkMe(errEle)),
                                "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                                    blinkMe(errEle))
                        }
                        ))
                }
                $("#formEditTopic").find("button").attr("disabled", !1)
            } else
                event.preventDefault(),
                    openModalLogin(event)
        }
        )),
        $("#pushTop").click((function (event) {
            if (isLogged()) {
                const url = `${DOMAIN}/markets/topics/top`
                    , id = parseInt($("input[name=idTopic]").val());
                Agents.post(url, {
                    id: id
                }, (function (res) {
                    if (res && res.hasOwnProperty("code") && "200" == res.code) {
                        console.log("SUCCESS");
                        const content = '<p>Lá số của bạn đã lên <span class="txt-content-bold">TOP Chợ Lá Số</span></p>'
                            , title = "Đẩy TOP thành công";
                        $("p[data-name=titleMessage]").text(title),
                            $("div[data-name=contentMessage]").html(content)
                    }
                }
                ), (function (err) {
                    console.log(err);
                    const res = err.responseJSON;
                    if (res && "5000008" == res.msg) {
                        $("p[data-name=titleMessage]").text("Không thành công");
                        const uri = window.location
                            , previous = encodeURIComponent(uri);
                        $("div[data-name=contentMessage]").html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`);
                        const cfBtn = $("#modalMessage").find("button");
                        $(cfBtn).text("Nạp"),
                            $(cfBtn).click((function () {
                                window.location.href = "/payment?previous=" + previous
                            }
                            ))
                    }
                }
                )),
                    $(this).attr("data-target", "#modalMessage"),
                    $(this).attr("data-toggle", "modal")
            } else
                openModalLogin(event)
        }
        )),
        $("#openModalPushTop").click((function (event) {
            event.preventDefault(),
                console.log("click"),
                isLogged() ? $("#modalTopTopic").modal("show") : openModalLogin(event)
        }
        )),
        $("#btn-chi-them").click((function () {
            $("#btn-edit-topic").click()
        }
        )),
        $(document.body).bind("input propertychange", (function (e) {
            if ($(e.target).hasClass("txt-comment-key")) {
                console.log("zo");
                var btn = $(e.target)
                    , key = btn.attr("data-key")
                    , id = btn.attr("data-id-comment");
                console.log("id: ", id);
                var length = btn.val().trim().length;
                $(`#lenght-comment-${key}-${id}`).text(`${length}`)
            }
        }
        )),
        $("#content-comment").keydown((function (e) {
            13 == e.keyCode && alert("you pressed enter ^_^")
        }
        ))
}
function initPaymentCallback() {
    const prev = $("input#previousPayment")
        , url = prev.val() || "";
    if ("" !== url) {
        $("#linkRedirect").attr("href", url);
        var timeleft = 5
            , redirectTimer = setInterval((function () {
                timeleft <= 0 ? (clearInterval(redirectTimer),
                    document.getElementById("timerRedirect").innerHTML = "Kết thúc",
                    window.location.href = url) : document.getElementById("timerRedirect").innerHTML = "Bạn sẽ được quay trở lại trang gần nhất sau " + timeleft + " giây ...",
                    timeleft -= 1
            }
            ), 1e3)
    } else
        $("#countDownRedirect").empty()
}
function getComment(data, container, page, hasNextPage, id, createNextPage) {
    const d = document.createElement("div");
    $(d).attr("id", `sub-comment-${id}`);
    var ownerTopic = $("#view-comment-topic").attr("data-owner");
    if (data && data.forEach((i, idx) => {
        var indexFirst;
        if (i.is_sub = "sub-cmt-margin",
            i.isSub = !0,
            i.time = sinceTime(i.created),
            i.id_comment = i.id,
            i.id = id,
            0 == i.total_unlock && (i.total_unlock_str = "d-none"),
            2 == i.type)
            ;
        else if (i.content && i.content.split("\n").length - 1 > 5) {
            if (indexFirst = getPosition(i.content, "\n", 4)) {
                var firstContent = i.content.substring(0, indexFirst)
                    , secondContent = i.content.substring(indexFirst, i.content.length);
                firstContent && secondContent && (i.is_view_more = "",
                    i.show_line = "line-clamp-4",
                    i.content_new = `${firstContent} <span class="d-none" id="more-${i.id_comment}"> ${secondContent} </span> <span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${i.id_comment}" id="dots-${i.id_comment}">Xem thêm</span>`)
            }
        } else if (i.content && i.content.length > 500) {
            var indexFirst;
            if (indexFirst = 500) {
                var firstContent = i.content.substring(0, indexFirst)
                    , secondContent = i.content.substring(indexFirst, i.content.length);
                firstContent && secondContent && (i.is_view_more = "",
                    i.show_line = "line-clamp-4",
                    i.content_new = `${firstContent} <span class="d-none" id="more-${i.id_comment}"> ${secondContent} </span> <span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${i.id_comment}" id="dots-${i.id_comment}">Xem thêm</span>`)
            }
        } else
            i.content_new = i.content,
                i.is_view_more = "d-none";
        if (i.user.avatar || (i.user.avatar = "/public/images/ic_default_avt.jpg"),
            i.user.rank || (i.user.rank = {
                id: 1
            }),
            i.user.is_thay || (i.user.is_teacher = "d-none"),
            i.is_like && (i.liked = "cmt-like"),
            i.is_owner ? i.owner_report = "d-none" : i.owner_cmt = "d-none",
            checkMod() || (i.is_mod = "d-none"),
            "false" != ownerTopic || i.is_owner || (i.owner_delete = "d-none"),
            i.like_count && 0 !== i.like_count || (i.null_like = "d-none"),
            i.price ? (i.price_null_formart = i.price,
                i.price = `${formatPrice(i.price)}`) : (i.price_null_formart = 0,
                    i.price = "0"),
            1 == i.type) {
            const obj = {
                item: i
            };
            $.template("commentDefaultTemplate", commentDefaultTemplate);
            var tmpl = checkModComment(i.user.is_moderator) ? $.tmpl("commentDefaultTemplate", obj) : $("#comment-default-user").tmpl(obj);
            $(d).append(tmpl)
        } else if (i.is_owner) {
            const obj = {
                item: i
            };
            var tmpl = $("#comment-key-mine").tmpl(obj), contentComment;
            forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), i.contents, i.id_comment),
                $(d).append(tmpl)
        } else if (i.is_paid) {
            const obj = {
                item: i
            };
            var tmpl = $("#comment-key-unlock").tmpl(obj), contentComment;
            forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), i.contents, i.id_comment),
                $(d).append(tmpl)
        } else {
            const obj = {
                item: i
            };
            var tmpl = $("#comment-key-lock").tmpl(obj), contentComment;
            forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), i.contents, i.id_comment),
                $(d).append(tmpl)
        }
    }
    ),
        container.append(d),
        hasNextPage && !createNextPage) {
        var btnNext = '<button class="txt-content-mid color-blue margin-10 btn cmt-act-btn hover-dark sub-cmt-margin next-page-comment-sub"' + `                   id="next-page-comment-sub" data-page="${page}" data-has-next-page="${hasNextPage}" data-parent="${id}">▼ Xem thêm bình luận</button>`;
        container.append(btnNext)
    }
}
function getListComment(data, container, previous) {
    container.append('<div class="d-flex justify-content-center align-items-center spinner-image-comment" id="spinner-image-comment">\n                        <div class="spinner-border" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                     </div>');
    var spinner = container.find(".spinner-image-comment");
    data && previous && (data = data.reverse()),
        data && data.forEach((item, index) => {
            var ownerTopic = $("#view-comment-topic").attr("data-owner"), indexFirst;
            if (item.time = sinceTime(item.created),
                2 == item.type)
                ;
            else if (item.content && item.content.split("\n").length - 1 > 5) {
                if (indexFirst = getPosition(item.content, "\n", 4)) {
                    var firstContent = item.content.substring(0, indexFirst)
                        , secondContent = item.content.substring(indexFirst, item.content.length);
                    firstContent && secondContent && (item.is_view_more = "",
                        item.show_line = "line-clamp-4",
                        item.content_new = `${firstContent} <span class="d-none" id="more-${item.id}"> ${secondContent} </span> <span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${item.id}" id="dots-${item.id}">Xem thêm</span>`)
                }
            } else if (item.content && item.content.length > 500) {
                var indexFirst;
                if (indexFirst = 500) {
                    var firstContent = item.content.substring(0, indexFirst)
                        , secondContent = item.content.substring(indexFirst, item.content.length);
                    firstContent && secondContent && (item.is_view_more = "",
                        item.show_line = "line-clamp-4",
                        item.content_new = `${firstContent} <span class="d-none" id="more-${item.id}"> ${secondContent} </span> <span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${item.id}" id="dots-${item.id}">Xem thêm</span>`)
                }
            } else
                item.content_new = item.content,
                    item.is_view_more = "d-none";
            if (0 == item.total_unlock && (item.total_unlock_str = "d-none"),
                item.user.avatar || (item.user.avatar = "/public/images/ic_default_avt.jpg"),
                item.user.rank || (item.user.rank = {
                    id: 1
                }),
                item.user.is_thay || (item.user.is_teacher = "d-none"),
                item.is_like && (item.liked = "cmt-like"),
                item.price ? (item.price_null_formart = item.price,
                    item.price = `${formatPrice(item.price)}`) : (item.price_null_formart = 0,
                        item.price = "0"),
                item.is_owner ? item.owner_report = "d-none" : item.owner_cmt = "d-none",
                checkMod() || (item.is_mod = "d-none"),
                "false" != ownerTopic || item.is_owner || (item.owner_delete = "d-none"),
                item.like_count && 0 !== item.like_count || (item.null_like = "d-none"),
                item.subs && item.subs.data && (item.isSub = !0),
                1 == item.type) {
                const obj = {
                    item: item
                };
                $.template("commentDefaultTemplate", commentDefaultTemplate);
                var tmpl = checkModComment(item.user.is_moderator) ? $.tmpl("commentDefaultTemplate", obj) : $("#comment-default-user").tmpl(obj);
                previous ? container.prepend(tmpl) : container.append(tmpl),
                    item.subs && item.subs.data && getComment(item.subs.data, container, item.subs.page, item.subs.page_info.has_next_page, item.id)
            } else if (item.is_owner) {
                const obj = {
                    item: item
                };
                var tmpl = $("#comment-key-mine").tmpl(obj), contentComment;
                forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), item.contents, item.id),
                    previous ? container.prepend(tmpl) : container.append(tmpl),
                    item.subs && item.subs.data && getComment(item.subs.data, container, item.subs.page, item.subs.page_info.has_next_page, item.id)
            } else if (item.is_paid) {
                const obj = {
                    item: item
                };
                var tmpl = $("#comment-key-unlock").tmpl(obj), contentComment;
                forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), item.contents, item.id),
                    previous ? container.prepend(tmpl) : container.append(tmpl),
                    item.subs && item.subs.data && getComment(item.subs.data, container, item.subs.page, item.subs.page_info.has_next_page, item.id)
            } else {
                const obj = {
                    item: item
                };
                var tmpl = $("#comment-key-lock").tmpl(obj), contentComment;
                forContentCommentKey(contentComment = $(tmpl).find("#content-comment-topic"), item.contents, item.id),
                    previous ? container.prepend(tmpl) : container.append(tmpl),
                    item.subs && item.subs.data && getComment(item.subs.data, container, item.subs.page, item.subs.page_info.has_next_page, item.id)
            }
            spinner.remove()
        }
        ),
        spinner.remove()
}
function forContentCommentKey(content, data, id) {
    if (console.log("data: ", data),
        data && content) {
        var listContentViewMore, listViewMore = $(`<span class="d-none" id="more-${id}"></span>`);
        console.log("list view more: ", listViewMore),
            data.forEach((item, index) => {
                var contentComment = getCommentTemplate(item.title, item.content, item.images);
                index > 0 ? (listViewMore.append(contentComment),
                    console.log("hee: ", listViewMore)) : content.append(contentComment)
            }
            ),
            data.length > 1 && (content.append(listViewMore),
                content.append(`<span class="btn-read-more txt-content-mid text-decoration-underline cursor-pointer" data-id="${id}" id="dots-${id}">Xem thêm</span>`))
    }
}
function getCommentTemplate(title, content, img) {
    if (title && content) {
        var text = `<p class="txt-content-bold mb-0 m-t-10">${title}</p><span class="txt-content m-r-5">${content}</span>`;
        if (img && img.length > 0) {
            var imgs = "", container;
            img.forEach((item, index) => {
                imgs += `<img src="${item.path}" data-key="${item.id}" class="image-comment-key" alt="" data-toggle="modal" data-target="#modalPreviewImage" />`
            }
            ),
                text += `<div class="d-flex flex-wrap">${imgs}</div>`
        }
        return text
    }
}
function formatArrayComment(content) {
    var result = []
        , arrayContent = (content = content.replaceAll('<strong class="txt-content-bold">', "")).split("</p>");
    return console.log("arraycontent: ", arrayContent),
        arrayContent && arrayContent.forEach((item, index) => {
            var data = item.split('</strong><p class="txt-content m-b-10">');
            if (data && data[0] && data[1]) {
                var dataItem = {
                    title: data[0],
                    content: data[1],
                    index: `key-${index}`,
                    length: data[1].length
                };
                result.push(dataItem)
            }
        }
        ),
        console.log("result: ", result),
        result
}
function clickEditTopic() {
    $("#btn-edit-topic").click()
}
function uploadImgForComment(container, input, fileImg, key, type) {
    console.log("const: ", container, key);
    const curFiles = input.files
        , preview = container[0];
    container.append('<div class="d-flex justify-content-center align-items-center spinner-image-comment" style="width: 74px" id="spinner-image-comment">\n                        <div class="spinner-border spinner-border" role="status">\n                            <span class="sr-only">Loading...</span>\n                        </div>\n                     </div>');
    const spinner = $(".spinner-image-comment");
    if (0 === curFiles.length)
        spinner.remove();
    else {
        if (container[0].childNodes.length < 6)
            for (const file of curFiles) {
                const para = document.createElement("p");
                if (validFileType(file) && validFileSize(file) && isLogged()) {
                    spinner.remove(),
                        console.log("file: ", file);
                    const img = `<div class="view-image-comment" data-file="${file}" id="img-${file.name}"><img src="${URL.createObjectURL(file)}" class="image-comment-upload" alt=""><div class="cursor-pointer delete-image-comment" data-name="${file.name}" data-key="${key}" data-type="${type}"><div class="total-icon icon-delete-image-comment"></div></div></div>`;
                    if (fileImg && fileImg.length > 0) {
                        var itemUpdate = fileImg.find(item => item.id == key);
                        console.log("itemUpdate", itemUpdate),
                            itemUpdate ? itemUpdate.listFile.push(file) : fileImg.push({
                                id: key,
                                listFile: [file]
                            }),
                            container.append(img)
                    } else
                        fileImg.push({
                            id: key,
                            listFile: [file]
                        }),
                            container.append(img);
                    console.log("fileImg", fileImg)
                } else
                    spinner.remove(),
                        file.size > 2e6 ? alert("Dung lượng ảnh quá lớn") : alert(`File name ${file.name}: Not a valid file type. Update your selection.`)
            }
        spinner.remove(),
            $(input).val("")
    }
}
function uploadImgToSever(fileInput, callBack) {
    var form = new FormData;
    fileInput && fileInput.forEach(item => {
        form.append("files", item, item.name)
    }
    );
    var settings = {
        url: APIs.media.upload,
        method: "POST",
        timeout: 0,
        headers: {
            "X-TU-VI": getToken()
        },
        processData: !1,
        mimeType: "multipart/form-data",
        contentType: !1,
        data: form
    };
    $.ajax(settings).done((function (response) {
        var res = JSON.parse(response);
        callBack(res)
    }
    ))
}
function setCommentDraft(path) {
    let listUrl = JSON.parse(localStorage.getItem("historyComment"));
    var itemPush = listUrl && listUrl.find(item => item.path == path);
    console.log("itemPush: ", itemPush, listUrl),
        itemPush && itemPush.comments.forEach((item, index) => {
            $(`textarea.content-comment-teacher-container[data-key=${item.id}]`).val(item.content),
                $(`#lenght-comment-${item.id}-container`).text(item.content.length)
        }
        )
}
function deleteCommentDraft(path) {
    let listUrl = JSON.parse(localStorage.getItem("historyComment"));
    listUrl && listUrl.length > 0 && (listUrl = listUrl.filter(item => item.path != path),
        console.log("abcd: ", listUrl),
        localStorage.setItem("historyComment", JSON.stringify(listUrl)))
}
function saveDraftComment(path) {
    setInterval((function () {
        var titleList = document.querySelectorAll(".title-comment-teacher-container")
            , contentList = document.querySelectorAll(".content-comment-teacher-container")
            , listTitle = []
            , listContent = {
                path: path,
                comments: []
            };
        if (titleList && titleList.forEach((item, index) => {
            const titleM = $(item).text().trim();
            listTitle.push(titleM)
        }
        ),
            contentList && contentList.forEach(item => {
                if ($(item).val().trim().length > 0) {
                    const contentM = $(item).val()
                        , key = $(item).attr("data-key");
                    listContent.comments.push({
                        id: key,
                        content: contentM
                    })
                }
            }
            ),
            listContent.comments.length > 0) {
            let listUrl = JSON.parse(localStorage.getItem("historyComment"));
            if (console.log("listUrl", listUrl),
                listUrl && listUrl.length > 0) {
                var itemPush = listUrl.find(item => item.path == path);
                if (itemPush) {
                    var number = listUrl.indexOf(itemPush);
                    listUrl[number] = listContent
                } else
                    listUrl.push(listContent);
                console.log("listUrl1", listUrl),
                    localStorage.setItem("historyComment", JSON.stringify(listUrl))
            } else
                localStorage.setItem("historyComment", JSON.stringify([listContent])),
                    console.log("listUrl2", listUrl)
        }
    }
    ), 3e3)
}
function initTeacherPolicyScreen() {
    $("#btn-register-teacher").click((function () {
        goToByScroll("formRegisterPolicyTeacher")
    }
    )),
        $("#btn-register-policy").click((function () {
            const name = $("#name-policy-input").val() || "";
            let phone = $("#phone-policy-input").val()
                , paramFalse = !1;
            var param = {
                name: name,
                phone: phone
            };
            validateName(name) ? $("#name-policy-input").css("border", "solid 1px var(--border-color)") : ($("#name-policy-input").css("border", "2.5px solid yellow"),
                paramFalse = !0),
                validatePhone(phone) ? $("#phone-policy-input").css("border", "solid 1px var(--border-color)") : ($("#phone-policy-input").css("border", "2.5px solid yellow"),
                    paramFalse = !0),
                console.log("data: ", phone, " ", name),
                paramFalse ? openModalHaveError("Lưu ý!!", "Bạn cần điền đầy đủ, chính xác thông tin. Các thông tin sai hoặc thiếu đã được bôi vàng. Vui lòng kiểm tra lại") : Agents.post(APIs.others.masterContact, param, (function (res) {
                    console.log("res: ", res),
                        res ? 200 == res.code ? openModalHaveError("Thành công", "Đã gửi thông tin thành công!") : openModalHaveError("Không thành công", "Gửi thông tin không thành công! Vui lòng kiểm trả thông tin cá nhân của bạn!") : console.log("SEVER ERROR")
                }
                ), (function (err) {
                    const error = err.responseJSON || void 0;
                    error && error.data,
                        openModalHaveError("Không thành công", "Có lỗi xảy ra!")
                }
                ))
        }
        ))
}
function initPaymentRequestScreen() {
    $("#select-bank-request").select2();
    var tFee = $("#t-fee").attr("data-value")
        , dFee = $("#d-fee").attr("data-value");
    function showMsg(code) {
        code && ("200" == code ? ($("#msg").removeClass("d-none"),
            $("#msg").addClass("d-flex"),
            $("#msg #info").text("Yêu cầu rút xu của bạn đã được gửi đi thành công !"),
            $("#msg #content").text("Hệ thống sẽ giữ lại số xu cần rút và kiểm tra, nếu như không có vấn đề gì, quý tín chủ sẽ nhận được thanh toán sau 2-3 ngày làm việc. Liên hệ qua Email: contact@tuvi.vn để được hỗ trợ và hướng dẫn"),
            $('button[name="request"]').attr("disabled", !0),
            $("#msg #icon").attr("src", "/public/images/professor-verify.png")) : ($("#msg").removeClass("d-none"),
                $("#msg").addClass("d-flex"),
                $("#msg #info").text("Yêu cầu rút xu của bạn đã được gửi đi không thành công !"),
                $("#msg #content").text("Hệ thống sẽ giữ lại số xu cần rút và kiểm tra, nếu như không có vấn đề gì, quý tín chủ sẽ nhận được thanh toán sau 2-3 ngày làm việc. Liên hệ qua Email: contact@tuvi.vn để được hỗ trợ và hướng dẫn"),
                $('button[name="request"]').attr("disabled", !0),
                $("#msg #icon").attr("src", "/public/images/error.png")))
    }
    function getBalance() {
        var balance, current;
        return balanceToNumber($("#userBalance").text())
    }
    function formatNumber(num) {
        return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1,")
    }
    function balanceToNumber(balance) {
        return balance = balance.replaceAll(".", ""),
            parseInt(balance)
    }
    function checkString(container, min, max) {
        let v = $(container).val();
        return v && v.length >= min && v.length <= max ? ($(container).removeClass("is-invalid"),
            !0) : ($(container).addClass("is-invalid"),
                !1)
    }
    function checkNumber(container, min, max) {
        let v = $(container).val();
        return v = parseInt(v.replaceAll(",", "")),
            v && v >= min && v <= max ? ($(container).removeClass("is-invalid"),
                !0) : ($(container).addClass("is-invalid"),
                    !1)
    }
    $('select[name="method"]').on("change", (function () {
        var isChecked;
        0 == $(this).val() ? $(".new-method").removeClass("d-none") : $(".new-method").addClass("d-none")
    }
    )),
        Agents.get(APIs.payments.request, (function (res) {
            const data = res.data || [];
            var options = [];
            data.length > 0 && data.forEach((function (i) {
                var name = i.name + " - " + i.bank.name + " - " + i.account;
                options.push(`<option value="${i.id}">${name}</option>`)
            }
            )),
                $('select[name="method"]').append(options)
        }
        ), (function (err) { }
        )),
        Agents.get(APIs.payments.banking, (function (res) {
            const data = res.data;
            if (data) {
                var options = [];
                data.forEach((function (i) {
                    options.push(`<option value="${i.id}">${i.name}</option>`)
                }
                )),
                    $('select[name="bank"]').append(options)
            }
        }
        ), (function (err) { }
        )),
        $('button[name="request"]').on("click", (function () {
            var balance, checkAmount = checkNumber('input[name="amount"]', 5e5, getBalance());
            let method = $('select[name="method"]').val();
            if (method = parseInt(method),
                0 == method) {
                let v = $('input[name="amount"]').val().trim();
                v = v.replace(/[^0-9]/g, ""),
                    v = parseInt(v);
                const payload = {};
                var checkName = checkString('input[name="name"]', 3, 50)
                    , checkAccount = checkString('input[name="account"]', 3, 100);
                if (checkAmount && checkAccount && checkName) {
                    let name = $('input[name="name"]').val().trim()
                        , account = $('input[name="account"]').val().trim()
                        , bank = $('select[name="bank"]').val();
                    bank = parseInt(bank),
                        payload.amount = v,
                        payload.name = name,
                        payload.account = account,
                        payload.banking = bank,
                        Agents.post(APIs.payments.request, payload, (function (res) {
                            const code = res.code;
                            showMsg(code)
                        }
                        ), (function (err) {
                            console.log(err);
                            const code = err.responseJSON.code;
                            showMsg(code)
                        }
                        ))
                }
            } else {
                let v = $('input[name="amount"]').val().trim();
                v = v.replace(/[^0-9]/g, ""),
                    v = parseInt(v);
                const payload = {};
                checkAmount && (payload.method = method,
                    payload.amount = v),
                    Agents.post(APIs.payments.request, payload, (function (res) {
                        if (console.log("res", res),
                            res) {
                            const code = res.code;
                            showMsg(code)
                        }
                    }
                    ), (function (err) {
                        const code = err.responseJSON.code;
                        showMsg(code)
                    }
                    ))
            }
        }
        )),
        $('input[name="name"]').on("input", (function () {
            checkString('input[name="name"]', 3, 100)
        }
        )),
        $('input[name="account"]').on("input", (function () {
            checkString('input[name="account"]', 3, 100)
        }
        )),
        $('input[name="amount"]').on("input", (function () {
            let v = $(this).val();
            v = v.replace(/[^0-9]/g, "");
            var amount = parseInt(v) || 0
                , formated = formatNumber(amount);
            $(this).val(formated);
            var balance = getBalance(), checkAmount;
            console.log(balance),
                checkNumber('input[name="amount"]', 1e5, balance) && $('button[name="request"]').attr("disabled", !1),
                $("#r-amount").text(formated + " đ");
            var vat = amount * (tFee / 100)
                , dVatStr = amount * (dFee / 100);
            vat = parseInt(vat);
            var dVat = parseInt(dVatStr);
            $("#r-vat").text(formatNumber(vat) + " đ"),
                $("#r-discount-vat").text(formatNumber(dVat) + " đ");
            var news = amount - vat - dVat;
            $("#r-result").text(formatNumber(news) + " đ")
        }
        ))
}
function initDangLaSoScreen() {
    $("#btnUpLaso").addClass("d-none"),
        console.log("abc"),
        $("#tab-create-topic").click((function () {
            $(this).hasClass("step-bar-active") || $("#btn-create-la-so").click()
        }
        )),
        $("#btn-create-la-so").click((function () {
            var name = $("#nameForm").val()
                , day = $("#dayFormLaSo").val()
                , month = $("#monthFormLaSo").val()
                , year = $("#yearFormLaSo").val()
                , calendar = $("input[name='calendar']:checked").val()
                , hour = $("#hourFormLaSo").val()
                , gender = $("input[name='gender']:checked").val()
                , viewYear = $("#viewYearFormLaSo").val()
                , viewMonth = $("#viewMonthFormLaSo").val();
            day = day ? parseInt(day) : 1,
                month = month ? parseInt(month) : 1,
                year = year ? parseInt(year) : 1,
                hour = hour ? parseInt(hour) : 1,
                viewYear = viewYear ? parseInt(viewYear) : 1,
                viewMonth = viewMonth ? parseInt(viewMonth) : 1,
                calendar = "true" == calendar,
                gender = "true" == gender,
                console.log("abcd: ", name, day, month, year, calendar, hour, gender, viewYear, viewMonth);
            var param = {
                name: name,
                day: day,
                month: month,
                year: year,
                solar_calendar: calendar,
                hour_id: hour,
                male: gender,
                nam_xem: viewYear,
                thang_xem: viewMonth
            };
            console.log("param: ", param),
                Agents.post(APIs.laSo.get, param, (function (res) {
                    if (200 == res.code) {
                        var { slug: slug } = res.data
                            , arr = slug.split("-")
                            , id = arr[arr.length - 1];
                        console.log("id: ", id);
                        var tabTopic = $("#tab-create-topic")
                            , tabLaSo = $("#tab-create-la-so");
                        tabLaSo.removeClass("step-bar-active"),
                            tabLaSo.find("step-bar-arrow").remove(),
                            tabTopic.addClass("step-bar-active"),
                            tabTopic.attr("data-la-so", id),
                            tabTopic.attr("data-name", name),
                            $("#createPostPushLaSo").removeClass("d-none"),
                            $("#formCreateLaSo").addClass("d-none");
                        var url = APIs.laSo.get + "/" + slug;
                        console.log("url: ", url),
                            Agents.get(url, (function (res) {
                                if (200 == res.code) {
                                    console.log("res res: ", res);
                                    var { lunar_year: lunar_year, cung_model: cung_model } = res.data
                                        , tieuVansTopic = []
                                        , yearOfTieuVan = $("#yearOfTieuVan2Res")
                                        , yearOfDaiVan = $("#yearDaiVan");
                                    yearOfTieuVan.attr("data-yob", lunar_year);
                                    for (var i = lunar_year + 1; i < lunar_year + 101; i++)
                                        tieuVansTopic.push(i);
                                    var currentYear = (new Date).getFullYear()
                                        , number = cung_model[0].dai_van
                                        , dv = number %= 10
                                        , checkYear = 0;
                                    yearOfTieuVan.empty(),
                                        yearOfTieuVan.append('<option value="0">Không có nhu cầu xem</option>'),
                                        tieuVansTopic.forEach(item => {
                                            item == currentYear && (checkYear = item),
                                                yearOfTieuVan.append(`<option value="${item}" ${item == currentYear ? "selected" : ""}>${item}</option>`)
                                        }
                                        ),
                                        yearOfDaiVan.empty(),
                                        yearOfDaiVan.append('<option value="0">Không có nhu cầu xem</option>');
                                    for (var i = 0; i < 11; i++) {
                                        var text = `Đại vận ${dv + 10 * i} - ${dv + 10 * i + 9}`;
                                        yearOfDaiVan.append(`<option value="${text}">${text}</option>`)
                                    }
                                    checkYear > 0 ? ($("#tuoiTieuVan").text(checkYear - lunar_year + 1),
                                        $(".topic-select-tieu-van").removeClass("w-100"),
                                        $("#descriptionTieuVan").removeClass("d-none")) : ($("#descriptionTieuVan").addClass("d-none"),
                                            $(".topic-select-tieu-van").addClass("w-100"))
                                }
                            }
                            ), (function (err) {
                                console.log("err: ", err)
                            }
                            ))
                    }
                }
                ), (function (err) {
                    console.log("err: ", err)
                }
                ))
        }
        ));
    let listImage = [];
    var priceSuggest = parseInt($("#body-create-post").attr("data-suggest-price"))
        , defaultIdTag = [];
    const tags = $("#list-tag-topic").find("div");
    $(tags[0]).on("click", (function () {
        tags.removeClass("current"),
            $(this).addClass("current")
    }
    ));
    for (var i = 1; i < tags.length; i++)
        defaultIdTag.push(parseInt($(tags[i]).attr("data-id-tag"))),
            $(tags[i]).on("click", (function () {
                $(tags[0]).removeClass("current"),
                    $(this).hasClass("current") ? $(this).removeClass("current") : $(this).addClass("current");
                const activeTag = $("#list-tag-topic").find(".current");
                activeTag.length == tags.length - 1 && (tags.removeClass("current"),
                    $(tags[0]).addClass("current")),
                    checkSuggestPriceCurrent(activeTag, $("#color-green-create-post"), priceSuggest)
            }
            ));
    $("#createPostPushLaSo").on("submit", (function (event) {
        if ($(this).find("button").attr("disabled", !0),
            isLogged()) {
            event.preventDefault();
            const name = $("#tab-create-topic").attr("data-name") || ""
                , errEle = $(this).find("div[id=errorForm]");
            var title = $(this).find("textarea[id=inputTitleTopic]").val() || "";
            title = title.trim();
            const idLaso = parseInt($("#tab-create-topic").attr("data-la-so"))
                , budget = parseFloat($(this).find("select[name=budget]").val())
                , tags = $("#list-tag-topic").find("div.category.current")
                , tieuVan = "0" !== $(this).find("select[name=yearTieuVan]").val() ? "Tiểu vận " + $(this).find("select[name=yearTieuVan]").val() + " (" + $(this).find("#descriptionTieuVan").text() + ")" : ""
                , daiVan = "0" !== $(this).find("select[name=yearsDaiVan]").val() ? $(this).find("select[name=yearsDaiVan]").val() : ""
                , idMaster = "" !== $("#nameMaster").attr("data-id-master-selected") ? parseInt($("#nameMaster").attr("data-id-master-selected")) : 0
                , privacy = $("#check-privacy-topic").is(":checked");
            var selectedTags = [];
            if (1 == tags.length && "0" == $(tags[0]).attr("data-id-tag"))
                selectedTags = defaultIdTag;
            else
                for (var i = 0; i < tags.length; i++)
                    selectedTags.push(parseInt($(tags[i]).attr("data-id-tag")));
            if (0 == selectedTags.length)
                $(errEle).text("Chọn tối thiểu 1 chủ đề"),
                    blinkMe(errEle),
                    $("#createPostPushLaSo").find("button").attr("disabled", !1);
            else if (title.length < 3 || title.length > 500)
                $(this).find("textarea[id=inputTitleTopic]").val(title),
                    $("#titleCountCharacter").text(title.length + "/500"),
                    $(errEle).text("Tiêu đề là bắt buộc và có độ dài từ 3-500 ký tự"),
                    blinkMe(errEle),
                    $("#createPostPushLaSo").find("button").attr("disabled", !1);
            else {
                const url = `${DOMAIN}/markets/topics`
                    , params = {
                        title: title,
                        budget: budget,
                        la_so_id: idLaso,
                        tags: selectedTags,
                        dai_van: daiVan,
                        tieu_van: tieuVan,
                        name: name,
                        privacy: privacy ? 2 : 1
                    };
                idMaster && (params.masters = [{
                    id: idMaster
                }]),
                    listImg && listImg.length ? Promise.all([uploadImgTopic(listImg)]).then((function (res) {
                        if (console.log("data", res),
                            res && res.length) {
                            let images = res[0].images || []
                                , mediaId = images.length ? images[0].id : 0;
                            mediaId && (params.media = mediaId),
                                Agents.post(url, params, (function (response) {
                                    if ("200" == response.code) {
                                        const topicId = response.data.slug;
                                        window.location.href = "/" + topicId
                                    }
                                }
                                ), error => callbackPushLaSoWhenError(error))
                        }
                    }
                    ), (function (err) {
                        console.log("ERR UPLOAD IMAGE", err),
                            $(errEle).html("<span>Lỗi quá trình tải ảnh, hãy chọn ảnh khác và thử lại</span>"),
                            blinkMe(errEle),
                            $("#createPostPushLaSo").find("button").attr("disabled", !1)
                    }
                    )) : Agents.post(url, params, (function (response) {
                        if ("200" == response.code) {
                            const topicId = response.data.slug;
                            window.location.href = "/" + topicId
                        }
                    }
                    ), error => callbackPushLaSoWhenError(error))
            }
            function callbackPushLaSoWhenError(error) {
                $("#createPostPushLaSo").find("button").attr("disabled", !1);
                const err = error.responseJSON
                    , uri = window.location
                    , previous = encodeURIComponent(uri);
                "5000008" == err.msg && ($(errEle).html(`<span>Không đủ xu trong ví. Vui lòng nạp thêm để thực hiện!</span> <a href='/payment?previous=${previous}'>Nạp ngay</a>`),
                    blinkMe(errEle)),
                    "600001005" == err.code && ($(errEle).html(`<span>Số lượt đăng lá số lên chợ có giới hạn. <a href='/payment?previous=${previous}'>Nâng cấp</a> lên  <span class="txt-sub-content-mid">Tài khoản VIP</span> để nhận thêm lượt</span>`),
                        blinkMe(errEle)),
                    "5000009" == err.msg && ($(errEle).text("Lỗi thanh toán! Vui lòng thử lại sau"),
                        blinkMe(errEle))
            }
        } else
            event.preventDefault(),
                openModalLogin(event),
                $(this).find("button").attr("disabled", !0)
    }
    )),
        $("#imgPushLaSo").on("change", (function () {
            listImg = [],
                listImage = imagesPreview(this, "div.gallery")
        }
        ));
    const tieuVanTopic = $("select[name=yearTieuVan]")
        , yob = tieuVanTopic.attr("data-yob");
    if (parseInt(tieuVanTopic.val())) {
        var tuoiTieuVan = parseInt(tieuVanTopic.val()) - parseInt(yob) + 1;
        $("#tuoiTieuVan").text(tuoiTieuVan),
            $(".topic-select-tieu-van").removeClass("w-100")
    } else
        $("#descriptionTieuVan").addClass("d-none"),
            $(".topic-select-tieu-van").addClass("w-100");
    tieuVanTopic.on("change", (function () {
        const yob = tieuVanTopic.attr("data-yob");
        if (parseInt(tieuVanTopic.val())) {
            var tuoiTieuVan = parseInt(tieuVanTopic.val()) - parseInt(yob) + 1;
            $("#tuoiTieuVan").text(tuoiTieuVan),
                $("#descriptionTieuVan").removeClass("d-none"),
                $(".topic-select-tieu-van").removeClass("w-100")
        } else
            $("#descriptionTieuVan").addClass("d-none"),
                $(".topic-select-tieu-van").addClass("w-100")
    }
    ));
    const inputTitleTopic = $("#inputTitleTopic");
    inputTitleTopic.on("keydown", (function (e) {
        13 == e.keyCode && e.preventDefault()
    }
    )),
        inputTitleTopic.on("keyup", (function (e) {
            const count = $(this).val().length;
            $("#titleCountCharacter").text(count + "/500")
        }
        )),
        $("#namePro").select2({
            dropdownParent: $("#modalPushLaSo")
        }),
        searchMaster(),
        $("#tab-create-la-so").click((function () {
            $("#btn-back-dang-la-so").click()
        }
        )),
        $("#btn-back-dang-la-so").click((function () {
            var tabTopic = $("#tab-create-topic"), tabLaSo;
            $("#tab-create-la-so").addClass("step-bar-active"),
                tabTopic.find("step-bar-arrow").remove(),
                tabTopic.removeClass("step-bar-active"),
                $("#createPostPushLaSo").addClass("d-none"),
                $("#formCreateLaSo").removeClass("d-none")
        }
        ))
}
function checkSuggestPriceCurrent(list, text, price) {
    console.log("list: ", list, text, price);
    var isAllTag = !1;
    for (let i = 0; i < list.length; i++) {
        var item = list[i];
        0 == $(item).attr("data-id-tag") && (console.log("zo?"),
            isAllTag = !0,
            text.text(`Giá gợi ý: tối thiểu ${formatPrice(12 * price)} Xu`))
    }
    isAllTag || (console.log("zo"),
        text.text(`Giá gợi ý: tối thiểu ${formatPrice(price * list.length)} Xu`))
}
function suggestLandingPage() {
    var remindTimes = 0
        , maxRemindTimes = 1
        , remind = !1;
    return setTimeout((function () {
        $("#vipServiceModal").modal("show")
    }
    ), 5e3),
        !1
}
function initXinXam() {
    const $initialContent = $(".initial-content")
        , $resultContent = $("#fortuneResult");
    function showError() {
        $resultContent.removeClass("alert-success").addClass("alert-danger").html("Có lỗi xảy ra khi gieo quẻ. Vui lòng thử lại sau.").fadeIn(500),
            $("#fortuneButton").prop("disabled", !1).html('<i class="fas fa-pray me-2"></i>GIEO QUẺ NGAY')
    }
    $("#fortuneButton").on("click", (function () {
        const $button = $(this);
        $button.prop("disabled", !0),
            $button.html('<i class="fas fa-spinner fa-spin me-2"></i>Đang gieo quẻ...');
        const pathArray = window.location.pathname.split("/");
        var slug = pathArray[pathArray.length - 1];
        slug = slug.replace("gieo-que-xam-", ""),
            setTimeout(() => {
                $.ajax({
                    url: `${APIs.xinXam.post}${slug}`,
                    method: "POST",
                    success: function (response) {
                        if ("200" === response.code) {
                            const queXam = response.data;
                            let resultHTML = `\n                            <div class="gieo-que-result">\n                                <h4 class="txt-title-bold mb-3">${queXam.name}</h4>\n                                <div class="txt-content-italic fw-bold mb-3"><p>${queXam.content}</p></div>\n                                <div class="mb-4"><p>${queXam.interpretation}</p></div>\n                                <div class="d-flex justify-content-center">\n                                    <button id="drawNewFortune" class="btn btn-primary-custom pl-5 pr-5">GIEO QUẺ KHÁC</button>\n                                </div>\n                            </div>\n                        `;
                            $resultContent.html(resultHTML).fadeIn(500),
                                $initialContent.fadeOut(500),
                                $("#drawNewFortune").on("click", (function () {
                                    $resultContent.fadeOut(500, (function () {
                                        $initialContent.fadeIn(500),
                                            $button.prop("disabled", !1),
                                            $button.html('<i class="fas fa-pray me-2"></i>GIEO QUẺ NGAY'),
                                            $("html, body").animate({
                                                scrollTop: $initialContent.offset().top - 100
                                            }, 500)
                                    }
                                    ))
                                }
                                ))
                        } else
                            showError()
                    },
                    error: function () {
                        showError()
                    }
                })
            }
                , 3e3)
    }
    ))
}
$(".collapse").on("show.bs.collapse", (function () {
    console.log("zo", $(this).siblings(".icon-up")),
        $(this).prev().find(".icon-up").addClass("turn-up")
}
)),
    $(".collapse").on("hide.bs.collapse", (function () {
        $(this).prev().find(".icon-up").removeClass("turn-up")
    }
    )),
    document.addEventListener("DOMContentLoaded", () => {
        var tableLaSo = $("#table-la-so");
        if (0 != tableLaSo.length) {
            var mobile = $(window).width() < 769;
            null == mobile && (mobile = !1),
                mobile && ($("#la-so-img").attr("src", "/public/images/laso-loading.png"),
                    tableLaSo.css("pointer-events", "none"),
                    setTimeout(() => {
                        const newTableDownload = tableLaSo.clone().appendTo("#file-hinh-clone");
                        newTableDownload.css("top", ""),
                            newTableDownload.css("-webkit-transform", "scale(2)"),
                            newTableDownload.css("-webkit-transform-origin", "0%");
                        const height = newTableDownload[0].getBoundingClientRect().height
                            , width = newTableDownload[0].getBoundingClientRect().width;
                        html2canvas(newTableDownload[0], {
                            scale: 2,
                            windowWidth: width,
                            windowHeight: height
                        }).then(canvas => {
                            var image = canvas.toDataURL("image/png");
                            $("#la-so-img").attr("src", image),
                                tableLaSo.css("pointer-events", "all"),
                                $("#file-hinh-clone").html("")
                        }
                        )
                    }
                        , 3e3))
        }
    }
    );
